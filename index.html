
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>打磚塊 Breakout（進階電腦版 v4 · 美術強化）</title>
  <style>
    html, body {
      margin: 0;
      padding: 0;
      overflow: hidden;
      background: black;
    }
    canvas {
      display: block;
      margin: 0 auto;
      background: #000;
    }
    #overlay {
      position: absolute;
      top: 0; left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.8);
      color: white;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      font-size: 24px;
      z-index: 10;
      display: none;
    }
  </style>
</head>
<body>
  <canvas id="gameCanvas" width="960" height="640"></canvas>
  <div id="overlay">
    <div id="message">關卡完成！</div>
    <button onclick="nextLevel()">前往下一關</button>
  </div>

  <script>
    // 基本變數與初始化
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');
    const WIDTH = canvas.width;
    const HEIGHT = canvas.height;
    const BLOCK_ROWS = 5;
    const BLOCK_COLS = 8;
    const BLOCK_WIDTH = WIDTH / BLOCK_COLS;
    const BLOCK_HEIGHT = 30;
    const BALL_RADIUS = 8;
    let score = 0, lives = 3, level = 1;
    let blocks = [];
    let bgImage = new Image();
    let images = [];
    for (let i = 1; i <= 10; i++) {
      let img = new Image();
      img.src = `images/bg${i}.png`;
      images.push(img);
    }

    // 球、板與碰撞邏輯
    let ball = { x: WIDTH/2, y: HEIGHT-50, dx: 4, dy: -4 };
    let paddle = { x: WIDTH/2 - 50, y: HEIGHT-20, width: 100, height: 10 };

    function createBlocks() {
      blocks = [];
      for (let r = 0; r < BLOCK_ROWS; r++) {
        for (let c = 0; c < BLOCK_COLS; c++) {
          blocks.push({ x: c * BLOCK_WIDTH, y: r * BLOCK_HEIGHT, broken: false });
        }
      }
    }

    function drawBlocks() {
      for (let i = 0; i < blocks.length; i++) {
        if (!blocks[i].broken) {
          ctx.fillStyle = 'rgba(255,255,255,0.4)';
          ctx.fillRect(blocks[i].x, blocks[i].y, BLOCK_WIDTH, BLOCK_HEIGHT);
        }
      }
    }

    function drawBackgroundReveal() {
      const img = images[level - 1];
      ctx.drawImage(img, 0, 0, WIDTH, HEIGHT);
      for (let i = 0; i < blocks.length; i++) {
        if (!blocks[i].broken) {
          ctx.fillStyle = "black";
          ctx.fillRect(blocks[i].x, blocks[i].y, BLOCK_WIDTH, BLOCK_HEIGHT);
        }
      }
    }

    function drawPaddle() {
      ctx.fillStyle = 'white';
      ctx.fillRect(paddle.x, paddle.y, paddle.width, paddle.height);
    }

    function drawBall() {
      ctx.beginPath();
      ctx.arc(ball.x, ball.y, BALL_RADIUS, 0, Math.PI * 2);
      ctx.fillStyle = 'white';
      ctx.fill();
      ctx.closePath();
    }

    function drawScoreLives() {
      ctx.fillStyle = 'white';
      ctx.font = '18px sans-serif';
      ctx.fillText("分數: " + score, 10, 20);
      ctx.fillText("生命: " + lives, WIDTH - 80, 20);
    }

    function update() {
      ctx.clearRect(0, 0, WIDTH, HEIGHT);
      drawBackgroundReveal();
      drawBlocks();
      drawPaddle();
      drawBall();
      drawScoreLives();

      // 球移動與碰撞
      ball.x += ball.dx;
      ball.y += ball.dy;

      // 邊界反彈
      if (ball.x < BALL_RADIUS || ball.x > WIDTH - BALL_RADIUS) ball.dx *= -1;
      if (ball.y < BALL_RADIUS) ball.dy *= -1;
      if (ball.y > HEIGHT) {
        lives--;
        if (lives <= 0) {
          alert("遊戲結束");
          document.location.reload();
        } else {
          ball.x = WIDTH/2; ball.y = HEIGHT-50;
          ball.dx = 4; ball.dy = -4;
        }
      }

      // 碰到板
      if (ball.y + BALL_RADIUS > paddle.y &&
          ball.x > paddle.x &&
          ball.x < paddle.x + paddle.width) {
        ball.dy *= -1;
      }

      // 碰磚塊
      for (let i = 0; i < blocks.length; i++) {
        let b = blocks[i];
        if (!b.broken &&
            ball.x > b.x &&
            ball.x < b.x + BLOCK_WIDTH &&
            ball.y > b.y &&
            ball.y < b.y + BLOCK_HEIGHT) {
          b.broken = true;
          score += 10;
          ball.dy *= -1;
        }
      }

      // 過關檢查
      if (blocks.every(b => b.broken)) {
        document.getElementById('overlay').style.display = 'flex';
        cancelAnimationFrame(animId);
        return;
      }

      animId = requestAnimationFrame(update);
    }

    let animId;
    function startGame() {
      createBlocks();
      animId = requestAnimationFrame(update);
    }

    function nextLevel() {
      level++;
      if (level > images.length) level = 1;
      document.getElementById('overlay').style.display = 'none';
      ball.x = WIDTH/2; ball.y = HEIGHT-50;
      ball.dx = 4; ball.dy = -4;
      startGame();
    }

    // 控制板移動
    document.addEventListener('mousemove', e => {
      let rect = canvas.getBoundingClientRect();
      paddle.x = e.clientX - rect.left - paddle.width/2;
    });

    document.addEventListener('click', () => {
      if (!animId) startGame();
    });
  </script>
</body>
</html>
