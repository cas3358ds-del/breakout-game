<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Rockæ‰“ç£šå¡Š Breakoutï¼ˆæœ€çµ‚å¢å¼·ç‰ˆï¼‰</title>
  <style>
    :root {
      --bg:#0b1022; --bg2:#0a0f1e; --fg:#e9ecf1; --accent:#66b2ff;
      --brick1:#ff6b6b; --brick2:#ffd166; --brick3:#06d6a0; --brick4:#4cc9f0;
      --expl:#ff8c00; --power:#7aa2ff; --debuff:#ff6aa3;
      --glass: rgba(255,255,255,.06); --glass-stroke: rgba(255,255,255,.12);
      --btn:#1a2448; --btn-stroke:#2a3974; --pill:#121a36;
      --led:#8fb3ff;
    }
    html,body{height:100%; margin:0; background:radial-gradient(1200px 800px at 50% -10%, #152040, #0a0f1e 60%); color:var(--fg);
      font-family: system-ui, -apple-system, Segoe UI, Roboto, "Noto Sans TC", "PingFang TC", "Microsoft JhengHei", sans-serif;}
    body{min-height:100svh; display:flex; align-items:flex-start; justify-content:center;}
    .wrap{display:flex; gap:12px; align-items:center; justify-content:center; flex-direction:column; padding:12px; width:100%; max-width:1200px}
    h1{margin:4px 0 2px 0; font-weight:800; letter-spacing:.3px; text-shadow:0 2px 20px #0008;
       font-size:clamp(16px,3.2vw,28px)}
    .hud{
      position:sticky; top:0; z-index:5;
      display:flex; gap:8px; align-items:center; justify-content:center; flex-wrap:wrap; font-weight:650;
      background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02));
      border:1px solid var(--glass-stroke); border-radius:14px; padding:8px 10px;
      box-shadow: 0 6px 24px rgba(0,0,0,.25); backdrop-filter: blur(6px);
    }
    .pill{padding:6px 10px; background:var(--pill); border:1px solid var(--glass-stroke); border-radius:999px; font-size:14px}
    .btn{background:linear-gradient(180deg, var(--btn), #111a34); color:var(--fg);
      border:1px solid var(--btn-stroke); border-radius:10px; padding:6px 10px; cursor:pointer; user-select:none; font-size:14px}
    .btn:active{transform:translateY(1px)}
    select,input[type="range"]{background:linear-gradient(180deg, var(--btn), #111a34); color:var(--fg); border:1px solid var(--btn-stroke); border-radius:8px; padding:6px 10px}
    .range{display:flex; align-items:center; gap:6px; padding:4px 8px; border:1px solid var(--glass-stroke); border-radius:999px; background:var(--pill); font-size:12px}
    canvas{background:linear-gradient(180deg, #0d1126, #0b1022 55%, #091022);
      border:1px solid #1a2348; border-radius:16px; max-width:min(1120px, 98vw); width: min(1120px, 98vw); height: auto; display:block;
      box-shadow: 0 30px 80px rgba(0,0,0,.35), inset 0 0 120px rgba(255,255,255,.02); touch-action:none;}
    .overlay{position:relative}
    /* ğŸ”§ ä¿®æ­£ï¼šè®“æç¤ºå±¤æœ¬èº«å¯è¢«é»æ“Šï¼Œä¸»å‹•å•Ÿå‹•éŠæˆ²ï¼ˆè§£æ±º iOS é»æ“Šç„¡æ•ˆï¼‰ */
    .center-note{position:absolute; inset:0; display:flex; align-items:center; justify-content:center; pointer-events:auto; z-index:3}
    .note-box{background:linear-gradient(180deg, rgba(8,12,28,.9), rgba(8,12,28,.85));
      border:1px solid var(--glass-stroke); padding:16px 18px; border-radius:14px; text-align:center; max-width:min(90vw,860px);
      box-shadow: 0 12px 60px rgba(0,0,0,.5); font-size:14px}
    .note-box h2{margin:0 0 8px 0; font-size:18px}
    .note-box p{margin:6px 0; line-height:1.6}
    .note-box .cols{display:grid; grid-template-columns:repeat(auto-fit,minmax(240px,1fr)); gap:10px; text-align:left}
    kbd{background:#0e1836; border:1px solid #2a356a; border-radius:6px; padding:2px 6px; font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; font-size:90%}

    .badges{display:flex; gap:6px; flex-wrap:wrap; align-items:center; justify-content:center}
    .badge{background:linear-gradient(180deg, rgba(18,32,68,.9), rgba(10,20,48,.9));
      border:1px solid var(--glass-stroke); padding:4px 8px; border-radius:999px; font-size:12px; display:flex; gap:6px; align-items:center}
    .legend{display:flex; gap:8px; flex-wrap:wrap; align-items:center; justify-content:center; font-size:12px}
    .legend .box{width:14px; height:14px; display:inline-block; border-radius:3px; margin-right:4px; vertical-align:middle}
    .legend .item{padding:4px 8px; border-radius:10px; background:rgba(255,255,255,.05); border:1px solid var(--glass-stroke)}

    .gallery{position:absolute; inset:0; display:none; align-items:center; justify-content:center; flex-direction:column; z-index:4;}
    .gallery .backdrop{position:absolute; inset:0; background:rgba(0,0,0,.75); opacity:0; transition:opacity .6s;}
    .gallery img{max-width:min(94vw,1040px); max-height:min(88vh,680px); border-radius:16px; box-shadow:0 30px 120px rgba(0,0,0,.6); opacity:0; transform:translateY(12px) scale(.98); transition:opacity .6s, transform .6s;}
    .gallery .hint{position:absolute; bottom:24px; color:#fff; font-size:16px; opacity:0; text-shadow:0 2px 10px rgba(0,0,0,.6);}
    .gallery.show .backdrop{opacity:1;}
    .gallery.show img{opacity:1; transform:translateY(0) scale(1);} 
    .gallery.show .hint{opacity:.9;}

    .win{position:absolute; inset:0; display:none; align-items:center; justify-content:center; z-index:6;}
    .win.show{display:flex;}
    .win .backdrop{position:absolute; inset:0; background:linear-gradient(180deg, rgba(0,0,0,.75), rgba(0,0,0,.88));}
    .thumb-ring{position:absolute; inset:16px; pointer-events:none; display:grid; grid-template-columns:repeat(10,1fr); gap:6px; opacity:.95}
    .thumb-ring img{width:100%; height:100%; object-fit:cover; border-radius:10px; box-shadow:0 8px 30px rgba(0,0,0,.5);}
    .win .center{position:relative; z-index:2; text-align:center; background:linear-gradient(180deg, rgba(10,14,30,.85), rgba(10,14,30,.75)); padding:18px 22px; border:1px solid var(--glass-stroke); border-radius:16px; box-shadow:0 20px 90px rgba(0,0,0,.5)}
    .win h2{margin:4px 0 6px; font-size:28px; letter-spacing:2px}
    .win .small{opacity:.8; font-size:12px; margin-top:6px}
    .win .again{margin-top:10px}

    @media (max-width: 768px){
      .wrap{padding:8px}
      .pill,.btn{font-size:12px; padding:5px 8px}
      .legend{display:none}
      .hud{gap:6px}
      .thumb-ring{grid-template-columns:repeat(5,1fr)}
    }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Rockæ‰“ç£šå¡Š Breakoutï¼ˆæœ€çµ‚å¢å¼·ç‰ˆï¼‰</h1>
    <div class="hud">
      <div class="pill">åˆ†æ•¸ <span id="score">0</span></div>
      <div class="pill">é—œå¡ <span id="level">1</span>/20</div>
      <div class="pill">ç”Ÿå‘½ <span id="lives">3</span></div>
      <label>é›£åº¦
        <select id="difficulty">
          <option value="easy">Easy</option>
          <option value="normal" selected>Normal</option>
          <option value="hard">Hard</option>
        </select>
      </label>
      <button class="btn" id="pauseBtn">é–‹å§‹ / æš«åœ (<kbd>Space</kbd>)</button>
      <button class="btn" id="resetBtn">é‡é–‹ (<kbd>R</kbd>)</button>
      <button class="btn" id="fsBtn">å…¨è¢å¹• (<kbd>F</kbd>)</button>
      <button class="btn" id="tutorBtn">æ•™å­¸</button>
      <button class="btn" id="effectsBtn">æ•ˆæœèªªæ˜</button>
      <button class="btn" id="soundBtn">éŸ³æ•ˆï¼šé—œ</button>
      <span class="range">BGM
        <button class="btn" id="bgmBtn">é—œ</button>
        <input id="bgmVol" type="range" min="0" max="1" step="0.01" value="0.5" style="width:120px">
      </span>
      <button class="btn" id="saveBtn">å­˜æª”</button>
      <button class="btn" id="loadBtn">è®€æª”</button>
      <button class="btn" id="clearSaveBtn">æ¸…é™¤å­˜æª”</button>
    </div>

    <div class="legend">
      <span class="item"><span class="box" style="background:var(--expl)"></span>çˆ†ç‚¸ç£š</span>
      <span class="item"><span class="box" style="background:var(--brick2)"></span>ä¸€èˆ¬ç£š</span>
      <span class="item"><span class="box" style="background:#888"></span>ä¸å¯ç ´å£ç£š</span>
      <span class="item"><span class="box" style="background:#bb7aff"></span>å¼·åå½ˆç£š</span>
      <span class="item"><span class="box" style="background:#6ec6ff"></span>ç§»å‹•ç£š</span>
      <span class="item"><span class="box" style="background:#ff4d6d"></span>Bossç£š</span>
      <span class="item"><span class="box" style="background:var(--power)"></span>å¢ç›Šé“å…·</span>
      <span class="item"><span class="box" style="background:var(--debuff)"></span>æ¸›ç›Šé“å…·</span>
    </div>
    <div class="badges" id="activeBuffs"></div>

    <div class="overlay" id="overlay">
      <div class="gallery" id="gallery">
        <div class="backdrop"></div>
        <img id="galleryImg" src="" alt="é—œå¡å¤§åœ–" />
        <div class="hint">é»ä¸€ä¸‹é€²å…¥ä¸‹ä¸€é—œ â–¶</div>
      </div>

      <div class="win" id="win">
        <div class="backdrop"></div>
        <div class="thumb-ring" id="ring"></div>
        <div class="center">
          <h2>æ­å–œéé—œï¼</h2>
          <div>ç¸½åˆ†æ•¸ï¼š<span id="finalScore">0</span></div>
          <div class="small">ä½œè€…ï¼š ChatGPTã€€ï¼ã€€æŒ‡å°è€…ï¼š Rock</div>
          <div class="again"><button class="btn" id="againBtn">å†ç©ä¸€æ¬¡</button></div>
        </div>
      </div>

      <canvas id="game" width="1100" height="700"></canvas>
      <div class="center-note" id="centerNote">
        <div class="note-box" id="noteBox">
          <h2 id="noteTitle">æŒ‰ <kbd>Space</kbd> æˆ–é»ç•«é¢é–‹å§‹</h2>
          <p id="noteText">
            æ“ä½œï¼š<kbd>â†</kbd>/<kbd>â†’</kbd> æˆ– <kbd>A</kbd>/<kbd>D</kbd>ï¼›æ‰‹æŒ‡æ‹–æ›³ç•«é¢ä¹Ÿå¯ç§»å‹•å¹³å°ã€‚<br>
            å·²æ•´åˆï¼šèƒŒæ™¯é€æ­¥æ­ç¤º + æ¸…é—œç•«å»Šã€å¢ç›Š/æ¸›ç›Šï¼ˆå«é›»æ¼¿çƒ/å‡çµçƒ/ç¥è–çƒ/é³³å‡°å¯©åˆ¤/9å‘½æ€ªè²“/è¿½è¹¤çƒ/é£›å½ˆçƒ/åœ°ç„çƒ/ç‰¹å¤§çƒ/é–éˆçƒ/å¹³å°ç¸®å°/å¹³å°ç©ºæ´/å¤©åœ°ç¿»è½‰/ç¥é€Ÿæµè½‰ï¼‰ã€çˆ†ç‚¸ç£šã€éŸ³æ•ˆã€é›£åº¦ã€å­˜è®€æª”ã€BGMã€æ•™å­¸/æ•ˆæœèªªæ˜ã€Bossèˆ‡é€²éšç£šã€‚
          </p>
        </div>
      </div>
    </div>
  </div>

<script>
(() => {
  // === å…¨åŸŸéŒ¯èª¤é˜²è­·ï¼ˆé¿å…æŸäº›è£ç½®ä¸Šå› ä¾‹å¤–å°è‡´éŠæˆ²åœæ­¢ï¼‰ ===
  window.addEventListener('error', (e)=>{
    console.error('[Global error]', e.error || e.message);
  });
  window.addEventListener('unhandledrejection', (e)=>{
    console.error('[Promise rejection]', e.reason);
  });

  // === è¨­å®š ===
  const GAME_CONFIG = {
    totalLevels: 20,
    difficulty: {
      easy:   { paddleBaseW: 220, baseSpeed: 4, rowsBase: 6, dropRate: 0.72 },
      normal: { paddleBaseW: 180, baseSpeed: 4.5, rowsBase: 7, dropRate: 0.52 },
      hard:   { paddleBaseW: 140, baseSpeed: 6, rowsBase: 8, dropRate: 0.32 },
    },
    bricks: { explosiveChance: 0.18, brickHeight: 30, padding: 9, topOffset: 60, cols: 12 },
    powers: {
      // æ—¢æœ‰
      WIDE:{label:'å¹³å°è®Šå¯¬',type:'buff',durationMs:30000,paddleWidthAdd:50,badge:'â†”ï¸'},
      LONG:{label:'å¹³å°è®Šé•·(å¯ç–Š)',type:'buff',durationMs:30000,longPerStackAdd:40,stacksMax:2,badge:'ğŸ“'},
      STICKY:{label:'é»æ€§å¹³å°(ä¸Šå½ˆå¯æš«é»)',type:'buff',durationMs:5000,sticky:true,badge:'ğŸ§²'},
      MULTI:{label:'å¤šçƒ',type:'buff',multiDuplicate:true,maxBalls:4,badge:'âœ¨'},
      SLOW:{label:'å…¨å±€æ…¢é€Ÿ',type:'buff',durationMs:15000,speedMul:0.6,badge:'ğŸ¢'},
      PIERCE:{label:'ç©¿é€çƒ',type:'buff',durationMs:12000,piercing:true,badge:'ğŸ¯'},
      SHIELD:{label:'è­·ç›¾(æ‰çƒæ“‹ä¸€æ¬¡)',type:'buff',oneShotShield:true,badge:'ğŸ›¡'},
      RAMPAGE:{label:'æš´èµ°çƒ(çŸ­æš«å¼·ç©¿)',type:'buff',durationMs:5000,forcePiercing:true,rampageMs:5000,badge:'ğŸ”¥'},
      FAST:{label:'å¿«é€Ÿçƒ',type:'debuff',durationMs:5000,globalSpeedMul:1.5,screenShakeOnApply:6,badge:'âš¡'},
      WAVY:{label:'è®Šé€Ÿçƒ',type:'debuff',durationMs:5000,wavy:{amp:0.6,base:1.2,periodMs:200},badge:'ã€°ï¸'},
      PLASMA:{label:'é›»æ¼¿çƒ(æ“Šä¸­æ”¾å‡ºé›»æ¼¿åœˆæ¸…åˆ—)',type:'buff',durationMs:10000,plasma:{drift:1.2,radius:38,lifeMs:3000},badge:'âš¡ï¸'},
      FREEZE:{label:'å‡çµçƒ(å»¶é²åœé “ä¸€ä¸‹)',type:'buff',durationMs:10000,freeze:{delayMs:300,stopMs:2000},badge:'â„ï¸'},
      HOLY:{label:'ç¥è–çƒ(åå­—æ¸…ç·š)',type:'buff',durationMs:5000,holy:{},badge:'âœï¸'},
      PHOENIX:{label:'é³³å‡°å¯©åˆ¤(æ¶ˆåŠå ´/ä¸ç§’æ®ºBoss)',type:'rare',rareFactor:0.08,instant:true,badge:'ğŸª½'},
      NINE:{label:'9å‘½æ€ªè²“(ç”Ÿå‘½è®Š9)',type:'rare',rareFactor:0.08,instant:true,badge:'ğŸ±'},
      // === æ–°å¢ ===
      HOMING:{label:'è¿½è¹¤çƒ(æœå¹³å°/ç¨ç«‹ç£š)',type:'buff',durationMs:10000,homing:true,badge:'ğŸŒ€'},
      MISSILE:{label:'é£›å½ˆçƒ(å¹³å°å½ˆå‡º3æš)',type:'buff',durationMs:5000,missile:{count:3,speed:7,seek:0.12,lifeMs:3000,boomR:28},badge:'ğŸš€'},
      INFERNO:{label:'åœ°ç„çƒ(+é€Ÿ/é»‘æ´åé„°æ ¼)',type:'buff',durationMs:5000,inferno:{speedMul:1.2,blackholeMs:2000},badge:'ğŸ•³ï¸'},
      MEGA:{label:'ç‰¹å¤§çƒ(åŠå¾‘Ã—3/é€Ÿåº¦Ã—0.8)',type:'buff',durationMs:5000,mega:{rMul:3,sMul:0.8},badge:'âšª'},
      CHAIN:{label:'é–éˆçƒ(é–10ç§’ä¸å¯ç ´)',type:'debuff',durationMs:5000,chain:{lockMs:10000},badge:'â›“ï¸'},
      NARROW:{label:'å¹³å°ç¸®å°(å¯¬åº¦åŠ)',type:'debuff',durationMs:5000,narrow:true,badge:'â†”ï¸'},
      HOLEPAD:{label:'å¹³å°ç©ºæ´(ä¸­é–“-1/3)',type:'debuff',durationMs:5000,hole:true,badge:'ğŸ•³'},
      FLIP:{label:'å¤©åœ°ç¿»è½‰(æ”¹å·¦å´ç‚ºåœ°æ¿)',type:'rare',durationMs:15000,flip:true,rareFactor:0.08,badge:'ğŸ”„'},
      SPEEDGOD:{label:'ç¥é€Ÿæµè½‰(å°åº•/æ»¿é€Ÿ/ç„¡è¦–æ•ˆæœ)',type:'rare',durationMs:10000,speedgod:true,rareFactor:0.08,badge:'ğŸŒŸ'}
    },
    powerCapsule:{width:24,height:16,fallVy:2.2},
    caps:{paddleMaxW:300,ballSpeedMax:13}
  };

  // === å½±åƒè¼‰å…¥ ===
  const IMG_PAIRS = Array.from({length:10}, (_,i)=> i+1).map(i=>({bg:`images/bg${i}.png`, cg:`images/cg${i}.png`}));
  const IMG_PAIRS_FALLBACK = Array.from({length:10}, (_,i)=> i+1).map(i=>({bg:`images/bg${i}.jpg`, cg:`images/cg${i}.jpg`}));
  function makeImg(src, fallback){
    const im = new Image(); im.decoding='async'; im.loading='eager'; im.src=src;
    if(fallback){ im.onerror=()=>{ if(im.src!==fallback) im.src=fallback; }; }
    return im;
  }
  const IMG_MAP = [];
  for(let i=0;i<10;i++){
    IMG_MAP[i] = { bg: makeImg(IMG_PAIRS[i].bg, IMG_PAIRS_FALLBACK[i].bg),
                   cg: makeImg(IMG_PAIRS[i].cg, IMG_PAIRS_FALLBACK[i].cg) };
  }

  // === åƒè€ƒ DOM ===
  const canvas=document.getElementById('game'); const ctx=canvas.getContext('2d');
  const scoreEl=document.getElementById('score'), levelEl=document.getElementById('level'), livesEl=document.getElementById('lives');
  const pauseBtn=document.getElementById('pauseBtn'), resetBtn=document.getElementById('resetBtn'), fsBtn=document.getElementById('fsBtn');
  const soundBtn=document.getElementById('soundBtn'), saveBtn=document.getElementById('saveBtn'), loadBtn=document.getElementById('loadBtn'), clearSaveBtn=document.getElementById('clearSaveBtn');
  const tutorBtn=document.getElementById('tutorBtn'), effectsBtn=document.getElementById('effectsBtn');
  const centerNote=document.getElementById('centerNote'), noteTitle=document.getElementById('noteTitle'), noteText=document.getElementById('noteText'), noteBox=document.getElementById('noteBox');
  const difficultySel=document.getElementById('difficulty'), activeBuffsEl=document.getElementById('activeBuffs');
  const gallery=document.getElementById('gallery'), galleryImg=document.getElementById('galleryImg');
  const win=document.getElementById('win'), ring=document.getElementById('ring'), finalScore=document.getElementById('finalScore'), againBtn=document.getElementById('againBtn');
  const bgmBtn=document.getElementById('bgmBtn'), bgmVol=document.getElementById('bgmVol');
  const overlayEl=document.getElementById('overlay'); // ğŸ”§ æ–°å¢ï¼šæ•´å€‹ç•«å¸ƒå€å®¹å™¨

  // === DPR ç¸®æ”¾ ===
  function resizeCanvasDPR(){ const dpr=Math.min(window.devicePixelRatio||1,2); const cssW=canvas.clientWidth; const cssH=Math.round(cssW*(700/1100)); canvas.style.height=cssH+'px'; canvas.width=Math.round(cssW*dpr); canvas.height=Math.round(cssH*dpr); scaleX=canvas.width/1100; scaleY=canvas.height/700; }
  let scaleX=1, scaleY=1; window.addEventListener('resize', resizeCanvasDPR, {passive:true}); resizeCanvasDPR();

  // === ç‹€æ…‹ ===
  let running=false, paused=true, level=1, score=0, lives=3, soundsOn=false;
  let bgTime=0; let screenShake=0;
  let countdownTimer=null, countdownShow=0, resumePending=false;
  let imageChoice = new Array(10).fill(-1);
  let audioCtx=null, bgmGain=null, bgmOn=false, bgmStarted=false, bgmNodes=[];

  // === iOS/Chrome éŸ³è¨Šè§£é–ä¿éšª ===
  let audioUnlocked = false;
  function unlockAudio(){
    if(audioUnlocked) return;
    ensureAudio();
    try{ audioCtx && audioCtx.resume && audioCtx.resume(); }catch(e){}
    audioUnlocked = true;
  }
  window.addEventListener('pointerdown', unlockAudio, {once:true, passive:true});
  window.addEventListener('touchstart', unlockAudio, {once:true, passive:true});

  const particles=[]; const plasmas=[]; const holyFlashes=[]; let phoenixAnim=null; const fireBursts=[];
  const missiles=[]; const blackHoles=[];
  let orientation = 'bottom';
  let prevOrientationForSuper = 'bottom';

  function spawnParticles(x,y,color,count=10,spread=1.6,speed=3,size=3){
    for(let i=0;i<count;i++){ const a=Math.random()*Math.PI*2; const v=speed*(.4+Math.random()); particles.push({x,y,vx:Math.cos(a)*v,vy:Math.sin(a)*v,life:400+Math.random()*300,size:size*(.6+Math.random()*0.8),color}); }
  }

  // === å·¥å…· ===
  function getDiff(){ return GAME_CONFIG.difficulty[difficultySel.value]; }
  function brickColor(i){ return [getVar('--brick1'),getVar('--brick2'),getVar('--brick3'),getVar('--brick4')][i%4]; }
  function getVar(n){ return getComputedStyle(document.documentElement).getPropertyValue(n).trim(); }
  function clampHP(h){ return Math.max(1, Math.min(4, (h|0))); }
  function roundedRect(x,y,w,h,r){ ctx.beginPath(); ctx.moveTo(x+r,y); ctx.arcTo(x+w,y,x+w,y+h,r); ctx.arcTo(x+w,y+h,x,y+h,r); ctx.arcTo(x,y+h,x,y,r); ctx.arcTo(x,y,x+w,y,r); ctx.closePath(); }
  function drawRoundedRect(x,y,w,h,r){ ctx.beginPath(); ctx.moveTo((x+r)*scaleX,y*scaleY); ctx.arcTo((x+w)*scaleX,y*scaleY,(x+w)*scaleX,(y+h)*scaleY,r*scaleX); ctx.arcTo((x+w)*scaleX,(y+h)*scaleY,x*scaleX,(y+h)*scaleY,r*scaleX); ctx.arcTo(x*scaleX,(y+h)*scaleY,x*scaleX,y*scaleY,r*scaleX); ctx.arcTo(x*scaleX,y*scaleY,(x+w)*scaleX,y*scaleY,r*scaleX); ctx.closePath(); }
  function nowMs(){ return performance.now(); }
  function isSuper(){ return buffs.SPEEDGOD?.active; }
  function effOn(key){ return !!(buffs[key]?.active && !isSuper()); }

  // === Buff é¡¯ç¤º ===
  function badgeIcon(k){ return (GAME_CONFIG.powers[k]?.badge)||'â—'; }
  function updateBuffBadges(){ activeBuffsEl.innerHTML=''; const now=nowMs();
    const longAct=buffs.LONG.stacks.filter(t=>t>now); if(longAct.length){ const s=document.createElement('span'); s.className='badge'; s.textContent=`${badgeIcon('LONG')} LONGÃ—${longAct.length} ${Math.max(0,Math.max(...longAct)-now|0)}ms`; activeBuffsEl.appendChild(s); }
    for(const key of Object.keys(GAME_CONFIG.powers)){
      if(key==='LONG') continue;
      const b=buffs[key]; if(!b?.active) continue;
      const left=b.until&&b.until>now?((b.until-now)/1000).toFixed(1)+'s':'';
      const s=document.createElement('span'); s.className='badge';
      s.textContent=`${badgeIcon(key)} ${key}${left?' '+left:''}`;
      activeBuffsEl.appendChild(s);
    }
  }

  // === Buff ç‹€æ…‹ ===
  const buffs={WIDE:{active:false,until:0},STICKY:{active:false,until:0},MULTI:{active:false,until:0},SLOW:{active:false,until:0},PIERCE:{active:false,until:0},
    SHIELD:{active:false,until:0},RAMPAGE:{active:false,until:0},FAST:{active:false,until:0},WAVY:{active:false,until:0},LONG:{active:false,until:0,stacks:[]},
    PLASMA:{active:false,until:0},FREEZE:{active:false,until:0},HOLY:{active:false,until:0},
    HOMING:{active:false,until:0},MISSILE:{active:false,until:0},INFERNO:{active:false,until:0},MEGA:{active:false,until:0},
    CHAIN:{active:false,until:0},NARROW:{active:false,until:0},HOLEPAD:{active:false,until:0},
    FLIP:{active:false,until:0},SPEEDGOD:{active:false,until:0}
  };

  // === æ“‹æ¿ & çƒ ===
  let diff=getDiff();
  const paddle={w:diff.paddleBaseW,h:18,x:1100/2-diff.paddleBaseW/2,y:700-50,speed:12};
  function ballBase(){ return {x:(1100/2),y:700/2,r:10,vx:5,vy:-5,speedCap:GAME_CONFIG.caps.ballSpeedMax,piercing:false,stuck:false,offsetX:0,rampageUntil:0,trail:[],freeze:{state:'idle',t0:0,until:0,oldVX:0,oldVY:0,delay:0,stop:0}};}
  let balls=[]; function makeBall(){ return ballBase(); }

  // === è²éŸ³èˆ‡BGM ===
  function ensureAudio(){ if(!audioCtx){ const AC=(window.AudioContext||window.webkitAudioContext); if(AC){ audioCtx=new AC(); } } if(audioCtx && !bgmGain){ bgmGain=audioCtx.createGain(); bgmGain.gain.value=parseFloat(localStorage.getItem('bgm_vol')||'0.5'); bgmGain.connect(audioCtx.destination); } }
  function beep(freq=600,dur=0.05,vol=0.06){
    try{
      if(!soundsOn||!audioCtx) return;
      const o=audioCtx.createOscillator();
      const g=audioCtx.createGain();
      o.type='square'; o.frequency.value=freq; g.gain.value=vol;
      o.connect(g); g.connect(audioCtx.destination);
      o.start();
      setTimeout(()=>{ try{o.stop(); g.disconnect?.();}catch{} }, Math.max(10, dur*1000));
    }catch(e){ /* iOS may block audio before unlock; ignore so gameplay proceeds */ }
  }

  function startBGM(){
    if(!audioCtx) ensureAudio();
    if(!audioCtx) return;
    if(bgmStarted) return;
    audioCtx.resume?.();
    bgmStarted=true;
    const now=audioCtx.currentTime;
    const tempo=92/60;
    function tone(freq, type='sine', start, dur, gain=0.03){
      const o=audioCtx.createOscillator(); const g=audioCtx.createGain();
      o.type=type; o.frequency.value=freq; g.gain.value=0; o.connect(g); g.connect(bgmGain);
      o.start(now+start); g.gain.value=gain;
      setTimeout(()=>{ try{o.stop();}catch{} }, (start+dur+0.1)*1000);
      bgmNodes.push(o,g);
    }
    function loop(){
      if(!bgmOn) return;
      bgmNodes=[];
      const prog=[[261.63,329.63,392.00,493.88],[220.00,261.63,329.63,392.00],[174.61,220.00,261.63,349.23],[196.00,246.94,392.00,392.00]];
      for(let i=0;i<4;i++){ const chord=prog[i]; for(const f of chord){ tone(f,'sine', i*1.9, 1.7, 0.015); } }
      const mel=[523.25,587.33,659.25,587.33,523.25,659.25,698.46,659.25,587.33];
      mel.forEach((f,idx)=> tone(f,'triangle', 0.4+idx*0.45, 0.3, 0.025));
      setTimeout(()=>{ if(bgmOn) loop(); }, 3800);
    }
    loop();
  }
  function stopBGM(){ bgmStarted=false; bgmNodes.forEach(n=>{try{n.disconnect?.()}catch{} }); bgmNodes.length=0; }

  // === ç£šå¡Šèˆ‡æ­ç¤º ===
  let bricks=[]; let brickW=0, brickH=GAME_CONFIG.bricks.brickHeight; let revealRects=[];
  function layout(){ return {rows:getDiff().rowsBase+Math.floor((level-1)%3), cols:GAME_CONFIG.bricks.cols, pad:GAME_CONFIG.bricks.padding, top:getDiff().topOffset||GAME_CONFIG.bricks.topOffset, h:GAME_CONFIG.bricks.brickHeight}; }

  function getLevelImage(levelNum){
    const idx=((levelNum-1)%10);
    if(levelNum<=10){ if(imageChoice[idx]<0){ imageChoice[idx]= Math.random()<0.5 ? 0:1; } return imageChoice[idx]===0? IMG_MAP[idx].bg : IMG_MAP[idx].cg; }
    else{ if(imageChoice[idx]<0){ imageChoice[idx]=0; } return imageChoice[idx]===0? IMG_MAP[idx].cg : IMG_MAP[idx].bg; }
  }

  function addBrick(list, x,y,w,h, opts={}){
    list.push(Object.assign({x,y,w,h,hp:opts.unbreakable?Infinity:(opts.hp||1), colorIdx:0, explosive:false, unbreakable:false, strong:false, moving:false, vx:0, vy:0, boss:false, face:'', chainUntil:0}, opts));
  }

  function postAdjustAndDensify(L){
    const rows=L.rows, cols=L.cols, pad=L.pad;
    const xAt = c=> L.pad + c*(brickW+L.pad);
    const yAt = r=> L.top + r*(brickH+L.pad);
    const occ = Array.from({length:rows}, ()=> Array(cols).fill(false));
    function markRect(x,y,w,h){
      const c0 = Math.max(0, Math.min(cols-1, Math.round((x - L.pad) / (brickW + L.pad)) ));
      const r0 = Math.max(0, Math.min(rows-1, Math.round((y - L.top) / (brickH + L.pad)) ));
      const cellsX = Math.max(1, Math.round((w + L.pad) / (brickW + L.pad)));
      const cellsY = Math.max(1, Math.round((h + L.pad) / (brickH + L.pad)));
      for(let rr=0; rr<cellsY; rr++) for(let cc=0; cc<cellsX; cc++){
        const c = Math.min(cols-1, c0 + cc);
        const r = Math.min(rows-1, r0 + rr);
        occ[r][c] = true;
      }
    }
    for(const b of bricks){ if(!b.unbreakable && !b.boss){ b.hp = clampHP(b.hp||1); } markRect(b.x,b.y,b.w,b.h); }
    let filled = 0; for(let r=0;r<rows;r++) for(let c=0;c<cols;c++) if(occ[r][c]) filled++;
    const target = Math.ceil(rows*cols * (2/3));
    if(filled >= target) return;

    const midC = (cols-1)/2, midR = (rows-1)/2;
    const empties = [];
    for(let r=0;r<rows;r++) for(let c=0;c<cols;c++) if(!occ[r][c]){ const score = (c-midC)**2 + (r-midR)**2; empties.push({r,c,score}); }
    empties.sort((a,b)=> a.score - b.score);
    const baseHP = Math.min(1 + Math.floor((level-1)/5), 3);
    let idx=0;
    while(filled < target && idx<empties.length){
      const {r,c} = empties[idx++]; if(occ[r][c]) continue;
      let hp = baseHP + ((level>=13 && r>rows/2)?1:0);
      hp = clampHP(hp);
      const moving = (Math.random()<0.08) && (r%2===0);
      const vx = moving ? ((Math.random()<0.5?-1:1)*0.6) : 0;
      addBrick(bricks, xAt(c), yAt(r), brickW, brickH, {hp, colorIdx:(r%4), moving, vx});
      occ[r][c] = true; filled += 1;
    }
  }

  function initBricks(){
    const L=layout();
    const totalPad=(L.cols+1)*L.pad; brickW=Math.floor((1100-totalPad)/L.cols); brickH=L.h; bricks=[]; revealRects=[];
    generateLevel(level, L);
    postAdjustAndDensify(L);
  }

  function hasBreakables(){ return bricks.some(b => !b.unbreakable); }

  function revealBrickArea(brick){
    const L = layout(); const cellW = brickW, cellH = brickH;
    const c0 = Math.max(0, Math.min(GAME_CONFIG.bricks.cols-1, Math.round((brick.x - L.pad) / (cellW + L.pad)) ));
    const r0 = Math.max(0, Math.min(L.rows-1, Math.round((brick.y - L.top) / (cellH + L.pad)) ));
    const cellsX = Math.max(1, Math.round((brick.w + L.pad) / (cellW + L.pad)));
    const cellsY = Math.max(1, Math.round((brick.h + L.pad) / (cellH + L.pad)));
    for(let rr=0; rr<cellsY; rr++){
      for(let cc=0; cc<cellsX; cc++){
        const c = Math.min(GAME_CONFIG.bricks.cols-1, c0 + cc);
        const r = Math.min(L.rows-1, r0 + rr);
        const rx = L.pad + c*(cellW + L.pad);
        const ry = L.top + r*(cellH + L.pad);
        revealRects.push({x:rx, y:ry, w:cellW, h:cellH});
      }
    } }

  function gridRCForBrick(brick){
    const L = layout();
    const c = Math.max(0, Math.min(GAME_CONFIG.bricks.cols-1, Math.round((brick.x - L.pad) / (brickW + L.pad)) ));
    const r = Math.max(0, Math.min(L.rows-1, Math.round((brick.y - L.top) / (brickH + L.pad)) ));
    return {r,c};
  }
  function isChained(br){ return br.chainUntil && nowMs() < br.chainUntil; }

  function generateLevel(lv, L){
    const cols=L.cols, rows=L.rows, pad=L.pad, top=L.top;
    const baseHP = 1 + Math.floor((lv-1)/3);
    const xAt = c=> L.pad + c*(brickW+L.pad);
    const yAt = r=> L.top + r*(brickH+L.pad);
    const isBoss = (lv%5===0);
    if(isBoss){
      const bx = Math.floor(cols/2)-1;
      const by = Math.max(1, Math.floor(rows/2)-1);
      const w = brickW*2 + pad;
      const h = brickH*2 + pad;
      const hpList=[10,20,30,40];
      const bossIdx = Math.floor(lv/5)-1;
      const bossHP = hpList[Math.max(0,Math.min(3,bossIdx))];
      const faces=['ç…','é¨','ç›®','é­”'];
      addBrick(bricks, xAt(bx), yAt(by), w, h, {hp:bossHP, colorIdx:0, boss:true, face:faces[bossIdx], strong:true});
      for(let r=0;r<rows;r++){
        for(let c=0;c<cols;c++){
          if(c>=bx-2 && c<=bx+3 && r>=by-2 && r<=by+3) continue;
          const explosive=Math.random()<GAME_CONFIG.bricks.explosiveChance;
          addBrick(bricks, xAt(c), yAt(r), brickW, brickH, {hp:baseHP, colorIdx:(r%4), explosive});
        }
      }
      for(let c=0;c<cols;c+=2) addBrick(bricks, xAt(c), yAt(0), brickW, brickH, {unbreakable:true});
      return;
    }
    if(lv<=3){
      for(let r=0;r<rows;r++) for(let c=0;c<cols;c++){
        const explosive=Math.random()<GAME_CONFIG.bricks.explosiveChance*0.7;
        addBrick(bricks, xAt(c), yAt(r), brickW, brickH, {hp:baseHP, colorIdx:(r%4), explosive});
      }
    }else if(lv<=6){
      const mid=Math.floor(cols/2);
      for(let r=0;r<rows;r++){
        for(let c=0;c<cols;c++){
          if(Math.abs(c-mid)===r%5 && r<rows-1){
            addBrick(bricks, xAt(c), yAt(r), brickW, brickH, {hp:baseHP+((r%2)?1:0), colorIdx:r%4});
          }else if(r===Math.floor(rows/2) && (c%3===0)){
            addBrick(bricks, xAt(c), yAt(r), brickW, brickH, {hp:baseHP, explosive:true, colorIdx:r%4});
          }
        }
      }
    }else if(lv<=10){
      for(let r=0;r<rows;r++){
        for(let c=0;c<cols;c++){
          if(r%4===0 && c%3===0){
            addBrick(bricks, xAt(c), yAt(r), brickW, brickH, {unbreakable:true});
          }else{
            const moving = (r%3===0 && c%4===0);
            addBrick(bricks, xAt(c), yAt(r), brickW, brickH, {hp:baseHP+1, colorIdx:r%4, moving, vx: moving? ((Math.random()<0.5?-1:1)*0.6) : 0});
          }
        }
      }
    }else if(lv<=14){
      for(let r=0;r<rows;r++){
        for(let c=0;c<cols;c++){
          if((r+c)%2===0){
            addBrick(bricks, xAt(c), yAt(r), brickW, brickH, {hp:baseHP+1, colorIdx:r%4, strong:(r%4===1)});
          }else if(r%5===0){
            addBrick(bricks, xAt(c), yAt(r), brickW, brickH, {unbreakable:true});
          }else if(c%5===0){
            addBrick(bricks, xAt(c), yAt(r), brickW, brickH, {hp:baseHP, moving:true, vx: (Math.random()<0.5?-1:1)*0.8});
          }
        }
      }
    }else{
      for(let r=0;r<rows;r++){
        for(let c=0;c<cols;c++){
          if(r===1 || r===rows-2){
            addBrick(bricks, xAt(c), yAt(r), brickW, brickH, {unbreakable:true});
          }else if(c%3===0 && (r%2===0)){
            addBrick(bricks, xAt(c), yAt(r), brickW, brickH, {hp:baseHP+2, strong:true});
          }else{
            const mv=(r%3===1 && c%2===0);
            addBrick(bricks, xAt(c), yAt(r), brickW, brickH, {hp:baseHP+1, moving:mv, vx: mv?((Math.random()<0.5?-1:1)*1.0):0});
          }
        }
      }
    }
  }

  function explodeAt(cx,cy){
    const radius=Math.max(brickW,brickH)*1.3;
    for(let i=bricks.length-1;i>=0;i--){
      const b=bricks[i];
      if(isChained(b)) continue;
      const bx=b.x+b.w/2, by=b.y+b.h/2; const d=Math.hypot(bx-cx,by-cy);
      if(d<=radius){
        if(b.unbreakable){ continue; }
        if(b.boss){ b.hp -= 1; if(b.hp<=0){ revealBrickArea(b); bricks.splice(i,1); score+=50; } }
        else { revealBrickArea(b); bricks.splice(i,1); score+=10; }
        spawnParticles(bx,by,'#ffdd99',14,1.7,2.6,3);
      }
    }
    spawnParticles(cx,cy,'#ffbb55',24,2.1,3.2,4); updateHUD(); beep(200,0.08,0.08);
  }

  // === æ‰è½é“å…· ===
  const powerups=[]; const ALL_TYPES=Object.keys(GAME_CONFIG.powers); const NORMAL_TYPES=ALL_TYPES.filter(k=>GAME_CONFIG.powers[k].type!=='rare'); const RARE_TYPES=ALL_TYPES.filter(k=>GAME_CONFIG.powers[k].type==='rare');
  function dropRateForLevel(lv){
    const diff = getDiff(); const base = diff.dropRate || 0.5;
    const startBoostAt = 8; const incPerLv = 0.02;
    let inc = Math.max(0, (lv - startBoostAt) * incPerLv);
    let max = 0.9; const d = (typeof difficultySel!=='undefined') ? difficultySel.value : 'normal';
    if(d==='normal') max = 0.7; if(d==='hard') max = 0.5;
    return Math.min(max, base + inc);
  }
  function spawnPower(x,y){
    const rareChance=(GAME_CONFIG.powers.PHOENIX?.rareFactor)||0.08;
    const pickRare=RARE_TYPES.length && Math.random()<rareChance;
    const pool=pickRare?RARE_TYPES:NORMAL_TYPES;
    const type=pool[Math.floor(Math.random()*pool.length)];
    const def=GAME_CONFIG.powers[type];
    powerups.push({x,y,w:GAME_CONFIG.powerCapsule.width,h:GAME_CONFIG.powerCapsule.height,vy:GAME_CONFIG.powerCapsule.fallVy,type,isDebuff:(def.type==='debuff'),phase:Math.random()*Math.PI*2});
  }

  function applyPower(type){
    const def=GAME_CONFIG.powers[type]; if(!def) return; const now=nowMs();
    if(def.instant && def.type==='rare'){
      if(type==='PHOENIX'){
        phoenixAnim={x:canvas.width+220,tEnd:now+1200};
        const keep=[]; for(const b of bricks){
          if(Math.random()<0.5){
            if(b.unbreakable || isChained(b)){ keep.push(b); continue; }
            if(b.boss){ b.hp -= 1; if(b.hp>0){ keep.push(b);} else { revealBrickArea(b); score+=50; } }
            else { revealBrickArea(b); score+=10; }
            fireBursts.push({x:b.x+b.w/2,y:b.y+b.h/2,life:400+Math.random()*400});
          } else keep.push(b);
        }
        bricks=keep; screenShake=6; beep(180,0.12,0.1);
      } else if(type==='NINE'){ lives=9; updateHUD(); spawnParticles(550,350,'#ffd',40,2.2,3.5,4); beep(880,0.1,0.06); }
      return;
    }
    if(def.durationMs){ if(type!=='LONG'){ const b=buffs[type]||(buffs[type]={active:false,until:0}); b.active=true; b.until=now+def.durationMs; } }
    if(def.paddleWidthAdd){ buffs.WIDE.active=true; buffs.WIDE.until=now+def.durationMs; }
    if(def.longPerStackAdd){ const act=buffs.LONG.stacks.filter(t=>t>now); const max=def.stacksMax??2; if(act.length<max){ buffs.LONG.stacks.push(now+def.durationMs);} else { const earliest=Math.min(...act); const idx=buffs.LONG.stacks.indexOf(earliest); buffs.LONG.stacks[idx]=now+def.durationMs; } }
    if(def.sticky){ buffs.STICKY.active=true; buffs.STICKY.until=now+def.durationMs; }
    if(def.multiDuplicate){ if(balls.length<3){ const news=[]; for(const b of balls){ const b1={...b}; b1.trail=[]; news.push(b1);} balls=balls.concat(news); const cap=def.maxBalls??4; if(balls.length>cap) balls.length=cap; } }
    if(def.speedMul){ buffs.SLOW.active=true; buffs.SLOW.until=now+def.durationMs; }
    if(def.piercing){ buffs.PIERCE.active=true; buffs.PIERCE.until=now+def.durationMs; for(const b of balls) b.piercing=true; }
    if(def.oneShotShield){ buffs.SHIELD.active=true; }
    if(def.forcePiercing && def.rampageMs){ buffs.RAMPAGE.active=true; buffs.RAMPAGE.until=now+def.durationMs; for(const b of balls){ b.rampageUntil=now+def.rampageMs; b.piercing=true; } }
    if(def.globalSpeedMul){ buffs.FAST.active=true; buffs.FAST.until=now+def.durationMs; if(def.screenShakeOnApply) screenShake=def.screenShakeOnApply; }
    if(def.wavy){ buffs.WAVY.active=true; buffs.WAVY.until=now+def.durationMs; buffs.WAVY.start=now; }
    if(type==='PLASMA'){ buffs.PLASMA.active=true; buffs.PLASMA.until=now+def.durationMs; }
    if(type==='FREEZE'){ buffs.FREEZE.active=true; buffs.FREEZE.until=now+def.durationMs; }
    if(type==='HOLY'){ buffs.HOLY.active=true; buffs.HOLY.until=now+def.durationMs; }
    if(type==='HOMING'){ buffs.HOMING.active=true; buffs.HOMING.until=now+def.durationMs; }
    if(type==='MISSILE'){ buffs.MISSILE.active=true; buffs.MISSILE.until=now+def.durationMs; }
    if(type==='INFERNO'){ buffs.INFERNO.active=true; buffs.INFERNO.until=now+def.durationMs; }
    if(type==='MEGA'){ buffs.MEGA.active=true; buffs.MEGA.until=now+def.durationMs; }
    if(type==='CHAIN'){ buffs.CHAIN.active=true; buffs.CHAIN.until=now+def.durationMs; }
    if(type==='NARROW'){ buffs.NARROW.active=true; buffs.NARROW.until=now+def.durationMs; }
    if(type==='HOLEPAD'){ buffs.HOLEPAD.active=true; buffs.HOLEPAD.until=now+def.durationMs; }
    if(type==='FLIP'){ buffs.FLIP.active=true; buffs.FLIP.until=now+def.durationMs; if(!isSuper()){ orientation='left'; paddle.y = Math.max(20, Math.min(700-20-paddle.w, 350 - paddle.w/2)); } }
    if(type==='SPEEDGOD'){ buffs.SPEEDGOD.active=true; buffs.SPEEDGOD.until=now+def.durationMs; prevOrientationForSuper=orientation; orientation='bottom'; }
    updateBuffBadges();
  }

  function drawPower(p){ const color=p.isDebuff?getVar('--debuff'):getVar('--power'); const x=p.x*scaleX, y=p.y*scaleY, w=p.w*scaleX, h=p.h*scaleY; const wobble=Math.sin(p.phase)*1.5; p.phase+=0.04;
    ctx.save(); ctx.translate(0,wobble); const grd=ctx.createLinearGradient(x,y,x,y+h); grd.addColorStop(0,color); grd.addColorStop(1,p.isDebuff?'#a33':'#3a56a8'); ctx.fillStyle=grd; roundedRect(x,y,w,h,8); ctx.fill(); ctx.strokeStyle='rgba(255,255,255,.25)'; ctx.stroke();
    ctx.fillStyle='#fff'; ctx.font=`${Math.max(10,Math.round(12*scaleY))}px ui-monospace, monospace`; ctx.textAlign='center'; ctx.textBaseline='middle'; ctx.fillText(p.type[0], x+w/2, y+h/2+0.5); ctx.restore(); }

  function updateHUD(){ scoreEl.textContent=Math.max(0|score,0); levelEl.textContent=level + '/'+ GAME_CONFIG.totalLevels; livesEl.textContent=lives; }
  function showCenter(t,txt){ noteTitle.textContent=t; noteText.innerHTML=txt||''; centerNote.style.display='flex'; }
  function hideCenter(){ centerNote.style.display='none'; }

  function resetGame(load=false){ diff=getDiff(); level=load?level:1; score=load?score:0; lives=load?lives:3; updateHUD(); initBricks(); resetBalls(); paused=true; running=false;
    for(const k of Object.keys(buffs)){ if(k!=='LONG'){ buffs[k].active=false; buffs[k].until=0; } } buffs.LONG.stacks=[]; powerups.length=0; particles.length=0; plasmas.length=0; holyFlashes.length=0; phoenixAnim=null; fireBursts.length=0; missiles.length=0; blackHoles.length=0; orientation='bottom';
    updateBuffBadges(); computePaddleWidth(); paddle.x=1100/2-paddle.w/2; paddle.y=700-50; showCenter('æŒ‰ Space æˆ–é»ç•«é¢é–‹å§‹','ç”¨ â†/â†’ æˆ– A/D ç§»å‹•ï¼›æ‰‹æŒ‡æ‹–æ›³ç•«é¢ä¹Ÿå¯ã€‚'); countdownShow=0; }

  // === å­˜è®€æª”ï¼ˆå«éŸ³æ•ˆ/BGMèˆ‡å½±åƒé¸æ“‡ï¼‰ ===
  function saveProgress(){ try{
      const data={level,score,lives,difficulty:difficultySel.value, imageChoice, soundsOn, bgmOn, bgmVol: parseFloat(bgmVol.value)};
      localStorage.setItem('breakout_save_v_final_cfg', JSON.stringify(data)); alert('å·²å­˜æª”ï¼');
    }catch(e){ alert('å­˜æª”å¤±æ•—ï¼š'+e); } }
  function loadProgress(){ try{ const raw=localStorage.getItem('breakout_save_v_final_cfg')||localStorage.getItem('breakout_save_v4'); if(!raw){ alert('æ²’æœ‰å­˜æª”'); return; } const data=JSON.parse(raw);
      difficultySel.value=data.difficulty||'normal'; level=data.level||1; score=data.score||0; lives=data.lives||3; if(Array.isArray(data.imageChoice)) imageChoice=data.imageChoice;
      soundsOn=!!data.soundsOn; soundBtn.textContent=`éŸ³æ•ˆï¼š${soundsOn?'é–‹':'é—œ'}`;
      if(typeof data.bgmOn==='boolean'){ bgmOn=data.bgmOn; } if(typeof data.bgmVol==='number'){ bgmVol.value=String(data.bgmVol); if(bgmGain) bgmGain.gain.value=data.bgmVol; localStorage.setItem('bgm_vol', data.bgmVol); }
      resetGame(true); updateHUD(); alert(`å·²è®€æª”ï¼šç­‰ç´š ${level}ï¼Œåˆ†æ•¸ ${score}ï¼Œç”Ÿå‘½ ${lives}`);}catch(e){ alert('è®€æª”å¤±æ•—ï¼š'+e); } }
  function clearSave(){ localStorage.removeItem('breakout_save_v_final_cfg'); alert('å·²æ¸…é™¤å­˜æª”'); }

  // === è¼¸å…¥ï¼ˆå«è§¸æ§ï¼‰ ===
  let keyL=false, keyR=false; let touchActive=false;
  window.addEventListener('keydown',(e)=>{
    const k = e.key || e.code;
    if(k===' '||k==='Space'||k==='ArrowLeft'||k==='ArrowRight'||k==='ArrowUp'||k==='ArrowDown'){ e.preventDefault(); }

    if(e.code==='ArrowLeft'||e.key==='a'||e.key==='A') keyL=true;
    if(e.code==='ArrowRight'||e.key==='d'||e.key==='D') keyR=true;
    if(e.code==='Space'){ if(!running){ startGameWithCountdown(); } else { togglePause(); } return; }
    if((e.code==='ArrowUp' || e.key==='Shift') && !paused && running){
      let released=false;
      for(const b of balls){ if(b.stuck){ b.stuck=false; b.vy = -Math.abs(b.vy||6); released=true; } }
      if(released) return;
    }
    if(e.key==='r'||e.key==='R'){ resetGame(); }
    if(e.key==='f'||e.key==='F'){ toggleFullscreen(); }
  });
  window.addEventListener('keyup',(e)=>{ if(e.code==='ArrowLeft'||e.key==='a'||e.key==='A') keyL=false; if(e.code==='ArrowRight'||e.key==='d'||e.key==='D') keyR=false; });

  // ğŸ”§ é€™è£¡å¤§å¹…å¼·åŒ–ã€Œä»»ä½•äº’å‹•éƒ½èƒ½é–‹å§‹ã€
  function tryStart(e){ if(!running){ e?.preventDefault?.(); startGameWithCountdown(); } }
  // æ•´å€‹ç•«å¸ƒå€åŸŸï¼šé»å“ªè£¡éƒ½èƒ½å•Ÿå‹•ï¼ˆé¿å…è¦†è“‹å±¤åè§¸æ§ï¼‰
  overlayEl.addEventListener('pointerdown', tryStart, {passive:false});
  overlayEl.addEventListener('touchstart', tryStart, {passive:false});
  overlayEl.addEventListener('click', tryStart);

  // ä¸­å¤®æç¤ºå±¤æœ¬èº«ä¹Ÿå¯é»æ“Šé–‹å§‹
  centerNote.addEventListener('pointerdown', tryStart, {passive:false});
  centerNote.addEventListener('touchstart', tryStart, {passive:false});
  centerNote.addEventListener('click', tryStart);

  // åŸæœ¬çš„ canvas ç›£è½ï¼Œå¦è£œ pointerdown
  canvas.addEventListener('pointerdown', tryStart, {passive:false});
  canvas.addEventListener('mousemove',(e)=>{
    const rect=canvas.getBoundingClientRect();
    const rx=(e.clientX-rect.left)*(1100/rect.width);
    const ry=(e.clientY-rect.top)*(700/rect.height);
    if(orientation==='bottom'){
      paddle.x=Math.max(0, Math.min(1100-paddle.w, rx - paddle.w/2));
    }else{
      paddle.y=Math.max(12, Math.min(700-12 - paddle.w, ry - paddle.w/2));
    }
  });
  canvas.addEventListener('click',()=>{
    if(!running){ startGameWithCountdown(); return; }
    if(running && !paused){
      let released=false; for(const b of balls){ if(b.stuck){ b.stuck=false; b.vy=-Math.abs(b.vy||6); released=true; } }
      if(released) return;
    }
  });
  canvas.addEventListener('touchstart',(e)=>{ touchActive=true; 
    if(!running){ startGameWithCountdown(); return; }
    if(running && !paused){
      let released=false; for(const b of balls){ if(b.stuck){ b.stuck=false; b.vy=-Math.abs(b.vy||6); released=true; } }
      if(released) return;
    }
  }, {passive:true});
  canvas.addEventListener('touchmove',(e)=>{
    if(!touchActive) return;
    const t=e.touches[0]; const rect=canvas.getBoundingClientRect();
    const rx=(t.clientX-rect.left)*(1100/rect.width);
    const ry=(t.clientY-rect.top)*(700/rect.height);
    if(orientation==='bottom'){
      paddle.x=Math.max(0, Math.min(1100-paddle.w, rx - paddle.w/2));
    }else{
      paddle.y=Math.max(12, Math.min(700-12-paddle.w, ry - paddle.w/2));
    }
  }, {passive:true});
  canvas.addEventListener('touchend',()=>{ touchActive=false; }, {passive:true});
  pauseBtn.addEventListener('click',()=>togglePause()); resetBtn.addEventListener('click',()=>resetGame()); fsBtn.addEventListener('click',()=>toggleFullscreen());
  soundBtn.addEventListener('click',()=>{ soundsOn=!soundsOn; localStorage.setItem('sfx_on', soundsOn?'1':'0'); soundBtn.textContent=`éŸ³æ•ˆï¼š${soundsOn?'é–‹':'é—œ'}`; ensureAudio(); (audioCtx && audioCtx.resume) ? audioCtx.resume() : undefined; beep(880,0.06,0.05); });
  difficultySel.addEventListener('change',()=>{ resetGame(); });
  saveBtn.addEventListener('click',saveProgress); loadBtn.addEventListener('click',loadProgress); clearSaveBtn.addEventListener('click',clearSave);
  tutorBtn.addEventListener('click', ()=> toggleHelp('tutor'));
  effectsBtn.addEventListener('click', ()=> toggleHelp('effects'));
  againBtn.addEventListener('click', ()=>{ win.classList.remove('show'); resetGame(); });

  bgmBtn.addEventListener('click', ()=>{
    bgmOn=!bgmOn; localStorage.setItem('bgm_on', bgmOn?'1':'0'); bgmBtn.textContent= bgmOn?'é–‹':'é—œ';
    if(bgmOn){ ensureAudio(); startBGM(); } else { stopBGM(); }
  });
  bgmVol.addEventListener('input', ()=>{
    ensureAudio(); const v=parseFloat(bgmVol.value||'0.5'); if(bgmGain) bgmGain.gain.value=v; localStorage.setItem('bgm_vol', v);
  });

  function togglePause(){
    if(!running){ startGameWithCountdown(); return; }
    paused=!paused;
    if(paused){ showCenter('å·²æš«åœ','æŒ‰ Space / é»ç•«é¢ç¹¼çºŒ'); }
    else { startCountdown(); }
  }

  function startGameWithCountdown(){
    running=true; paused=true; hideCenter();
    unlockAudio(); ensureAudio(); (audioCtx && audioCtx.resume) ? audioCtx.resume() : undefined;
    soundsOn = (localStorage.getItem('sfx_on')||'0')==='1';
    soundBtn.textContent=`éŸ³æ•ˆï¼š${soundsOn?'é–‹':'é—œ'}`;
    bgmOn = (localStorage.getItem('bgm_on')||'0')==='1';
    const v = parseFloat(localStorage.getItem('bgm_vol')||'0.5'); bgmVol.value=String(v); ensureAudio(); if(bgmGain) bgmGain.gain.value=v;
    bgmBtn.textContent = bgmOn?'é–‹':'é—œ';
    if(bgmOn) startBGM();
    startCountdown();
  }

  // === æ•™å­¸/æ•ˆæœèªªæ˜ ===
  let helpMode=null;
  function toggleHelp(mode){
    if(helpMode===mode){ helpMode=null; hideCenter(); if(!running){ startCountdown(); } return; }
    helpMode=mode; paused=true;
    if(mode==='tutor'){
      showCenter('æ•™å­¸ï¼ˆæŒ‰éˆ•å†æŒ‰ä¸€æ¬¡é—œé–‰ï¼‰', `
        <div class="cols">
          <div>
            <strong>æ“ä½œ</strong><br>
            é›»è…¦ï¼š<kbd>â†</kbd>/<kbd>â†’</kbd> æˆ– <kbd>A</kbd>/<kbd>D</kbd>ï¼›<kbd>Space</kbd> é–‹å§‹/æš«åœã€‚<br>
            é‡‹æ”¾é»ä½çš„çƒï¼š<kbd>â†‘</kbd> æˆ– <kbd>Shift</kbd>ã€‚<br>
            æ‰‹æ©Ÿï¼šæ‰‹æŒ‡æ‹–æ›³æ“‹æ¿ä½ç½®å³å¯ã€‚<br>
            å…¨è¢å¹•ï¼š<kbd>F</kbd>ã€‚
          </div>
          <div>
            <strong>ç›®æ¨™</strong><br>
            æ‰“ç ´æ‰€æœ‰å¯ç ´å£ç£šé€²å…¥ä¸‹ä¸€é—œã€‚æ¯ 5 é—œæœ‰ Bossï¼ˆåªæ‰£è¡€ä¸æœƒè¢«ç§’æ®ºï¼‰ã€‚<br>
            ç¬¬ 1~10 é—œèˆ‡ 11~20 é—œæœƒåˆ†åˆ¥é¡¯ç¤ºåŒçµ„ç…§ç‰‡çš„ä¸åŒå¼µï¼Œ20 é—œçµæŸæ’­æ”¾é€šé—œç•«é¢ã€‚
          </div>
          <div>
            <strong>å­˜è®€æª”</strong><br>
            å¯å„²å­˜é—œå¡/åˆ†æ•¸/ç”Ÿå‘½ã€é›£åº¦ã€ç…§ç‰‡é¸æ“‡ã€éŸ³æ•ˆ/BGM è¨­å®šã€‚
          </div>
        </div>`);
    }else{
      let html = '<div class="cols">';
      html += '<div><strong>å¢ç›Š/ç¨€æœ‰</strong><br>';
      for(const k of Object.keys(GAME_CONFIG.powers)){
        const p=GAME_CONFIG.powers[k]; if(p.type==='debuff') continue;
        html += `${badgeIcon(k)} <em>${k}</em>ï¼š${p.label}<br>`;
      }
      html += '</div><div><strong>æ¸›ç›Š</strong><br>';
      for(const k of Object.keys(GAME_CONFIG.powers)){
        const p=GAME_CONFIG.powers[k]; if(p.type!=='debuff') continue;
        html += `${badgeIcon(k)} <em>${k}</em>ï¼š${p.label}<br>`;
      }
      html += '</div><div><strong>ç‰¹æ®Šç£š</strong><br>ä¸å¯ç ´å£ç£šï¼šåªåå½ˆä¸æœƒå£ï¼›<br>ç§»å‹•ç£šï¼šæ°´å¹³ç§»å‹•ï¼›<br>å¼·åå½ˆç£šï¼šåå½ˆæ™‚åŠ é€Ÿæ›´å¼·ï¼›<br>Bossç£šï¼šå¤§å°ºå¯¸ã€åªæ‰£è¡€ï¼Œçˆ†ç‚¸/ç¥è–/é³³å‡°ä¹Ÿä¸æœƒè¢«ç§’æ®ºã€‚</div>`;
      html += '</div>';
      showCenter('æ•ˆæœèªªæ˜ï¼ˆæŒ‰éˆ•å†æŒ‰ä¸€æ¬¡é—œé–‰ï¼‰', html);
    }
  }

  async function toggleFullscreen(){ const elem=document.documentElement; try{ if(!document.fullscreenElement){ await elem.requestFullscreen(); } else { await document.exitFullscreen(); } }catch(e){ console.warn('Fullscreen failed:', e); } }

  // === æ“‹æ¿å¯¬åº¦èˆ‡æ®µè½ ===
  function computePaddleWidth(){
    const now=nowMs(); buffs.LONG.stacks=buffs.LONG.stacks.filter(t=>t>now);
    const longStacks=Math.min(GAME_CONFIG.powers.LONG.stacksMax, buffs.LONG.stacks.length);
    const addLong=longStacks*(GAME_CONFIG.powers.LONG.longPerStackAdd||0);
    const addWide=(effOn('WIDE')?(GAME_CONFIG.powers.WIDE.paddleWidthAdd||0):0);
    const base=getDiff().paddleBaseW;
    let w=Math.min(GAME_CONFIG.caps.paddleMaxW, base+addWide+addLong);
    if(effOn('NARROW')) w*=0.5;
    const center=(orientation==='bottom') ? (paddle.x+paddle.w/2) : (paddle.y+paddle.w/2);
    paddle.w=w;
    if(orientation==='bottom'){
      paddle.x=Math.max(0, Math.min(1100-paddle.w, center - paddle.w/2));
    }else{
      paddle.y=Math.max(12, Math.min(700-12-paddle.w, center - paddle.w/2));
    }
  }
  function paddleSegments(){
    const segs=[];
    if(orientation==='bottom'){
      if(effOn('HOLEPAD')){
        const third=paddle.w/3;
        segs.push({x:paddle.x, y:paddle.y, w:third, h:paddle.h});
        segs.push({x:paddle.x+third*2, y:paddle.y, w:third, h:paddle.h});
      }else{
        segs.push({x:paddle.x, y:paddle.y, w:paddle.w, h:paddle.h});
      }
    }else{
      const padX=40;
      if(effOn('HOLEPAD')){
        const third=paddle.w/3;
        segs.push({x:padX, y:paddle.y, w:paddle.h, h:third});
        segs.push({x:padX, y:paddle.y+third*2, w:paddle.h, h:third});
      }else{
        segs.push({x:padX, y:paddle.y, w:paddle.h, h:paddle.w});
      }
    }
    return segs;
  }
  function paddleCenter(){
    if(orientation==='bottom') return {x:paddle.x+paddle.w/2, y:paddle.y};
    return {x:40+paddle.h, y:paddle.y+paddle.w/2};
  }

  function speedMultiplier(now){
    if(isSuper()) return 1;
    let mul=1.0;
    if(effOn('SLOW')) mul*=(GAME_CONFIG.powers.SLOW.speedMul??1.0);
    if(effOn('FAST')) mul*=(GAME_CONFIG.powers.FAST.globalSpeedMul??1.0);
    if(effOn('WAVY')){ const w=GAME_CONFIG.powers.WAVY.wavy||{amp:0.6,base:1.2,periodMs:200}; const phase=(now-(buffs.WAVY.start||now))/(w.periodMs); mul*=(w.base+w.amp*Math.sin(phase)); }
    if(effOn('INFERNO')) mul*=(GAME_CONFIG.powers.INFERNO.inferno.speedMul);
    if(effOn('MEGA')) mul*=(GAME_CONFIG.powers.MEGA.mega.sMul);
    return mul;
  }
  function ballRadius(b){ return b.r * (effOn('MEGA') ? (GAME_CONFIG.powers.MEGA.mega.rMul||3) : 1); }

  function ledColor(){
    if(isSuper()) return '#ffd94a';
    if(effOn('HOLY')) return '#ffe08a';
    if(effOn('PLASMA')) return '#9fe8ff';
    if(effOn('FREEZE')) return '#cfe9ff';
    if(effOn('RAMPAGE') || effOn('PIERCE')) return '#7fd8ff';
    if(effOn('FAST')) return '#ffb37a';
    if(effOn('WAVY')) return '#ba8fff';
    if(effOn('HOMING')) return '#8ef';
    if(effOn('INFERNO')) return '#a7b';
    return '#8fb3ff';
  }
  function drawBGDecor(){ const w=canvas.width,h=canvas.height; bgTime+=0.003; ctx.save(); ctx.globalAlpha=0.12; ctx.translate(Math.sin(bgTime)*8, Math.cos(bgTime*0.7)*6); const step=40;
    for(let x=0;x<w;x+=step){ ctx.fillStyle='rgba(255,255,255,.03)'; ctx.fillRect(x,0,1,h);} for(let y=0;y<h;y+=step){ ctx.fillStyle='rgba(255,255,255,.025)'; ctx.fillRect(0,y,w,1);} ctx.restore();
    const grad=ctx.createRadialGradient(w/2,h*0.2,0,w/2,h*0.5,Math.max(w,h)); grad.addColorStop(0,'rgba(0,0,0,0)'); grad.addColorStop(1,'rgba(0,0,0,0.35)'); ctx.fillStyle=grad; ctx.fillRect(0,0,w,h);
    if(effOn('SLOW')){ ctx.fillStyle='rgba(80,140,255,0.08)'; ctx.fillRect(0,0,w,h); }
    for(let i=fireBursts.length-1;i>=0;i--){ const f=fireBursts[i]; f.life-=16; if(f.life<=0){ fireBursts.splice(i,1); continue; } const a=Math.min(1, f.life/600); const rx= (f.x*scaleX), ry=(f.y*scaleY); const r=60*((scaleX+scaleY)/2); const g=ctx.createRadialGradient(rx,ry,1,rx,ry,r); g.addColorStop(0,`rgba(255,180,0,${0.6*a})`); g.addColorStop(1,'rgba(255,100,0,0)'); ctx.fillStyle=g; ctx.beginPath(); ctx.arc(rx,ry,r,0,Math.PI*2); ctx.fill(); }
    const c=ledColor(); ctx.save(); ctx.globalAlpha=0.9; ctx.strokeStyle=c; ctx.lineWidth=6; ctx.shadowColor=c; ctx.shadowBlur=25; ctx.strokeRect(4,4,canvas.width-8,canvas.height-8); ctx.restore();
  }

  function drawRevealTiles(){ const img=getLevelImage(level); if(!img || !(img.naturalWidth>0 && img.naturalHeight>0)) return; const L=layout();
    const area={x:L.pad,y:L.top,w:1100-L.pad*2,h:L.rows*(brickH+L.pad)-L.pad}; const rImg=img.naturalWidth/img.naturalHeight; const rArea=area.w/area.h; let dw,dh;
    if(rImg>rArea){ dh=area.h; dw=dh*rImg; } else { dw=area.w; dh=dw/rImg; } const dx=area.x+(area.w-dw)/2; const dy=area.y+(area.h-dh)/2;
    for(const r of revealRects){
      let sx=(r.x-dx)/dw*img.naturalWidth;
      let sy=(r.y-dy)/dh*img.naturalHeight;
      let sw=r.w/dw*img.naturalWidth;
      let sh=r.h/dh*img.naturalHeight;
      const sx0=Math.max(0, Math.min(img.naturalWidth, sx));
      const sy0=Math.max(0, Math.min(img.naturalHeight, sy));
      const sw0=Math.max(0, Math.min(img.naturalWidth - sx0, sw));
      const sh0=Math.max(0, Math.min(img.naturalHeight - sy0, sh));
      if(sw0>0 && sh0>0){ ctx.drawImage(img, sx0,sy0,sw0,sh0, r.x*scaleX, r.y*scaleY, r.w*scaleX, r.h*scaleY); }
    } }

  function drawPlasmas(){ const now=nowMs(); ctx.save(); for(let i=plasmas.length-1;i>=0;i--){ const P=plasmas[i]; P.x+=P.vx; P.y+=P.vy; P.vx*=0.995; P.vy*=0.995; if(now>P.until){ plasmas.splice(i,1); continue; }
      const x=P.x*scaleX, y=P.y*scaleY, r=P.radius*((scaleX+scaleY)/2); const grd=ctx.createRadialGradient(x,y,2,x,y,r); grd.addColorStop(0,'rgba(150,230,255,0.9)'); grd.addColorStop(0.4,'rgba(120,200,255,0.35)'); grd.addColorStop(1,'rgba(120,200,255,0)'); ctx.fillStyle=grd; ctx.beginPath(); ctx.arc(x,y,r,0,Math.PI*2); ctx.fill();
      ctx.strokeStyle='rgba(180,240,255,0.5)'; ctx.lineWidth=2; ctx.beginPath(); ctx.arc(x,y,r*0.7,0,Math.PI*2); ctx.stroke();
      for(let j=bricks.length-1;j>=0;j--){ const b=bricks[j]; if(isChained(b)) continue; const bx=b.x+b.w/2, by=b.y+b.h/2; if(Math.hypot(P.x-bx,P.y-by)<=P.radius){
          if(b.unbreakable) continue;
          if(b.boss){ b.hp-=1; if(b.hp<=0){ revealBrickArea(b); bricks.splice(j,1); score+=50; } }
          else { revealBrickArea(b); bricks.splice(j,1); score+=10; }
        }
      }
    } ctx.restore(); }

  function drawHoly(){ const now=nowMs(); for(let i=holyFlashes.length-1;i>=0;i--){ const H=holyFlashes[i]; if(now>H.until){ holyFlashes.splice(i,1); continue; } const a=Math.max(0, (H.until-now)/300); ctx.save(); ctx.globalCompositeOperation='lighter'; ctx.strokeStyle=`rgba(255,240,180,${0.6*a})`; ctx.lineWidth=4;
      ctx.beginPath(); ctx.moveTo(0, H.y*scaleY); ctx.lineTo(canvas.width, H.y*scaleY); ctx.stroke();
      ctx.beginPath(); ctx.moveTo(H.x*scaleX, 0); ctx.lineTo(H.x*scaleX, canvas.height); ctx.stroke(); ctx.restore(); } }

  function drawPhoenix(){ if(!phoenixAnim) return; const now=nowMs(); const t=phoenixAnim; const prog=1-Math.max(0,(t.tEnd-now)/1200); const logicW=1100; const xLogic=(1-prog)*(logicW+200)-200; const x=xLogic*scaleX;
    ctx.save(); ctx.globalCompositeOperation='lighter';
    const grad=ctx.createLinearGradient((x+120),220*scaleY,x,260*scaleY); grad.addColorStop(0,'rgba(255,180,0,0.9)'); grad.addColorStop(1,'rgba(255,100,0,0)'); ctx.fillStyle=grad;
    ctx.beginPath(); ctx.moveTo((x+180), 220*scaleY); ctx.quadraticCurveTo((x+60), 180*scaleY, (x), 230*scaleY); ctx.quadraticCurveTo((x-40), 260*scaleY, (x+120), 260*scaleY); ctx.closePath(); ctx.fill();
    for(let i=0;i<3;i++){ fireBursts.push({x:(x-40)+Math.random()*120,y:220+Math.random()*60,life:300+Math.random()*400}); }
    ctx.restore(); if(now>=t.tEnd) phoenixAnim=null; }

  function drawBlackHoles(){
    const now=nowMs();
    for(let i=blackHoles.length-1;i>=0;i--){
      const bh=blackHoles[i];
      const t=(bh.until - now)/GAME_CONFIG.powers.INFERNO.inferno.blackholeMs;
      if(t<=0){ blackHoles.splice(i,1); continue; }
      const x=bh.x*scaleX, y=bh.y*scaleY, r=50*((scaleX+scaleY)/2)*(0.8+0.2*Math.sin(now/120));
      const g=ctx.createRadialGradient(x,y,2,x,y,r);
      g.addColorStop(0,`rgba(10,10,20,${0.8*t})`);
      g.addColorStop(0.7,`rgba(40,10,60,${0.25*t})`);
      g.addColorStop(1,'rgba(0,0,0,0)');
      ctx.beginPath(); ctx.fillStyle=g; ctx.arc(x,y,r,0,Math.PI*2); ctx.fill();
    }
  }

  function drawMissiles(){
    const now=nowMs();
    for(let i=missiles.length-1;i>=0;i--){
      const m=missiles[i];
      if(!bricks.length){ missiles.splice(i,1); continue; }
      let tgt = bricks.find(b=>!b.unbreakable && !isChained(b) && b.__id===m.targetId);
      if(!tgt){
        let best=null,bestD=1e9;
        for(const b of bricks){ if(b.unbreakable||isChained(b)) continue; const d=Math.hypot((b.x+b.w/2)-m.x,(b.y+b.h/2)-m.y); if(d<bestD){ best=b; bestD=d; } }
        if(!best){ missiles.splice(i,1); continue; }
        m.targetId = (best.__id||(best.__id=Symbol()));
        tgt=best;
      }
      const tx=tgt.x+tgt.w/2, ty=tgt.y+tgt.h/2;
      const dx=tx-m.x, dy=ty-m.y; const ang=Math.atan2(dy,dx);
      const sp=GAME_CONFIG.powers.MISSILE.missile.speed;
      const cur=Math.atan2(m.vy,m.vx); const da=ang-cur;
      const seek=GAME_CONFIG.powers.MISSILE.missile.seek;
      const newAng = cur + Math.max(-seek, Math.min(seek, da));
      m.vx=Math.cos(newAng)*sp; m.vy=Math.sin(newAng)*sp;
      m.x+=m.vx; m.y+=m.vy;
      if(m.x>tx-tgt.w/2-6 && m.x<tx+tgt.w/2+6 && m.y>ty+tgt.h/2-6 && m.y<ty+tgt.h/2+6){
        if(!tgt.unbreakable && !isChained(tgt)){
          if(tgt.boss){ tgt.hp-=1; if(tgt.hp<=0){ revealBrickArea(tgt); bricks.splice(bricks.indexOf(tgt),1); score+=50; } }
          else{ revealBrickArea(tgt); bricks.splice(bricks.indexOf(tgt),1); score+=10; }
        }
        spawnParticles(m.x,m.y,'#ffcc88',16,2.0,3.0,3);
        missiles.splice(i,1); continue;
      }
      ctx.save();
      ctx.translate(m.x*scaleX,m.y*scaleY);
      ctx.rotate(Math.atan2(m.vy,m.vx));
      ctx.fillStyle='rgba(200,200,210,0.95)';
      ctx.beginPath(); ctx.moveTo(10,0); ctx.lineTo(-6,4); ctx.lineTo(-6,-4); ctx.closePath(); ctx.fill();
      const grd=ctx.createLinearGradient(-20,0,4,0); grd.addColorStop(0,'rgba(255,120,30,0)'); grd.addColorStop(1,'rgba(255,140,60,0.8)'); ctx.fillStyle=grd;
      ctx.fillRect(-20,-2,18,4);
      ctx.restore();
      if(now>m.until){ missiles.splice(i,1); }
    }
  }

  function draw(){
    if(screenShake>0){ const s=screenShake*0.6; ctx.save(); ctx.translate((Math.random()-0.5)*s,(Math.random()-0.5)*s); screenShake*=0.9; }
    ctx.clearRect(0,0,canvas.width,canvas.height);
    drawBGDecor();
    drawRevealTiles();

    for(const b of bricks){
      if(b.moving){
        b.x += b.vx;
        if(b.x<8){ b.x=8; b.vx=Math.abs(b.vx); }
        if(b.x+b.w>1100-8){ b.x=1100-8-b.w; b.vx=-Math.abs(b.vx); }
      }
      let base = b.boss ? '#ff4d6d' : b.unbreakable ? '#888' : b.strong ? '#bb7aff' : b.moving ? '#6ec6ff' : b.explosive ? getVar('--expl') : brickColor(b.colorIdx);
      const g=ctx.createLinearGradient((b.x)*scaleX,(b.y)*scaleY,(b.x)*scaleX,(b.y+b.h)*scaleY); g.addColorStop(0,base); g.addColorStop(1,'#1a1f3a'); ctx.fillStyle=g; drawRoundedRect(b.x,b.y,b.w,b.h,6); ctx.fill();
      if(isChained(b)){
        ctx.strokeStyle='rgba(150,80,200,0.75)'; ctx.lineWidth=3;
        ctx.beginPath(); ctx.moveTo((b.x+4)*scaleX,(b.y+4)*scaleY); ctx.lineTo((b.x+b.w-4)*scaleX,(b.y+b.h-4)*scaleY); ctx.stroke();
        ctx.beginPath(); ctx.moveTo((b.x+b.w-4)*scaleX,(b.y+4)*scaleY); ctx.lineTo((b.x+4)*scaleX,(b.y+b.h-4)*scaleY); ctx.stroke();
      }
      if(b.boss){
        ctx.fillStyle='rgba(0,0,0,.35)'; ctx.fillRect((b.x+6)*scaleX,(b.y+b.h-6)*scaleY,(b.w-12)*scaleX,4*scaleY);
        const ratio=Math.max(0, b.hp/40); ctx.fillStyle='rgba(255,220,220,.9)'; ctx.fillRect((b.x+6)*scaleX,(b.y+b.h-6)*scaleY,(b.w-12)*ratio*scaleX,4*scaleY);
        ctx.fillStyle='rgba(255,255,255,.85)'; ctx.font=`${Math.max(10,Math.round(18*scaleY))}px system-ui, sans-serif`; ctx.textAlign='center'; ctx.textBaseline='middle';
        ctx.fillText(b.face, (b.x+b.w/2)*scaleX, (b.y+b.h/2)*scaleY);
      }else if(b.hp>1 && b.hp<99 && b.hp<Infinity){
        ctx.fillStyle='rgba(0,0,0,.25)'; ctx.fillRect((b.x+4)*scaleX,(b.y+b.h-6)*scaleY,(b.w-8)*scaleX,4*scaleY);
        ctx.fillStyle='rgba(255,255,255,.75)'; const ratio=Math.max(0,(b.hp-1))/3; ctx.fillRect((b.x+4)*scaleX,(b.y+b.h-6)*scaleY,(b.w-8)*ratio*scaleX,4*scaleY);
      }
    }

    drawPlasmas(); drawHoly(); drawPhoenix(); drawBlackHoles(); drawMissiles();

    const segs=paddleSegments();
    const padGlow=isSuper()?'rgba(255,230,120,.65)': (effOn('STICKY')?'rgba(120,230,220,.6)':((effOn('WIDE')||buffs.LONG.stacks.length)?'rgba(120,170,255,.6)':'rgba(200,210,255,.4)'));
    ctx.shadowColor=padGlow; ctx.shadowBlur=20;
    for(const s of segs){ drawRoundedRect(s.x,s.y,s.w,s.h,8); ctx.fillStyle='#9aaeff'; ctx.fill(); }
    ctx.shadowBlur=0;
    if(effOn('SHIELD')){ const g=ctx.createLinearGradient(0,(700-10)*scaleY,0,700*scaleY); g.addColorStop(0,'rgba(120,220,255,0.35)'); g.addColorStop(1,'rgba(120,220,255,0.05)'); ctx.fillStyle=g;
      if(orientation==='bottom'){ ctx.fillRect(0,(700-10)*scaleY,canvas.width,10*scaleY); }
      else { ctx.fillRect(0,0,10*scaleX,canvas.height); }
    }

    const nowT=nowMs();
    for(const b of balls){
      b.trail.push({x:b.x,y:b.y,t:nowT}); while(b.trail.length>12) b.trail.shift();
      for(let i=b.trail.length-1;i>=0;i--){ const p=b.trail[i]; const age=(nowT-p.t)/200; if(age>1) continue; const alpha=(1-age)*0.6;
        let color=( (b.rampageUntil&&nowT<b.rampageUntil)||b.piercing )?`rgba(120,220,255,${alpha})`:(effOn('FAST')?`rgba(255,140,90,${alpha})`:`rgba(255,255,255,${alpha*0.6})`);
        if(effOn('PLASMA')) color=`rgba(160,240,255,${alpha})`;
        if(effOn('FREEZE')) color=`rgba(200,230,255,${alpha})`;
        if(effOn('HOLY')) color=`rgba(255,240,180,${alpha})`;
        if(effOn('HOMING')) color=`rgba(${200+55*Math.sin(i)},${160+60*Math.sin(i*1.6)},255,${alpha})`;
        if(effOn('INFERNO')) color=`rgba(120,90,140,${alpha})`;
        if(isSuper()) color=`rgba(255,220,100,${alpha})`;
        ctx.fillStyle=color; ctx.beginPath(); ctx.arc(p.x*scaleX,p.y*scaleY,(ballRadius(b)*0.7)*((scaleX+scaleY)/2),0,Math.PI*2); ctx.fill();
      }
      const bx=b.x*scaleX, by=b.y*scaleY, br=ballRadius(b)*((scaleX+scaleY)/2); const grad=ctx.createRadialGradient(bx-3,by-4,2,bx,by,br);
      let edge=(b.piercing||(b.rampageUntil&&nowT<b.rampageUntil))?'#9ff':(effOn('FAST')?'#ff9a66':'#cbd4ff');
      if(effOn('PLASMA')) edge='#aff'; if(effOn('FREEZE')) edge='#e8f8ff'; if(effOn('HOLY')) edge='#fff0a0'; if(effOn('INFERNO')) edge='#b79ad9'; if(isSuper()) edge='#ffd84a';
      grad.addColorStop(0,'#fff'); grad.addColorStop(1, edge); ctx.fillStyle=grad; ctx.beginPath(); ctx.arc(bx,by,br,0,Math.PI*2); ctx.fill();
      if(effOn('WAVY')){ ctx.strokeStyle='rgba(255,255,255,0.15)'; ctx.lineWidth=1; const r1=br+2+2*Math.sin((nowT/100)+b.x*0.02); ctx.beginPath(); ctx.arc(bx,by,r1,0,Math.PI*2); ctx.stroke(); }
      if(b.stuck){
        if(orientation==='bottom') ctx.fillStyle='rgba(255,255,255,0.7)', ctx.fillRect((paddle.x+paddle.w/2-12)*scaleX,(paddle.y-6)*scaleY,24*scaleX,4*scaleY);
        else ctx.fillStyle='rgba(255,255,255,0.7)', ctx.fillRect((40+paddle.h-6)*scaleX,(paddle.y+paddle.w/2-12)*scaleY,4*scaleX,24*scaleY);
      }
    }

    for(const p of powerups) drawPower(p);

    for(let i=particles.length-1;i>=0;i--){ const P=particles[i]; P.x+=P.vx; P.y+=P.vy; P.vx*=0.98; P.vy*=0.98; P.life-=16; if(P.life<=0){ particles.splice(i,1); continue; }
      const a=Math.max(0, Math.min(1, P.life/500)); ctx.fillStyle=P.color||`rgba(255,220,180,${a*0.6})`; ctx.beginPath(); ctx.arc(P.x*scaleX,P.y*scaleY,P.size*((scaleX+scaleY)/2),0,Math.PI*2); ctx.fill(); }

    if(countdownShow>0){
      ctx.save();
      ctx.fillStyle='rgba(0,0,0,0.35)'; ctx.fillRect(0,0,canvas.width,canvas.height);
      ctx.fillStyle='#fff'; ctx.font=`${Math.round(96*((scaleX+scaleY)/2))}px system-ui, sans-serif`; ctx.textAlign='center'; ctx.textBaseline='middle';
      ctx.fillText(String(countdownShow), canvas.width/2, canvas.height/2);
      ctx.restore();
    }
    if(screenShake>0){ ctx.restore(); }
  }

  function speedForLevel(lv){
    const base = getDiff().baseSpeed;
    const t = Math.max(0, Math.min(1, (lv-1)/(GAME_CONFIG.totalLevels-1)));
    const ease = t<0.5 ? 2*t*t : 1 - Math.pow(-2*t+2, 2)/2;
    const extra = 0.6 + 2.6 * ease;
    return base + extra;
  }

  function resetBalls(center=true){
    balls=[makeBall()]; const speed=speedForLevel(level);
    const angle=(-60-Math.random()*60)*Math.PI/180;
    balls[0].x=center?1100/2:paddle.x+paddle.w/2; balls[0].y=700-70;
    balls[0].vx=Math.cos(angle)*speed; balls[0].vy=Math.sin(angle)*speed; balls[0].piercing=effOn('PIERCE');
  }

  function startCountdown(){
    paused=true; countdownShow=3; showCenter('', ''); centerNote.style.display='none';
    resumePending=true;
    const tick=()=>{
      if(countdownShow<=0){ resumePending=false; paused=false; return; }
      try{beep(600 + (3-countdownShow)*100, 0.07, 0.05);}catch{}
      setTimeout(()=>{ countdownShow--; if(countdownShow===0){ paused=false; } else { tick(); } }, 450);
    };
    tick();
  }

  function aimVec(fromx,fromy,tox,toy,spd){ const ang=Math.atan2(toy-fromy,tox-fromx); return {vx:Math.cos(ang)*spd, vy:Math.sin(ang)*spd}; }
  function pickIsolatedBrick(fromx,fromy){
    if(!bricks.length) return null;
    const L=layout();
    const list=[];
    for(const b of bricks){
      if(b.unbreakable || isChained(b)) continue;
      const {r,c}=gridRCForBrick(b); let neigh=0;
      for(const t of bricks){
        if(t===b) continue; if(t.unbreakable) continue;
        const rc=gridRCForBrick(t);
        if(Math.max(Math.abs(rc.r-r),Math.abs(rc.c-c))<=1) neigh++;
      }
      const d=Math.hypot((b.x+b.w/2)-fromx,(b.y+b.h/2)-fromy);
      list.push({b,neigh,d});
    }
    if(!list.length) return null;
    list.sort((a,b)=> (a.neigh-b.neigh)||(a.d-b.d));
    return list[0].b;
  }
  function paddleBounceSpawnMissiles(ball){
    if(!effOn('MISSILE')) return;
    const cfg=GAME_CONFIG.powers.MISSILE.missile;
    const candidates = bricks.filter(b=>!b.unbreakable && !isChained(b));
    if(candidates.length===0) return;
    const withD=candidates.map(b=>({b,d:Math.hypot(b.x+b.w/2-ball.x,b.y+b.h/2-ball.y)})).sort((a,b)=>a.d-b.d);
    const pickIdxs=[0, Math.floor((withD.length-1)/2), withD.length-1].filter((v,i,arr)=>arr.indexOf(v)===i);
    for(const idx of pickIdxs.slice(0,cfg.count)){
      const b=withD[idx].b; b.__id = b.__id || Symbol();
      missiles.push({x:ball.x, y:ball.y-10, vx:0, vy:-cfg.speed, speed:cfg.speed, until: nowMs()+cfg.lifeMs, targetId:b.__id});
      spawnParticles(ball.x,ball.y,'rgba(255,120,60,0.7)',8,1.6,2.2,2.2);
    }
  }

  function removeBrickImmediate(bk){
    if(bk.unbreakable || isChained(bk)) return;
    if(bk.boss){ bk.hp-=1; if(bk.hp<=0){ revealBrickArea(bk); bricks.splice(bricks.indexOf(bk),1); score+=50; } }
    else{ revealBrickArea(bk); bricks.splice(bricks.indexOf(bk),1); score+=10; }
  }

  function infernoBlackholeAt(brick){
    const centerX=brick.x+brick.w/2, centerY=brick.y+brick.h/2;
    blackHoles.push({x:centerX,y:centerY,until:nowMs()+GAME_CONFIG.powers.INFERNO.inferno.blackholeMs});
    const {r,c}=gridRCForBrick(brick);
    const victims=[];
    for(const t of bricks){
      const rc=gridRCForBrick(t);
      if(Math.max(Math.abs(rc.r-r),Math.abs(rc.c-c))<=1){ victims.push(t); }
    }
    for(const v of victims){ removeBrickImmediate(v); }
  }

  function update(){
    const now=nowMs();
    for(const key of Object.keys(GAME_CONFIG.powers)){
      if(key==='LONG') continue; 
      const b=buffs[key];
      if(b?.active && b.until && now>b.until){
        b.active=false;
        if(key==='PIERCE'){ for(const ball of balls) ball.piercing=false; }
        if(key==='STICKY'){ for(const ball of balls){ if(ball.stuck){ ball.stuck=false; ball.vy = -Math.abs(ball.vy||6); } } }
        if(key==='FLIP'){ if(!isSuper()) orientation='bottom'; paddle.x = Math.max(0, Math.min(1100-paddle.w, paddle.x)); paddle.y=700-50; }
        if(key==='SPEEDGOD'){ orientation = prevOrientationForSuper; }
      }
    }
    computePaddleWidth(); updateBuffBadges();

    if(orientation==='bottom'){ if(keyL) paddle.x-=paddle.speed; if(keyR) paddle.x+=paddle.speed; paddle.x=Math.max(0, Math.min(1100-paddle.w, paddle.x)); }
    else{ if(keyL) paddle.y-=paddle.speed; if(keyR) paddle.y+=paddle.speed; paddle.y=Math.max(12, Math.min(700-12-paddle.w, paddle.y)); }

    const mulGlobal=speedMultiplier(now);
    for(const b of balls){
      const r=ballRadius(b);

      if(b.rampageUntil && now>b.rampageUntil){ b.rampageUntil=0; if(!effOn('PIERCE')) b.piercing=false; }

      if(b.freeze.state==='delay'){ if(now - b.freeze.t0 >= b.freeze.delay){ b.freeze.state = 'stopped'; b.freeze.until = now + b.freeze.stop; b.vx = 0; b.vy = 0; spawnParticles(b.x,b.y,'rgba(230,247,255,0.9)',16,1.2,1.0,2.5); } }
      if(b.freeze.state==='stopped'){ if(now < b.freeze.until){ continue; } else { b.freeze.state='idle'; let vx=b.freeze.oldVX,vy=b.freeze.oldVY; const tiny=Math.abs(vx)+Math.abs(vy) < 0.2;
          if(tiny){ vx = (Math.random()<0.5?-1:1) * 4; vy = -Math.max(4, speedForLevel(level)*0.8); }
          const sp=Math.max(4, Math.hypot(vx, vy)); const ang=Math.atan2(vy, vx); b.vx=Math.cos(ang)*sp; b.vy=Math.sin(ang)*sp; } }

      if(b.stuck){
        if(orientation==='bottom'){ b.x=paddle.x+paddle.w/2+b.offsetX; b.y=paddle.y-r-0.1; }
        else{ b.x=40+paddle.h+r+0.1; b.y=paddle.y+paddle.w/2+b.offsetX; }
        continue;
      }

      b.x+=b.vx*mulGlobal; b.y+=b.vy*mulGlobal;

      if(orientation==='bottom'){
        if(b.x-r<0){ b.x=r; b.vx*=-1; beep(780,0.03); spawnParticles(b.x,b.y,'rgba(153,187,255,.8)',5,1.2,1.2,2); }
        if(b.x+r>1100){ b.x=1100-r; b.vx*=-1; beep(780,0.03); spawnParticles(b.x,b.y,'rgba(153,187,255,.8)',5,1.2,1.2,2); }
        if(b.y-r<0){ b.y=r; b.vy*=-1; beep(700,0.03); spawnParticles(b.x,b.y,'rgba(153,187,255,.8)',5,1.2,1.2,2); }
        if(b.y-r>700){
          if(isSuper() || effOn('SPEEDGOD')){ b.y=700-r; b.vy=-Math.abs(b.vy); }
          else if(effOn('SHIELD')){ buffs.SHIELD.active=false; b.y=700-r-1; b.vy=-Math.abs(b.vy); }
          else { const idx=balls.indexOf(b); if(idx>=0) balls.splice(idx,1); break; }
        }
      }else{
        if(b.y-r<0){ b.y=r; b.vy*=-1; beep(700,0.03); spawnParticles(b.x,b.y,'rgba(153,187,255,.8)',5,1.2,1.2,2); }
        if(b.y+r>700){ b.y=700-r; b.vy*=-1; beep(700,0.03); spawnParticles(b.x,b.y,'rgba(153,187,255,.8)',5,1.2,1.2,2); }
        if(b.x+r>1100){ b.x=1100-r; b.vx*=-1; beep(780,0.03); spawnParticles(b.x,b.y,'rgba(153,187,255,.8)',5,1.2,1.2,2); }
        if(b.x-r<0){
          if(isSuper()){ b.x=r; b.vx=Math.abs(b.vx); }
          else if(effOn('SHIELD')){ buffs.SHIELD.active=false; b.x=r+1; b.vx=Math.abs(b.vx); }
          else { const idx=balls.indexOf(b); if(idx>=0) balls.splice(idx,1); break; }
        }
      }

      const segs=paddleSegments();
      for(const s of segs){
        if(orientation==='bottom'){
          if(b.y+r>=s.y && b.y+r<=s.y+s.h && b.x>=s.x && b.x<=s.x+s.w && b.vy>0){
            const hitPos=(b.x-(s.x+s.w/2))/(s.w/2);
            const sp=Math.min(Math.hypot(b.vx,b.vy)*1.02, b.speedCap);
            const angle=hitPos*(Math.PI/3);
            b.vx=Math.sin(angle)*sp; b.vy=-Math.cos(angle)*sp; b.y=s.y-r-0.1; beep(880,0.03); spawnParticles(b.x,b.y,'#caddff',8,1.3,1.5,2.5);
            if(effOn('STICKY')){ b.stuck=true; b.offsetX=b.x-(s.x+s.w/2); }
            if(effOn('HOMING')){ const t=pickIsolatedBrick(b.x,b.y); if(t){ const v=aimVec(b.x,b.y,t.x+t.w/2,t.y+t.h/2,sp); b.vx=v.vx; b.vy=v.vy; } }
            if(!isSuper()) paddleBounceSpawnMissiles(b);
          }
        }else{
          if(b.x-r<=s.x+s.w && b.x-r>=s.x && b.y>=s.y && b.y<=s.y+s.h && b.vx<0){
            const hitPos=(b.y-(s.y+s.h/2))/(s.h/2);
            const sp=Math.min(Math.hypot(b.vx,b.vy)*1.02, b.speedCap);
            const angle=hitPos*(Math.PI/3);
            b.vx=Math.cos(angle)*sp; b.vy=Math.sin(angle)*sp; b.x=s.x+s.w+r+0.1; beep(880,0.03); spawnParticles(b.x,b.y,'#caddff',8,1.3,1.5,2.5);
            if(effOn('STICKY')){ b.stuck=true; b.offsetX=b.y-(s.y+s.h/2); }
            if(effOn('HOMING')){ const t=pickIsolatedBrick(b.x,b.y); if(t){ const v=aimVec(b.x,b.y,t.x+t.w/2,t.y+t.h/2,sp); b.vx=v.vx; b.vy=v.vy; } }
            if(!isSuper()) paddleBounceSpawnMissiles(b);
          }
        }
      }

      let hit=-1; for(let i=0;i<bricks.length;i++){ const bk=bricks[i]; if(b.x+r>bk.x && b.x-r<bk.x+bk.w && b.y+r>bk.y && b.y-r<bk.y+bk.h){ hit=i; break; } }
      if(hit>=0){
        const bk=bricks[hit]; const inRampage=b.rampageUntil && now<b.rampageUntil;
        const oL=(b.x+r)-bk.x, oR=(bk.x+bk.w)-(b.x-r), oT=(b.y+r)-bk.y, oB=(bk.y+bk.h)-(b.y-r); const m=Math.min(oL,oR,oT,oB);
        if(!inRampage && !b.piercing){
          if(m===oL){ b.x=bk.x-r; b.vx=-Math.abs(b.vx); } else if(m===oR){ b.x=bk.x+bk.w+r; b.vx=Math.abs(b.vx); } else if(m===oT){ b.y=bk.y-r; b.vy=-Math.abs(b.vy); } else { b.y=bk.y+bk.h+r; b.vy=Math.abs(b.vy); }
        }else{
          if(m===oL){ b.x=bk.x-r; b.vx=Math.abs(b.vx)||4; } else if(m===oR){ b.x=bk.x+bk.w+r; b.vx=-Math.abs(b.vx)||-4; } else if(m===oT){ b.y=bk.y-r; b.vy=Math.abs(b.vy)||4; } else { b.y=bk.y+bk.h+r; b.vy=-Math.abs(b.vy)||-4; }
          b.piercing=true;
        }
        if(bk.strong){
          const sp=Math.min(Math.hypot(b.vx,b.vy)*1.08, b.speedCap); const ang=Math.atan2(b.vy,b.vx); b.vx=Math.cos(ang)*sp; b.vy=Math.sin(ang)*sp; screenShake=Math.max(screenShake,3);
        }

        if(effOn('CHAIN')){
          bk.chainUntil = now + GAME_CONFIG.powers.CHAIN.chain.lockMs;
        }

        if(isChained(bk)){
          beep(520,0.02,0.04);
        }else if(!bk.unbreakable){
          if(effOn('PLASMA')){ const cfg=GAME_CONFIG.powers.PLASMA.plasma; const ang=Math.random()*Math.PI*2; plasmas.push({x:bk.x+bk.w/2,y:bk.y+bk.h/2,vx:Math.cos(ang)*cfg.drift,vy:Math.sin(ang)*cfg.drift,until:now+cfg.lifeMs,radius:cfg.radius}); }
          if(effOn('FREEZE') && (b.freeze.state==='idle' || !b.freeze.state)){
            const f=GAME_CONFIG.powers.FREEZE.freeze;
            b.freeze.state='delay'; b.freeze.t0=now; b.freeze.delay=f.delayMs; b.freeze.stop=f.stopMs; b.freeze.oldVX=b.vx; b.freeze.oldVY=b.vy;
          }
          if(effOn('HOLY')){
            holyFlashes.push({x:bk.x+bk.w/2, y:bk.y+bk.h/2, until:now+350});
            for(let i=bricks.length-1;i>=0;i--){ const t=bricks[i]; if(isChained(t)) continue; const sameRow=Math.abs(t.y-bk.y)<1; const sameCol=Math.abs(t.x-bk.x)<1;
              if(sameRow||sameCol){ removeBrickImmediate(t); } }
            screenShake=Math.max(screenShake,4);
          }
          if(effOn('INFERNO')) infernoBlackholeAt(bk);

          if(!isChained(bk)){
            bk.hp=(bk.hp||1)-1; score+=10; updateHUD();
            if(bk.hp<=0){
              const cx=bk.x+bk.w/2, cy=bk.y+bk.h/2;
              revealBrickArea(bk);
              if(Math.random()<dropRateForLevel(level)) spawnPower(cx-12,cy);
              if(bk.explosive){ explodeAt(cx,cy); } else { bricks.splice(hit,1); }
            }
          }
        }

        if(effOn('HOMING')){
          const c=paddleCenter(); const sp=Math.hypot(b.vx,b.vy); const v=aimVec(b.x,b.y,c.x,c.y,sp); b.vx=v.vx; b.vy=v.vy;
        }

        beep(520+Math.random()*200,0.03,0.05);
      }

      if(isSuper()){
        const sp=Math.hypot(b.vx,b.vy);
        const desired=b.speedCap;
        const ang=Math.atan2(b.vy,b.vx);
        b.vx=Math.cos(ang)*desired;
        b.vy=Math.sin(ang)*desired;
      }

      const sp2 = Math.hypot(b.vx,b.vy);
      if(sp2 < 0.2 && !b.stuck && b.freeze.state==='idle'){
        b.vx = (Math.random()<0.5?-1:1) * 4;
        b.vy = -Math.max(4, speedForLevel(level)*0.8);
      }
    }

    if(balls.length===0){
      lives--; updateHUD();
      if(lives<=0){ running=false; paused=true; showCenter('éŠæˆ²çµæŸ', `åˆ†æ•¸ï¼š${score}<br>æŒ‰ Space æˆ–é»ç•«é¢å†ä¾†ä¸€å±€ï¼Œæˆ–æŒ‰ R é‡é–‹ã€‚`); return; }
      else { resetBalls(false); startCountdown(); return; }
    }

    for(let i=powerups.length-1;i>=0;i--){ const p=powerups[i]; p.y+=p.vy;
      const segs=paddleSegments(); let catched=false;
      for(const s of segs){
        if(p.y+p.h>=s.y && p.x+p.w>=s.x && p.x<=s.x+s.w && p.y<=s.y+s.h){ catched=true; break; }
      }
      if(catched){ applyPower(p.type); powerups.splice(i,1); continue; }
      if(p.y>710) powerups.splice(i,1);
    }

    if(!hasBreakables()){
      paused=true; running=false;
      if(level>=GAME_CONFIG.totalLevels){
        finalScore.textContent=String(score);
        ring.innerHTML='';
        for(let i=1;i<=GAME_CONFIG.totalLevels;i++){
          const im=getLevelImage(i);
          const th=document.createElement('img'); th.src=im.src; ring.appendChild(th);
        }
        win.classList.add('show');
        ensureAudio(); if(audioCtx){ const o=audioCtx.createOscillator(); const g=audioCtx.createGain(); o.type='triangle'; o.frequency.setValueAtTime(659, audioCtx.currentTime); g.gain.value=0.04; o.connect(g); g.connect(audioCtx.destination); o.start(); setTimeout(()=>{ o.frequency.value=880; }, 200); setTimeout(()=>{ o.stop(); }, 600); }
      }else{
        galleryImg.src=getLevelImage(level).src;
        gallery.style.display='flex'; requestAnimationFrame(()=>gallery.classList.add('show'));
        const proceed=()=>{ gallery.classList.remove('show'); setTimeout(()=>{ gallery.style.display='none'; gallery.removeEventListener('click',proceed); },200); level++; updateHUD(); initBricks(); resetBalls(); paused=true; running=false; showCenter(`é€²å…¥é—œå¡ ${level}`,'æŒ‰ Space æˆ–é»ç•«é¢é–‹å§‹'); };
        gallery.addEventListener('click',proceed,{once:true}); return;
      }
    }
  }

  function loop(){ if(!paused && running) update(); draw(); requestAnimationFrame(loop); }
  function boot(){
    resetGame(); updateHUD(); loop();
    soundsOn = (localStorage.getItem('sfx_on')||'0')==='1'; soundBtn.textContent=`éŸ³æ•ˆï¼š${soundsOn?'é–‹':'é—œ'}`;
    const v = parseFloat(localStorage.getItem('bgm_vol')||'0.5'); bgmVol.value=String(v);
    bgmOn = (localStorage.getItem('bgm_on')||'0')==='1'; bgmBtn.textContent = bgmOn?'é–‹':'é—œ';
    const raw=localStorage.getItem('breakout_save_v_final_cfg')||localStorage.getItem('breakout_save_v4');
    if(raw){ setTimeout(()=>{ if(!running && confirm('åµæ¸¬åˆ°å­˜æª”ï¼Œè¦è®€å–é€²åº¦å—ï¼Ÿ')) loadProgress(); }, 600); }
  }
  boot();
})();
</script>
</body>
</html>