<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Rock Breakout — 冰雪＋烈焰皮膚 0820</title>
  <!--
    版本說明（0820-火系增補）
    - 在保持既有 UI/HUD/功能 與 冰雪/科技/木紋 Skins 不變的前提下，新增 3 款「烈焰風格」：
      1) 烈焰・龍脈熾光  2) 烈焰・熔岩脈動  3) 烈焰・星火風暴。
    - 新增 Canvas 背景特效：embers（星火飛舞）、heat（熱擾動波）。
    - 不移除任何舊特效；未改動 DOM 結構；僅擴充 CSS Tokens 與 SKINS。
    - Skin 下拉已加入三款火系，切換即生效。
  -->
  <style>
    :root{
      /* 共用設計 Token（各 Skin 會覆蓋） */
      --ink:#eaf2ff; --muted:#b8c7ea;
      --glass-1:rgba(255,255,255,.08); --glass-2:rgba(255,255,255,.06);
      --stroke:rgba(140,180,255,.28);
      --bg1:#13224a; --bg2:#081022;
      --hudGrad1:rgba(20,25,44,.62); --hudGrad2:rgba(12,20,42,.44);
      --stageGlass:linear-gradient(180deg, rgba(255,255,255,.02), rgba(255,255,255,0));
      --panelPattern:none;
      --btnGlow:0 0 0 rgba(0,0,0,0);
      --hudBottom:96px;
      --heartGlow: rgba(0,0,0,0); /* 新增：心形光暈色（依 Skin 覆蓋） */
    }
    html,body{height:100%;margin:0;color:var(--ink);
      background: radial-gradient(140% 140% at 50% -12%, var(--bg1) 0%, #0e1a3a 50%, #0b1633 75%, var(--bg2) 100%);
      font-family: ui-sans-serif, -apple-system, system-ui, "Segoe UI", Roboto, "Noto Sans TC", "PingFang TC", "Microsoft JhengHei", Arial, sans-serif;
      -webkit-font-smoothing: antialiased;
    }
    .wrap{max-width:1200px;margin:0 auto;padding:0 12px 24px}
    header{padding:calc(8px + env(safe-area-inset-top)) 0 10px;display:flex;gap:8px;align-items:center;flex-wrap:wrap;justify-content:space-between}
    h1{font-size:clamp(16px,2.6vw,22px);margin:0 8px 0 0;letter-spacing:.4px;opacity:.95}
    .small{font-size:12px;color:var(--muted)}

    /* HUD 與 UI：維持結構，僅靠變數換膚 */
    .hud{position:sticky;top:0;z-index:30;display:grid;gap:8px;align-items:center;
      grid-template-columns:1fr;max-width:min(1080px,96vw);margin:8px auto 0;border:1px solid var(--stroke);
      border-radius:18px;padding:10px;background:linear-gradient(180deg,var(--hudGrad1),var(--hudGrad2));
      backdrop-filter: blur(8px);box-shadow:0 6px 28px rgba(0,0,0,.28)}
    .stats{display:grid;grid-template-columns:auto auto 1fr;grid-auto-rows:minmax(36px,auto);gap:8px 10px;align-items:center}
    .stats .wide{grid-column:1 / -1}
    .pill{padding:8px 18px;border:1px solid var(--stroke);background:var(--glass-2);border-radius:999px;min-height:36px;display:flex;align-items:center;gap:10px;color:#d7e3ff;font-weight:650;font-size:15px}
    .pill b{color:#fff;font-variant-numeric:tabular-nums}
    .inline-controls{justify-self:end;display:flex;gap:8px;align-items:center;position:relative}
    .ic-btn{width:48px;height:36px;border-radius:12px;border:1px solid var(--stroke);
      background:radial-gradient(120% 120% at 30% 20%, rgba(255,255,255,.16), rgba(255,255,255,0) 58%), var(--glass-1);
      display:grid;place-items:center;cursor:pointer;box-shadow:inset 0 0 0 1px rgba(255,255,255,.05), 0 8px 20px rgba(0,0,0,.28), var(--btnGlow); color:#fff}
    .ic-btn:active{transform:translateY(1px)}
    .ic-btn .ico{font-size:18px;line-height:1}

    .menu{position:absolute;top:46px;right:0;min-width:280px;padding:10px;border:1px solid var(--stroke);border-radius:14px;background:rgba(12,18,36,.96);backdrop-filter:blur(10px);transform:scale(.96);opacity:0;pointer-events:none;transition:.16s ease;z-index:60}
    .menu.show{transform:scale(1);opacity:1;pointer-events:auto}
    .menu .item{display:flex;align-items:center;gap:10px;padding:10px;border:1px solid var(--stroke);border-radius:10px;background:var(--glass-2);margin-bottom:8px}
    .menu h4{margin:6px 0 8px;font-size:13px;color:#cfe0ff}
    .btn{padding:8px 12px;border-radius:10px;border:1px solid var(--stroke);cursor:pointer;background:var(--glass-2);color:#fff;box-shadow:var(--btnGlow)}

    #buffs{position:sticky;z-index:22;top:calc(var(--hudBottom) + 6px);display:flex;gap:8px;align-items:center;max-width:min(1080px,96vw);margin:6px auto 0;padding-left:6px;overflow:auto;scrollbar-width:none}
    #buffs::-webkit-scrollbar{display:none}
    .chip{display:inline-flex;align-items:center;gap:8px;padding:6px 10px;border:1px solid var(--stroke);border-radius:999px;background:var(--glass-1);font-size:12px;white-space:nowrap;color:#cfe0ff}
    #promptsDock{position:sticky;z-index:20;top:calc(var(--hudBottom) + 48px);max-width:min(1080px,96vw);margin:6px auto 0;padding:0 6px;display:flex;gap:8px;align-items:flex-start;overflow:auto;scrollbar-width:none}
    #promptsDock::-webkit-scrollbar{display:none}
    .prompt{padding:8px 10px;border:1px solid var(--stroke);border-radius:12px;background:rgba(14,22,40,.92);box-shadow:0 10px 26px rgba(0,0,0,.34);font-size:12px;line-height:1.45;color:#eaf2ff;white-space:nowrap}

    .stage{position:relative;margin:12px auto 0;max-width:min(1080px,96vw);border-radius:18px;padding:12px;box-sizing:border-box;background:var(--stageGlass);background-image:var(--panelPattern);background-blend-mode:overlay;}
    canvas#game{background:linear-gradient(180deg,#0d132a,#0b1226 55%, #091223);border:1px solid rgba(80,110,170,.45);border-radius:16px;display:block;width:100%;height:auto;margin:0 auto;box-shadow:inset 0 0 160px rgba(255,255,255,.03), 0 28px 90px rgba(0,0,0,.46)}
    .legend{display:flex;gap:8px;flex-wrap:wrap;align-items:center;justify-content:center;font-size:12px;color:#cfe0ff;margin-top:6px}
    .legend .item{padding:4px 8px;border-radius:10px;background:rgba(255,255,255,.05);border:1px solid var(--stroke)}
    .legend .box{width:14px;height:14px;display:inline-block;border-radius:3px;margin-right:4px;vertical-align:middle}

    .hearts{filter: drop-shadow(0 0 10px var(--heartGlow));}

    @media (max-width:390px){ .pill{font-size:14px;padding:7px 14px} .ic-btn{width:44px;height:36px} }

    /* ======== 既有 Skins（科技/木紋/冰雪） — 內容維持，略去重複註解 ======== */
    body[data-skin="科技感風格2"]{ --ink:#f6fbff; --muted:#dbe6ff; --stroke:rgba(200,220,255,.38); --bg1:#0b0f2a; --bg2:#070a18; --hudGrad1:rgba(24,28,70,.58); --hudGrad2:rgba(16,22,58,.42); --glass-1:rgba(255,255,255,.12); --glass-2:rgba(255,255,255,.09); --stageGlass:linear-gradient(180deg, rgba(255,255,255,.03), rgba(0,0,0,0)); --panelPattern:conic-gradient(from 0deg at 60% 40%, rgba(255,160,220,.08), rgba(160,220,255,.06), rgba(160,255,200,.06), rgba(255,220,160,.06), rgba(255,160,220,.08)); --btnGlow:0 0 20px rgba(160,220,255,.25);}    
    body[data-skin="科技感風格3"]{ --ink:#e7ffe7; --muted:#bdfdcc; --stroke:rgba(120,255,170,.34); --bg1:#081812; --bg2:#03110a; --hudGrad1:rgba(10,40,26,.64); --hudGrad2:rgba(6,28,18,.46); --glass-1:rgba(160,255,200,.12); --glass-2:rgba(120,220,170,.08); --stageGlass:linear-gradient(180deg, rgba(120,255,180,.05), rgba(0,0,0,0)); --panelPattern:repeating-linear-gradient(180deg, rgba(140,255,190,.05) 0 1px, transparent 1px 3px); --btnGlow:0 0 16px rgba(120,255,170,.25);}    
    body[data-skin="科技感風格5"]{ --ink:#eef0ff; --muted:#c9c9ff; --stroke:rgba(160,140,255,.34); --bg1:#0c0b24; --bg2:#09081a; --hudGrad1:rgba(30,24,70,.58); --hudGrad2:rgba(20,18,50,.44); --glass-1:rgba(200,180,255,.10); --glass-2:rgba(160,140,255,.08); --stageGlass:linear-gradient(180deg, rgba(160,140,255,.05), rgba(0,0,0,0)); --panelPattern:radial-gradient(120px 80px at 20% 10%, rgba(110,80,255,.08), transparent 60%), radial-gradient(160px 120px at 80% 20%, rgba(180,100,255,.08), transparent 60%); --btnGlow:0 0 22px rgba(150,120,255,.25);}    
    body[data-skin="木紋-黑檀曜金"]{ --ink:#f6edd8; --muted:#d9caa8; --stroke:rgba(255,220,140,.28); --bg1:#0e0b09; --bg2:#060403; --hudGrad1:rgba(28,18,10,.72); --hudGrad2:rgba(18,12,8,.56); --glass-1:rgba(255,220,140,.10); --glass-2:rgba(255,220,140,.07); --stageGlass:linear-gradient(180deg, rgba(255,220,140,.04), rgba(0,0,0,0)); --panelPattern:repeating-linear-gradient(12deg, rgba(40,28,18,.35) 0 18px, rgba(0,0,0,0) 18px 34px), repeating-linear-gradient(192deg, rgba(60,44,28,.20) 0 12px, rgba(0,0,0,0) 12px 28px); --btnGlow:0 0 20px rgba(255,210,120,.24);}    
    body[data-skin="木紋-白橡北歐"]{ --ink:#fff8ec; --muted:#e6d8c2; --stroke:rgba(255,215,170,.26); --bg1:#3a2d19; --bg2:#1c150b; --hudGrad1:rgba(78,60,30,.66); --hudGrad2:rgba(48,36,18,.50); --glass-1:rgba(255,220,170,.10); --glass-2:rgba(255,220,170,.08); --stageGlass:linear-gradient(180deg, rgba(255,230,190,.05), rgba(0,0,0,0)); --panelPattern:repeating-linear-gradient(8deg, rgba(210,170,120,.14) 0 14px, rgba(0,0,0,0) 14px 26px), repeating-linear-gradient(188deg, rgba(240,210,160,.05) 0 2px, rgba(0,0,0,0) 2px 8px); --btnGlow:0 0 16px rgba(255,220,170,.22);}    
    body[data-skin="冰雪-極光絲綢"]{ --ink:#f6fbff; --muted:#d7e9ff; --stroke:rgba(190,220,255,.38); --bg1:#0b1626; --bg2:#060b14; --hudGrad1:rgba(18,28,60,.56); --hudGrad2:rgba(10,20,44,.42); --glass-1:rgba(220,245,255,.12); --glass-2:rgba(210,235,255,.09); --stageGlass:linear-gradient(180deg, rgba(230,245,255,.04), transparent); --panelPattern:conic-gradient(from 0deg at 60% 40%, rgba(180,220,255,.06), rgba(160,210,255,.05), rgba(180,230,255,.06)); --btnGlow:0 0 20px rgba(180,220,255,.26);}    

    /* ======== 新增：烈焰 Skins（3款） ======== */
    body[data-skin="烈焰-龍脈熾光"]{
      --ink:#fff5e9; --muted:#ffd7b3; --stroke:rgba(255,168,80,.32);
      --bg1:#1a0b06; --bg2:#0b0503;
      --hudGrad1:rgba(48,18,8,.70); --hudGrad2:rgba(28,10,6,.55);
      --glass-1:rgba(255,160,60,.12); --glass-2:rgba(255,140,40,.08);
      --stageGlass:linear-gradient(180deg, rgba(255,160,60,.04), rgba(0,0,0,0));
      --panelPattern:radial-gradient(160px 120px at 20% 10%, rgba(255,120,40,.08), transparent 60%), radial-gradient(200px 160px at 80% 30%, rgba(255,200,120,.06), transparent 60%);
      --btnGlow:0 0 22px rgba(255,120,40,.30);
      --heartGlow:rgba(255,100,20,.75);
    }
    body[data-skin="烈焰-熔岩脈動"]{
      --ink:#fff6ef; --muted:#ffd9c7; --stroke:rgba(255,120,90,.34);
      --bg1:#240b08; --bg2:#0c0504;
      --hudGrad1:rgba(60,20,12,.70); --hudGrad2:rgba(30,10,8,.56);
      --glass-1:rgba(255,110,60,.12); --glass-2:rgba(255,110,60,.08);
      --stageGlass:linear-gradient(180deg, rgba(255,110,60,.04), rgba(0,0,0,0));
      --panelPattern:repeating-linear-gradient(12deg, rgba(255,80,40,.09) 0 2px, transparent 2px 12px);
      --btnGlow:0 0 24px rgba(255,90,60,.32);
      --heartGlow:rgba(255,80,40,.78);
    }
    body[data-skin="烈焰-星火風暴"]{
      --ink:#fff3ec; --muted:#ffd0b8; --stroke:rgba(255,160,120,.30);
      --bg1:#150807; --bg2:#080404;
      --hudGrad1:rgba(40,16,12,.68); --hudGrad2:rgba(22,10,8,.52);
      --glass-1:rgba(255,150,100,.12); --glass-2:rgba(255,130,90,.08);
      --stageGlass:linear-gradient(180deg, rgba(255,140,90,.04), rgba(0,0,0,0));
      --panelPattern:radial-gradient(120px 90px at 30% 20%, rgba(255,120,90,.06), transparent 60%);
      --btnGlow:0 0 22px rgba(255,150,100,.28);
      --heartGlow:rgba(255,110,70,.7);
    }
  </style>
</head>
<body data-skin="經典風格">
  <div class="wrap" id="app">
    <header>
      <h1>Rock打磚塊 — <span id="skinTitle">經典風格</span></h1>
      <span class="small" id="skinDesc">LED：最新版（三側一致深藍，右側鏡像，2s 呼吸）；按鍵配置 0 變更。</span>
    </header>

    <!-- HUD：原樣保留（功能/結構完全不動） -->
    <section class="hud" aria-label="遊戲 HUD">
      <div class="stats">
        <div class="pill">分數 <b id="score">0</b></div>
        <div class="pill">關卡 <b id="level">1</b>/20</div>
        <div class="inline-controls">
          <button class="ic-btn" id="sndBtn" aria-haspopup="true" aria-expanded="false" aria-controls="soundMenu" title="聲音"><span class="ico">🔊</span></button>
          <div class="menu" id="soundMenu">
            <div class="item"><span>🎵</span><label><input type="checkbox" id="bgmOn"> BGM 開關</label></div>
            <div class="item"><span>🎚</span><label style="width:100%">BGM 音量 <input id="bgmVol" type="range" min="0" max="1" step="0.01" value="0.7" style="width:60%" aria-label="BGM 音量"></label></div>
            <div class="item"><span>🔈</span><label><input type="checkbox" id="sfxOn" checked> 音效開關</label></div>
          </div>
          <button class="ic-btn" id="optBtn" aria-haspopup="true" aria-expanded="false" aria-controls="optMenu" title="選項">⋯</button>
          <div class="menu" id="optMenu">
            <h4>遊戲</h4>
            <div class="item"><span>🎮</span>難度 <select id="difficulty" aria-label="難度"><option>簡單</option><option selected>一般</option><option>困難</option></select></div>
            <div class="row" style="display:flex;gap:8px;flex-wrap:wrap"><button class="btn" id="resetBtn">重新開始</button><button class="btn" id="saveBtn">存檔</button><button class="btn" id="loadBtn">讀檔</button></div>
            <h4>其他</h4>
            <div class="row" style="display:flex;gap:8px;flex-wrap:wrap"><button class="btn" id="fsBtn">全螢幕</button><button class="btn" id="tutorBtn">教學</button><button class="btn" id="effectsBtn">效果說明</button><button class="btn" id="galleryBtn">畫廊</button><button class="btn" id="rankBtn">排行榜</button></div>
            <div class="item"><span>🎨</span>Skin <select aria-label="Skin" id="skinSel"><option>冷藍玻璃</option></select></div>
          </div>
        </div>
        <div class="pill wide">生命 <b id="lives">3</b> <span class="hearts" aria-hidden="true">❤️❤️❤️</span></div>
      </div>
    </section>
    <div class="hud-sentinel" style="height:0"></div>

    <div id="buffs" aria-live="polite"></div>
    <div id="promptsDock" aria-live="polite" aria-label="提示卡"></div>

    <div class="stage">
      <canvas id="game" width="1100" height="700" aria-label="遊戲畫面"></canvas>
      <div class="legend">
        <span class="item"><span class="box" style="background:#ffd166"></span>一般磚</span>
        <span class="item"><span class="box" style="background:#888"></span>不可破壞磚</span>
        <span class="item"><span class="box" style="background:#bb7aff"></span>強反彈磚</span>
        <span class="item"><span class="box" style="background:#6ec6ff"></span>移動磚</span>
      </div>
    </div>
  </div>

  <script>
  "use strict";
  /* ---------------- HUD 互動（原樣） ---------------- */
  (function(){
    const hud = document.querySelector('.hud');
    const sentinel = document.querySelector('.hud-sentinel');
    const sndBtn = document.getElementById('sndBtn');
    const optBtn = document.getElementById('optBtn');
    const soundMenu = document.getElementById('soundMenu');
    const optMenu = document.getElementById('optMenu');
    let scheduled=false;
    function schedule(){ if(scheduled) return; scheduled=true; requestAnimationFrame(()=>{ scheduled=false; placeHUD(); }); }
    function placeHUD(){ const rect = (sentinel||hud).getBoundingClientRect(); const top = Math.max(0, Math.ceil(rect.top)) + 6; document.documentElement.style.setProperty('--hudBottom', top + 'px'); }
    function toggle(menu, btn){ const show = !menu.classList.contains('show'); [soundMenu,optMenu].forEach(m=>m.classList.remove('show')); document.querySelectorAll('[aria-expanded="true"]').forEach(b=>b.setAttribute('aria-expanded','false')); if(show){ menu.classList.add('show'); btn.setAttribute('aria-expanded','true'); } schedule(); }
    sndBtn.addEventListener('click', (e)=>{ e.stopPropagation(); toggle(soundMenu, sndBtn); }, {passive:true});
    optBtn.addEventListener('click', (e)=>{ e.stopPropagation(); toggle(optMenu, optBtn); }, {passive:true});
    document.addEventListener('click', (e)=>{ if(!e.target.closest('.menu') && !e.target.closest('#optBtn') && !e.target.closest('#sndBtn')){ [soundMenu,optMenu].forEach(m=>m.classList.remove('show')); schedule(); } }, {passive:true});
    ['resize','orientationchange'].forEach(ev=>window.addEventListener(ev, schedule, {passive:true}));
    if(document.fonts && document.fonts.ready){ document.fonts.ready.then(schedule); }
    schedule();
  })();

  /* ---------------- Canvas Renderer（擴充：embers/heat） ---------------- */
  (function(){
    const cv  = document.getElementById('game');
    const box = document.querySelector('.stage');
    const ctx = cv.getContext('2d');

    let W=0,H=0,dpr=1, rafId=0;
    let skin = { base:[92,136,255], hi:[255,255,255], period:2000, effects:{}, bg:null };

    // 既有狀態（木紋/星點/冰雪/冰裂）
    let woodPattern=null, woodKind=null;
    let stars=null, starOpts={}, starSizeKey='';
    let snows=null, snowOpts={}, snowKey='';
    let shards=null, shardOpts={}, shardKey='';

    \1

    // 新增：火龍（dragons）與火焰龍捲（tornado）
    let dragons=null, dragonOpts={}, dragonKey='';
    let tornado=null, tornadoOpts={}, tornadoKey='';

    const rgba = (rgb,a)=>`rgba(${rgb[0]},${rgb[1]},${rgb[2]},${a.toFixed(3)})`;
    function hslToRgb(h,s,l){ s/=100; l/=100; const k=n=> (n+ h/30)%12; const a=s*Math.min(l,1-l); const f=n=> l - a*Math.max(-1, Math.min(k(n)-3, Math.min(9-k(n),1))); return [Math.round(255*f(0)),Math.round(255*f(8)),Math.round(255*f(4))]; }
    function mix(a,b,w){ return [ Math.round(a[0]*(1-w)+b[0]*w), Math.round(a[1]*(1-w)+b[1]*w), Math.round(a[2]*(1-w)+b[2]*w) ]; }
    const easeOutQuad = x=>1-(1-x)*(1-x);

    function resize(){
      const contentW = box.clientWidth; const w = Math.min(1100, contentW);
      const h = Math.round(w * (700/1100));
      dpr = Math.min(window.devicePixelRatio || 1, 2);
      cv.style.width = '100%'; cv.style.height = Math.round(h) + 'px';
      cv.width  = Math.round(w * dpr); cv.height = Math.round(h * dpr);
      W=cv.width;H=cv.height;
      ensureStarsIfNeeded(); ensureSnowIfNeeded(); ensureShardsIfNeeded(); ensureEmbersIfNeeded(); ensureDragonsIfNeeded(); ensureTornadoIfNeeded();
    }

    /* ========= 木紋 ========= */
    function buildWoodPattern(kind){
      const oc = document.createElement('canvas'); const S = 320; oc.width=S; oc.height=S; const c = oc.getContext('2d');
      const presets = { walnut:{ ang:25*Math.PI/180, step:16, line:8, dark:'#3b2517', light:'rgba(156,106,62,0.12)', rings:'#6e4a2e' }, ebony:{ ang:12*Math.PI/180, step:18, line:9, dark:'#120d0a', light:'rgba(80,65,50,0.10)',  rings:'#3c2b1e' }, cherry:{ ang:160*Math.PI/180,step:14, line:7, dark:'#5a2c33', light:'rgba(162,90,102,0.12)',rings:'#a8616f' }, oak:{ ang:8*Math.PI/180,  step:18, line:7, dark:'#6c5432', light:'rgba(182,138,84,0.12)', rings:'#a07a45' } };
      const p = presets[kind] || presets.walnut; const S2=S; c.clearRect(0,0,S2,S2);
      c.save(); c.translate(S2/2,S2/2); c.rotate(p.ang); c.translate(-S2/2,-S2/2);
      c.fillStyle=p.light; for(let x=-S2; x<=S2*2; x+=p.step){ c.fillRect(x,0,p.line,S2); }
      c.globalAlpha=0.25; c.fillStyle=p.dark; for(let x=-S2; x<=S2*2; x+=p.step*3){ c.fillRect(x,0,Math.max(1,p.line-4),S2); } c.restore();
      c.globalAlpha=0.06; c.strokeStyle=p.rings; c.lineWidth=2; const cx=S2*0.32, cy=S2*0.42;
      for(let r=28;r<S2*0.9;r+=22){ c.beginPath(); c.ellipse(cx,cy,r, r*(0.82+0.06*Math.sin(r)), 0, 0, Math.PI*2); c.stroke(); }
      c.globalAlpha=0.04; c.fillStyle='#000'; for(let i=0;i<80;i++){ const sx=Math.random()*S2, sy=Math.random()*S2, w=2+Math.random()*4, h=1+Math.random()*2; c.beginPath(); c.ellipse(sx,sy,w,h,Math.random()*Math.PI,0,Math.PI*2); c.fill(); }
      woodPattern = ctx.createPattern(oc,'repeat'); woodKind = kind;
    }

    /* ========= 星點 ========= */
    function buildStars(){
      const baseCount = 140; const scale = (W*H)/(1100*700); const countScale = (starOpts.countScale||1);
      const N = Math.max(60, Math.floor(baseCount*scale*countScale));
      stars = new Array(N).fill(0).map(()=>({ x:Math.random()*W, y:Math.random()*H, r:(starOpts.sizeMin||0.9)+Math.random()*((starOpts.sizeMax||1.8)-(starOpts.sizeMin||0.9)), a:0.05+Math.random()*0.12, ph:Math.random()*Math.PI*2, sp:0.6+Math.random()*1.2, px:0.3+Math.random()*0.7 }));
      starSizeKey = W+'x'+H;
    }
    function ensureStarsIfNeeded(){ if(!(skin.effects && skin.effects.stars)){ stars=null; return; } if(!stars || starSizeKey !== (W+'x'+H)) buildStars(); }
    function drawStarField(t){ if(!stars) return; const tw=(typeof skin.effects.stars==='object' && skin.effects.stars.twinkle!=null)? skin.effects.stars.twinkle : 0.6; const drift=(typeof skin.effects.stars==='object' && skin.effects.stars.drift!=null)? skin.effects.stars.drift : 0.008; const glow=(typeof skin.effects.stars==='object' && skin.effects.stars.glow!=null)? skin.effects.stars.glow : 1.2; const bright=(typeof skin.effects.stars==='object' && skin.effects.stars.brightness!=null)? skin.effects.stars.brightness : 1.0; ctx.save(); ctx.globalCompositeOperation='screen'; for(const s of stars){ const twi=0.5+0.5*Math.sin(t*0.001*s.sp + s.ph); const a=(s.a*(0.55+tw*twi))*bright; const dx=(t*drift*s.px)%(W+20); const x=(s.x+dx), y=s.y, r=s.r*dpr*glow; const g=ctx.createRadialGradient(x,y,0,x,y,r); g.addColorStop(0,`rgba(255,255,255,${(a*1.5).toFixed(3)})`); g.addColorStop(1,'rgba(180,160,255,0)'); ctx.fillStyle=g; ctx.beginPath(); ctx.arc(x,y,r,0,Math.PI*2); ctx.fill(); } ctx.restore(); }

    /* ========= 冰雪 ========= */
    function ensureSnowIfNeeded(){ if(!(skin.effects && skin.effects.snow)){ snows=null; snowOpts={}; return; } const o=typeof skin.effects.snow==='object'? skin.effects.snow : {}; const density=Math.max(40, o.count || Math.round((W*H)/(420*420)*(o.countScale||120))); const key=[W,H,density,o.gust||0,o.twinkle?1:0,o.sizeMin||1,o.sizeMax||3].join('x'); if(snows && snowKey===key) return; snowKey=key; snows=new Array(density).fill(0).map(()=>{ const size=(o.sizeMin||1)+Math.random()*((o.sizeMax||3)-(o.sizeMin||1)); return {x:Math.random()*W,y:Math.random()*H,size, baseX:Math.random()*W, speed:(o.speed||0.25)+Math.random()*((o.speedMax||0.9)-(o.speed||0.25)), sway:(o.sway||0.8)*(0.5+Math.random()), phase:Math.random()*Math.PI*2, twinkle:!!o.twinkle && Math.random()<0.25}; }); snowOpts=o; }
    function drawSnow(t){ if(!snows) return; const tt=t*0.001, gust=snowOpts.gust||0; const aBase=Math.min(.22, .10 + .12*(Math.sin(tt*0.6+1.7)*.5+.5)); const glow=Math.min(.14, .06 + .08*(Math.sin(tt*0.8+0.4)*.5+.5)); for(const f of snows){ f.phase += 0.01 + gust*0.015; f.y += f.speed * (1 + 0.6*Math.sin(tt*0.9)); f.x = f.baseX + Math.sin(f.phase)*(f.sway*4 + gust*24); if(f.y>H+10){ f.y=-10; f.baseX=Math.random()*W; } if(f.x<-10){ f.baseX=W+10; } const a=aBase*(f.twinkle?(0.7+0.3*Math.sin(tt*6+f.phase)):1); ctx.save(); ctx.globalAlpha=a; ctx.beginPath(); ctx.arc(f.x,f.y,f.size*dpr,0,Math.PI*2); ctx.fillStyle='white'; ctx.fill(); if(glow>0){ const r=(f.size*3+2)*dpr; const g=ctx.createRadialGradient(f.x,f.y,0,f.x,f.y,r); g.addColorStop(0,'rgba(255,255,255,'+glow+')'); g.addColorStop(1,'rgba(255,255,255,0)'); ctx.fillStyle=g; ctx.beginPath(); ctx.arc(f.x,f.y,r,0,Math.PI*2); ctx.fill(); } ctx.restore(); } }

    /* ========= 冰裂 ========= */
    function ensureShardsIfNeeded(){ if(!(skin.effects && skin.effects.shards)){ shards=null; shardOpts={}; return; } const o=typeof skin.effects.shards==='object'? skin.effects.shards : {}; const count=Math.max(6, o.count || Math.round((W+H)/200)); const key=[W,H,count,o.alpha||0.12,o.speed||0.06,o.lenMin||40,o.lenMax||180].join('x'); if(shards && shardKey===key) return; shardKey=key; shards=new Array(count).fill(0).map(()=>{ const len=(o.lenMin||40)+Math.random()*((o.lenMax||180)-(o.lenMin||40)); const angle=(o.angleDeg!==undefined? o.angleDeg : -28)*Math.PI/180; const x=Math.random()*W, y=Math.random()*H; return {x,y,len,angle,width:(o.width||1.2)*dpr,alpha:(o.alpha||0.12),speed:(o.speed||0.06)}; }); shardOpts=o; }
    function drawShards(t){ if(!shards) return; const drift=(shardOpts.drift||0.20); ctx.save(); ctx.globalAlpha=Math.min(.22,(shardOpts.alpha||0.12)); ctx.strokeStyle='rgba(220,245,255,1)'; ctx.lineWidth=Math.max(0.6,(shardOpts.width||1.2)*dpr); for(const s of shards){ s.x += Math.cos(s.angle)*s.speed*60; s.y += Math.sin(s.angle)*s.speed*60 + drift; if(s.x<-50 || s.x>W+50 || s.y<-50 || s.y>H+50){ s.x=Math.random()*W; s.y=-20; } const x2=s.x+Math.cos(s.angle)*s.len, y2=s.y+Math.sin(s.angle)*s.len; ctx.beginPath(); ctx.moveTo(s.x,s.y); ctx.lineTo(x2,y2); ctx.stroke(); } ctx.restore(); }


    /* ========= 新增：火龍（dragons） ========= */
    function ensureDragonsIfNeeded(){
      if(!(skin.effects && skin.effects.dragons)){ dragons=null; dragonOpts={}; return; }
      const o = typeof skin.effects.dragons==='object' ? skin.effects.dragons : {};
      const count = Math.max(1, o.count||1);
      const key = [W,H,count,o.width||14,o.speed||0.0008,o.ampX||0.28,o.ampY||0.16,o.hue||18,o.jitter||0.25].join('x');
      if(dragons && dragonKey===key) return;
      dragonKey = key;
      dragons = new Array(count).fill(0).map((_,i)=>{
        return {
          seed: Math.random()*1000 + i*123.45,
          width: (o.width||14)* (0.85 + Math.random()*0.3),
          speed: o.speed || 0.0008,
          ampX: (o.ampX||0.28),
          ampY: (o.ampY||0.16),
          hue: (o.hue||18) + Math.random()*8,
          jitter: o.jitter||0.25,
          phase: Math.random()*Math.PI*2
        };
      });
      dragonOpts = o;
    }
    function drawDragons(t){
      if(!dragons) return;
      const tt = t;
      const N = 120; // segments per dragon
      ctx.save();
      ctx.globalCompositeOperation='screen';
      for(const d of dragons){
        const baseY = H*0.38;
        const baseX = W*0.5;
        const speed = d.speed;
        for(let i=0;i<N;i++){
          const s = i/(N-1);
          const prog = (tt*speed + d.phase + s*6.0 + d.seed*0.01);
          const x = baseX + Math.sin(prog*1.2)*W*d.ampX*(0.5+0.5*Math.cos(s*Math.PI)) + Math.sin(prog*0.6+d.seed)*W*0.02;
          const y = baseY + Math.cos(prog*1.1)*H*d.ampY*(0.3+0.7*s) + s*H*0.20;
          const r = (d.width*(1.0 - s*0.65))*Math.max(1, dpr);
          const g = ctx.createRadialGradient(x,y,0,x,y,r*3.2);
          const hue = d.hue + 10*(0.5+0.5*Math.sin(prog*0.8));
          const cCore = `hsla(${hue}, 100%, 55%, ${(0.65+0.25*(1-s)).toFixed(3)})`;
          const cMid  = `hsla(${hue+8}, 100%, 50%, 0.18)`;
          g.addColorStop(0.0, cCore);
          g.addColorStop(1.0, cMid);
          ctx.fillStyle = g;
          ctx.beginPath();
          ctx.arc(x,y,r*1.4,0,Math.PI*2);
          ctx.fill();
        }
        // dragon head glow
        const headProg = (tt*speed + d.phase + d.seed*0.01 + 6.0);
        const hx = W*0.5 + Math.sin(headProg*1.2)*W*d.ampX + Math.sin(headProg*0.6+d.seed)*W*0.02;
        const hy = H*0.38 + Math.cos(headProg*1.1)*H*d.ampY + H*0.20;
        const hr = d.width*1.6*Math.max(1,dpr);
        const hg = ctx.createRadialGradient(hx,hy,0,hx,hy,hr*3.6);
        hg.addColorStop(0, 'hsla(20, 100%, 65%, 0.95)');
        hg.addColorStop(1, 'hsla(28, 100%, 45%, 0)');
        ctx.fillStyle = hg;
        ctx.beginPath(); ctx.arc(hx,hy,hr*1.8,0,Math.PI*2); ctx.fill();
      }
      ctx.restore();
    }
    
    /* ========= 新增：火焰龍捲（tornado） ========= */
    function ensureTornadoIfNeeded(){
      if(!(skin.effects && skin.effects.tornado)){ tornado=null; tornadoOpts={}; return; }
      const o = typeof skin.effects.tornado==='object' ? skin.effects.tornado : {};
      const key = [W,H,o.cxFrac||0.5,o.baseRFrac||0.46,o.topRFrac||0.10,o.heightFrac||0.82,o.alpha||0.08,o.bands||5,o.swirl||1.6].join('x');
      if(tornado && tornadoKey===key) return;
      tornadoKey = key;
      tornado = { cx:(o.cxFrac||0.5)*W, baseR: (o.baseRFrac||0.46)*Math.min(W,H), topR:(o.topRFrac||0.10)*Math.min(W,H), height:(o.heightFrac||0.82)*H };
      tornadoOpts = Object.assign({ alpha:0.08, bands:5, swirl:1.6 }, o);
    }
    function drawTornado(t){
      if(!tornado) return;
      const {cx, baseR, topR, height} = tornado;
      const bands = Math.max(3, tornadoOpts.bands||5);
      const layers = 36;
      ctx.save();
      ctx.globalCompositeOperation='screen';
      for(let b=0;b<bands;b++){
        const phase = (t*0.001*(0.3 + 0.15*b) + b*0.8);
        for(let i=0;i<layers;i++){
          const s = i/(layers-1);
          const y = H - s*height;
          const R = baseR*(1-s) + topR*s;
          const theta = phase + s*8.0 + i*0.03*b;
          const x = cx + Math.cos(theta)*R*0.6;
          const r = (8 + 18*(1-s))*Math.max(1,dpr);
          const g = ctx.createRadialGradient(x,y,0,x,y,r*3.5);
          const aCore = (0.25 + 0.4*(1-s))* (tornadoOpts.alpha||0.08);
          g.addColorStop(0, `hsla(20, 100%, 60%, ${aCore.toFixed(3)})`);
          g.addColorStop(1, 'hsla(28, 100%, 45%, 0)');
          ctx.fillStyle = g;
          ctx.beginPath(); ctx.arc(x,y,r*1.4,0,Math.PI*2); ctx.fill();
        }
      }
      ctx.restore();
    }

    /* ========= 新增：星火（embers） ========= */
    function ensureEmbersIfNeeded(){
      if(!(skin.effects && skin.effects.embers)){ embers=null; emberOpts={}; return; }
      const o=typeof skin.effects.embers==='object'? skin.effects.embers : {};
      const base = Math.round((W*H)/(1100*700) * (o.count || 160));
      const key=[W,H,base,o.sizeMin||1.0,o.sizeMax||2.6,o.up||0.35,o.swirl||0.18,o.twinkle?1:0].join('x');
      if(embers && emberKey===key) return; emberKey=key;
      const vortex = (skin.effects && skin.effects.tornado) ? (skin.effects.tornado) : null;
      embers = new Array(base).fill(0).map(()=>{
        const s=(o.sizeMin||1.0)+Math.random()*((o.sizeMax||2.6)-(o.sizeMin||1.0));
        const baseY = H*(0.30 + 0.70*Math.random());
        const baseX = Math.random()*W;
        const p = { x: baseX, y: baseY, vx:(Math.random()-.5)*0.2, vy:-(o.up||0.35)*(0.6+Math.random()*0.8), size:s, hue: 25+Math.random()*20, tw: (!!o.twinkle && Math.random()<0.3), t:Math.random()*Math.PI*2 };
        if(vortex){
          const cx = (vortex.cxFrac||0.5)*W;
          const baseR = (vortex.baseRFrac||0.46)*Math.min(W,H);
          const topR  = (vortex.topRFrac||0.10)*Math.min(W,H);
          const h = 1 - (p.y/H);
          const R = baseR*(1-h) + topR*h;
          p.theta = Math.random()*Math.PI*2;
          p.rad = R;
          p.cx = cx;
          p.baseR = baseR; p.topR = topR;
          p.vortex = { swirl: vortex.swirl||1.6, heightFrac: vortex.heightFrac||0.82 };
        }
        return p;
      });
      emberOpts=o;
    }
    function drawEmbers(t){ if(!embers) return; const swirl=emberOpts.swirl||0.18; ctx.save(); ctx.globalCompositeOperation='screen';
      for(const p of embers){
        if(p.vortex){
          const h = 1 - (p.y/H);
          p.rad = p.baseR*(1-h) + p.topR*h;
          p.theta += 0.06 * (p.vortex.swirl||1.6) * (1.0 - h + 0.2);
          p.y += p.vy;
          if(p.y < H*(1 - (p.vortex.heightFrac||0.82))){
            p.y = H + 4;
            p.theta = Math.random()*Math.PI*2;
          }
          p.x = p.cx + Math.cos(p.theta)*p.rad;
        } else {
          p.t += 0.02 + swirl*0.02;
          p.x += p.vx + Math.sin(p.t)*swirl*1.2; p.y += p.vy - Math.cos(p.t)*swirl*0.4;
          if(p.y < -10 || p.x<-10 || p.x>W+10){ p.x=Math.random()*W; p.y=H+10; p.t=Math.random()*Math.PI*2; }
        }
        const r=p.size*dpr*(1 + (p.tw? 0.2*Math.sin(t*0.01+(p.t||p.theta||0)*3):0));
        const g=ctx.createRadialGradient(p.x,p.y,0,p.x,p.y,r*3.2);
        const cCore = `hsla(${p.hue}, 100%, 65%, 0.85)`;
        const cHalo = `hsla(${p.hue+10}, 100%, 50%, 0)`;
        g.addColorStop(0.0, cCore); g.addColorStop(1.0, cHalo);
        ctx.fillStyle=g; ctx.beginPath(); ctx.arc(p.x,p.y,r*1.6,0,Math.PI*2); ctx.fill();
      }
      ctx.restore();
    }

    /* ========= 新增：熱擾動（heat） ========= */
    function drawHeatHaze(t){
      const h = skin.effects && skin.effects.heat; if(!h) return;
      const bands = h.bands || 3; const amp = (h.amplitude||8)*dpr; const speed = h.speed || 0.0007; const alpha = (h.alpha!=null? h.alpha:0.06);
      ctx.save(); ctx.globalCompositeOperation = 'soft-light';
      for(let i=0;i<bands;i++){
        const y0 = H*(0.25 + 0.22*i/bands) + Math.sin(t*speed + i)*12;
        const grad = ctx.createLinearGradient(0,y0-amp,0,y0+amp);
        grad.addColorStop(0,`rgba(255,180,120,0)`);
        grad.addColorStop(0.5,`rgba(255,180,120,${alpha})`);
        grad.addColorStop(1,`rgba(255,180,120,0)`);
        ctx.fillStyle=grad; ctx.fillRect(0,y0-amp,W,amp*2);
      }
      ctx.restore();
    }

    /* ========= Prism / Pulse（沿用） ========= */
    function drawPrism(t){ const p=skin.effects && skin.effects.prism; if(!p) return; const beams=p.beams||8, speed=p.speed||0.0005, alpha=(p.alpha!=null?p.alpha:0.10), spread=p.spread||0.85, hueShift=p.hueShift||0; const cx=W*0.5, cy=H*0.45, R=Math.hypot(W,H); ctx.save(); ctx.globalCompositeOperation='screen'; for(let i=0;i<beams;i++){ const ang=t*speed + i*(Math.PI*2/beams); ctx.save(); ctx.translate(cx,cy); ctx.rotate(ang); const w=R*0.12; const grad=ctx.createLinearGradient(0,0,R,0); const h0=(i*360/beams + (t*0.02) + hueShift)%360, h1=(h0+60)%360; const c0=hslToRgb(h0,85,62), c1=hslToRgb(h1,80,58); grad.addColorStop(0.00,'rgba(255,255,255,0)'); grad.addColorStop(0.10,rgba(c0,0.20)); grad.addColorStop(0.55,rgba(c1,0.12)); grad.addColorStop(1.00,'rgba(255,255,255,0)'); ctx.fillStyle=grad; ctx.globalAlpha=alpha; ctx.beginPath(); ctx.moveTo(-w,0); ctx.lineTo(R*spread,-w*0.40); ctx.lineTo(R,0); ctx.lineTo(R*spread,w*0.40); ctx.lineTo(w,0); ctx.closePath(); ctx.fill(); ctx.restore(); } ctx.restore(); }
    function drawPulse(t){ const p=skin.effects && skin.effects.pulse; if(!p) return; const time = t * (p.speedFactor!=null? p.speedFactor : 1.0); const rings = p.rings || 5; const thick = Math.max(1.5,(p.thickness||6)*dpr*0.85); const col = p.color || skin.base; const col2 = mix(col, [120,240,255], 0.35); const strength = (p.strength!=null? p.strength:0.20); const cx=W/2, cy=H*0.48, maxR=Math.min(W,H)*0.56; const micro = Math.max(1, p.microRipples||2); const dash  = p.dash!==false; const baseDelay = skin.period / rings; const ringDelay = (p.ringDelayMs!=null) ? p.ringDelayMs : baseDelay * (p.intervalMul || 1); ctx.save(); ctx.globalCompositeOperation='screen'; for(let i=0;i<rings;i++){ const raw = ((time - i*ringDelay) % skin.period + skin.period) % skin.period; const ph = raw / skin.period; const jitter = Math.sin((time*0.0009 + i)*3.7)*0.012; const eased = easeOutQuad(Math.min(1, Math.max(0, ph + jitter))); const r = eased * maxR; const fade = Math.pow(1-ph, 2.15); ctx.save(); ctx.beginPath(); ctx.arc(cx,cy,r,0,Math.PI*2); ctx.lineWidth = thick*(0.72 + 0.52*(1-ph)); ctx.shadowColor = rgba(col, Math.min(0.30,strength*0.50)*fade); ctx.shadowBlur = 18; ctx.strokeStyle = rgba(col, Math.min(0.78, strength*0.92) * fade); ctx.stroke(); ctx.restore(); ctx.save(); ctx.beginPath(); ctx.arc(cx,cy, r*0.996, 0, Math.PI*2); ctx.lineWidth = Math.max(1, thick*0.42); ctx.strokeStyle = rgba(col2, Math.min(0.48, strength*0.40) * fade); ctx.stroke(); ctx.restore(); const band = Math.max(2, thick*1.2); const rg = ctx.createRadialGradient(cx,cy, Math.max(0,r-band), cx,cy, r+band); rg.addColorStop(0.45, 'rgba(0,0,0,0)'); rg.addColorStop(0.50, rgba(col, Math.min(0.36, strength*0.30)*fade)); rg.addColorStop(0.55, 'rgba(0,0,0,0)'); ctx.fillStyle = rg; ctx.beginPath(); ctx.arc(cx,cy,r+band,0,Math.PI*2); ctx.fill(); for(let m=1;m<=micro;m++){ const rr = r + m*(band*0.65); const g2 = ctx.createRadialGradient(cx,cy, rr-1.5, cx,cy, rr+1.5); g2.addColorStop(0,'rgba(0,0,0,0)'); g2.addColorStop(0.49, rgba(col2, Math.min(0.33, strength*0.24)*(fade*(0.85-0.25*m)))); g2.addColorStop(0.51, 'rgba(0,0,0,0)'); ctx.fillStyle=g2; ctx.beginPath(); ctx.arc(cx,cy,rr+2,0,Math.PI*2); ctx.fill(); } if(dash){ ctx.save(); ctx.setLineDash([8,14]); ctx.lineDashOffset = - (time*0.06) * (i+1); ctx.beginPath(); ctx.arc(cx,cy,r,0,Math.PI*2); ctx.lineWidth = Math.max(1, thick*0.34); ctx.strokeStyle = rgba(col2, Math.min(0.30, strength*0.22) * fade); ctx.stroke(); ctx.setLineDash([]); ctx.restore(); } } ctx.restore(); }

    function drawFrame(t){
      const phase=(t%skin.period)/skin.period; const breathe = 0.65 + 0.35 * (0.5 + 0.5 * Math.sin(phase * Math.PI * 2));
      const edge=Math.max(2,Math.round(1.5*dpr)), bevel=Math.max(3,Math.round(4*dpr)); const aura=Math.max(10,Math.round(12*dpr)); const edgThick = edge + bevel;

      // 背景（可被 skin.bg 覆蓋）
      const bg=ctx.createLinearGradient(0,0,0,H);
      if(Array.isArray(skin.bg) && skin.bg.length>=3){ bg.addColorStop(0,skin.bg[0]); bg.addColorStop(0.55,skin.bg[1]); bg.addColorStop(1,skin.bg[2]); }
      else { bg.addColorStop(0,'#0d132a'); bg.addColorStop(0.55,'#0b1226'); bg.addColorStop(1,'#091223'); }
      ctx.fillStyle=bg; ctx.fillRect(0,0,W,H);

      // 背景特效層
      if(skin.effects && skin.effects.stars) drawStarField(t);
      if(woodPattern){ const baseA=(skin.effects && skin.effects.woodBoost)? 0.12:0.07; const a=baseA + 0.05*(0.5+0.5*Math.sin(phase*2*Math.PI)); ctx.save(); ctx.globalAlpha=a; ctx.fillStyle=woodPattern; ctx.fillRect(0,0,W,H); ctx.restore(); if(skin.effects && skin.effects.woodSheen){ const ws=skin.effects.woodSheen; const a2=(ws.alpha!=null? ws.alpha:0.08)*(0.8+0.2*Math.sin(t*0.001)); const off=Math.sin(t*0.0006)*W*0.2; ctx.save(); const x0=-W*0.2+off, y0=H*0.2, x1=W*1.2+off, y1=H*0.8; const g=ctx.createLinearGradient(x0,y0,x1,y1); g.addColorStop(0,'rgba(255,255,255,0)'); g.addColorStop(0.5,`rgba(255,240,200,${a2.toFixed(3)})`); g.addColorStop(1,'rgba(255,255,255,0)'); const prev=ctx.globalCompositeOperation; ctx.globalCompositeOperation='soft-light'; ctx.fillStyle=g; ctx.fillRect(0,0,W,H); ctx.globalCompositeOperation=prev; ctx.restore(); } }
      drawPrism(t);
      drawPulse(t);
      if(skin.effects && skin.effects.snow){ ensureSnowIfNeeded(); drawSnow(t); }
      if(skin.effects && skin.effects.shards){ ensureShardsIfNeeded(); drawShards(t); }
      if(skin.effects && skin.effects.heat){ drawHeatHaze(t); }
      if(skin.effects && skin.effects.tornado){ ensureTornadoIfNeeded(); drawTornado(t); }
      if(skin.effects && skin.effects.dragons){ ensureDragonsIfNeeded(); drawDragons(t); }
      if(skin.effects && skin.effects.embers){ drawEmbers(t); }

      // LED 邊（上/左/右）
      let hiRGB=skin.hi, baseRGB=skin.base;
      if(skin.effects && skin.effects.rainbow){ hiRGB=hslToRgb((phase*360),85,65); baseRGB=hslToRgb((phase*360+200)%360,80,60); }
      if(skin.effects && skin.effects.ledFlameGrad){ baseRGB=[170,20,24]; hiRGB=[255,174,74]; }
      const coreA=0.78 + 0.20*breathe, hiA=0.62*breathe;
      const gTop=ctx.createLinearGradient(0,0,0,edgThick);
      gTop.addColorStop(0,   rgba(hiRGB,  hiA));
      gTop.addColorStop(0.55,rgba(baseRGB,coreA));
      if(skin.effects && skin.effects.ledFlameGrad){ gTop.addColorStop(0.85, rgba(hiRGB, hiA*0.9)); }
      gTop.addColorStop(1,'rgba(255,255,255,0)'); ctx.fillStyle=gTop; ctx.fillRect(0,0,W,edgThick);
      const spec=Math.max(1, Math.round(1*dpr)); ctx.fillStyle=rgba(hiRGB, Math.min(0.88, 0.55+0.40*breathe)); ctx.fillRect(0,0,W,spec);
      const gLeft=ctx.createLinearGradient(0,0,edgThick,0); gLeft.addColorStop(0,rgba(hiRGB,hiA)); gLeft.addColorStop(0.55,rgba(baseRGB,coreA)); gLeft.addColorStop(1,'rgba(255,255,255,0)'); ctx.fillStyle=gLeft; ctx.fillRect(0,0,edgThick,H);
      const gRight=ctx.createLinearGradient(W,0,W-edgThick,0); gRight.addColorStop(0,rgba(hiRGB,hiA)); gRight.addColorStop(0.55,rgba(baseRGB,coreA)); gRight.addColorStop(1,'rgba(255,255,255,0)'); ctx.fillStyle=gRight; ctx.fillRect(W-edgThick,0,edgThick,H);

      rafId=requestAnimationFrame(drawFrame);
    }

    function start(){ cancelAnimationFrame(rafId); rafId=requestAnimationFrame(drawFrame); }
    window.addEventListener('resize', ()=>{ resize(); start(); }, {passive:true});
    if(document.fonts && document.fonts.ready){ document.fonts.ready.then(()=>{ resize(); start(); }); } else { resize(); start(); }

    window.__applySkinCanvas = function(params){
      const next = Object.assign({ base:[92,136,255], hi:[255,255,255], period:2000, effects:{}, bg:null }, params||{});
      skin = next;
      if(skin.effects && typeof skin.effects.wood==='string'){ if(woodKind!==skin.effects.wood){ buildWoodPattern(skin.effects.wood); } }
      else { woodPattern=null; woodKind=null; }
      if(skin.effects && skin.effects.stars){ starOpts = (typeof skin.effects.stars==='object')? skin.effects.stars : {}; ensureStarsIfNeeded(); } else { stars=null; starOpts={}; }
      ensureEmbersIfNeeded(); ensureDragonsIfNeeded(); ensureTornadoIfNeeded(); // 其餘 ensure 在 draw / resize 中執行
    };
  })();

  /* ---------------- Skin 管理（擴充：烈焰三款） ---------------- */
  (function(){
    const skinSel = document.getElementById('skinSel');
    const skinTitle = document.getElementById('skinTitle');
    const skinDesc = document.getElementById('skinDesc');

    const SKINS = {
      classic:{ label:'經典風格', selectLabel:'冷藍玻璃', cssSkin:'經典風格', canvas:{ base:[92,136,255], hi:[255,255,255], period:2000, effects:{}, bg:null }, desc:'LED：三側一致深藍，右側鏡像，2s 呼吸。' },
      s2:{ label:'科技感風格2', selectLabel:'科技感風格2', cssSkin:'科技感風格2', canvas:{ base:[160,220,255], hi:[255,255,255], period:2200, effects:{ rainbow:true, prism:{ beams:6, speed:0.0005, alpha:0.10, spread:0.85, hueShift:40 } }, bg:['#0b0f2a','#0a0e26','#070a18'] }, desc:'全息 HUD：彩虹高光邊＋Holo Prism 光束（低對比）、2.2s 呼吸。' },
      s3:{ label:'科技感風格3', selectLabel:'科技感風格3', cssSkin:'科技感風格3', canvas:{ base:[80,255,160], hi:[255,255,255], period:2400, effects:{ scanline:true, pulse:{ rings:6, thickness:6, strength:0.16, color:[80,255,160], speedFactor:0.45, intervalMul:1.6, microRipples:2, dash:true } }, bg:['#07150f','#06130e','#041009'] }, desc:'賽博格綠脈衝：速度放緩（×0.45）、每圈間隔加長（×1.6），顏色更淡；2.4s 呼吸。' },
      s5:{ label:'科技感風格5', selectLabel:'科技感風格5', cssSkin:'科技感風格5', canvas:{ base:[150,120,255], hi:[255,255,255], period:2800, effects:{ stars:{ countScale:1.1, twinkle:0.85, drift:0.009, sizeMin:1.6, sizeMax:3.2, glow:2.0, brightness:1.2 } }, bg:['#0b0a20','#0a0820','#08071a'] }, desc:'藍紫星際霓虹：更大更亮的星點與光暈、緩慢漂移，2.8s 呼吸。' },
      w2:{ label:'木紋・黑檀曜金', selectLabel:'木紋・黑檀曜金', cssSkin:'木紋-黑檀曜金', canvas:{ base:[240,190,110], hi:[255,245,210], period:2400, effects:{ wood:'ebony', woodBoost:true, woodSheen:{alpha:0.08} }, bg:['#0b0806','#090705','#070504'] }, desc:'黑檀深棕：加強木孔/髮絲紋，油潤柔光高光；2.4s。' },
      w4:{ label:'木紋・白橡北歐', selectLabel:'木紋・白橡北歐', cssSkin:'木紋-白橡北歐', canvas:{ base:[255,220,170], hi:[255,250,230], period:1900, effects:{ wood:'oak', woodBoost:true, woodSheen:{alpha:0.06} }, bg:['#322515','#261c10','#1b140b'] }, desc:'白橡淺木：直紋＋ray fleck（低對比）、優雅油光；1.9s。' },
      i1:{ label:'冰雪・極光絲綢', selectLabel:'冰雪・極光絲綢', cssSkin:'冰雪-極光絲綢', canvas:{ base:[170,210,255], hi:[255,255,255], period:2200, effects:{ snow:{countScale:120, twinkle:true, sway:1.0, speed:0.28, speedMax:0.72, gust:0.12, sizeMin:1.0, sizeMax:2.5}, shards:{count:10, speed:0.05, width:1.2, alpha:0.10, lenMin:60, lenMax:160, drift:0.15}, frost:{alpha:0.10}, prism:{ beams:6, speed:0.0004, alpha:0.06, spread:0.82, hueShift:18 } }, bg:['#0b1626','#0a1a2f','#081628'] }, desc:'極光絲緞：冰藍呼吸＋輕雪＋低對比極光束；2.2s。' },

      /* === 新增火系三款 === */
      f1:{ label:'烈焰・龍脈熾光', selectLabel:'烈焰・龍脈熾光', cssSkin:'烈焰-龍脈熾光',
          canvas:{ base:[255,160,70], hi:[255,230,200], period:2000,
                   effects:{ ledFlameGrad:true, embers:{count:180, sizeMin:1.2, sizeMax:2.4, up:0.36, swirl:0.20, twinkle:true}, heat:{bands:3, amplitude:10, speed:0.0010, alpha:0.07}, dragons:{count:1, width:16, speed:0.0007, ampX:0.30, ampY:0.18, hue:18, jitter:0.25}, prism:{beams:7, speed:0.00035, alpha:0.06, spread:0.80, hueShift:12} },
                   bg:['#1a0b06','#120805','#0b0503'] },
          desc:'龍捲火流：橙金星火上升＋柔和熱擾動；暖金 LED 呼吸，2.0s。' },
      f2:{ label:'烈焰・熔岩脈動', selectLabel:'烈焰・熔岩脈動', cssSkin:'烈焰-熔岩脈動',
          canvas:{ base:[255,120,80], hi:[255,240,220], period:2300,
                   effects:{ embers:{count:150, sizeMin:1.0, sizeMax:2.0, up:0.32, swirl:0.14, twinkle:true}, pulse:{rings:5, thickness:7, strength:0.18, color:[255,120,80], speedFactor:0.55, intervalMul:1.7, microRipples:2, dash:true}, heat:{bands:2, amplitude:12, speed:0.0008, alpha:0.06} },
                   bg:['#240b08','#160705','#0c0504'] },
          desc:'熔岩呼吸：暖紅脈衝波＋熾亮星火；2.3s。' },
      f3:{ label:'烈焰・星火風暴', selectLabel:'烈焰・星火風暴', cssSkin:'烈焰-星火風暴',
          canvas:{ base:[255,150,110], hi:[255,250,240], period:2100,
                   effects:{ embers:{count:220, sizeMin:1.0, sizeMax:2.2, up:0.40, swirl:0.22, twinkle:true}, tornado:{cxFrac:0.5, baseRFrac:0.46, topRFrac:0.08, heightFrac:0.86, swirl:1.8, alpha:0.08, bands:6}, prism:{beams:9, speed:0.00045, alpha:0.08, spread:0.86, hueShift:8} },
                   bg:['#150807','#0d0504','#080404'] },
          desc:'星火風暴：高密度星火雨＋橙紅光束掃描；2.1s。' }
    };

    (function populate(){
      const exists = Array.from(skinSel.options).map(o=>o.textContent.trim());
      if(!exists.includes(SKINS.classic.selectLabel)){
        const opt=document.createElement('option'); opt.textContent=SKINS.classic.selectLabel; skinSel.appendChild(opt);
      }
      ['s2','s3','s5','w2','w4','i1','f1','f2','f3'].forEach(k=>{ const opt=document.createElement('option'); opt.textContent=SKINS[k].selectLabel; skinSel.appendChild(opt); });
    })();

    function applyClassic(){ document.body.dataset.skin = SKINS.classic.cssSkin; window.__applySkinCanvas(SKINS.classic.canvas); skinTitle.textContent=SKINS.classic.label; skinDesc.textContent=SKINS.classic.desc; }
    function applySkinKey(key){ const s=SKINS[key]; document.body.dataset.skin=s.cssSkin||'經典風格'; window.__applySkinCanvas(s.canvas); skinTitle.textContent=s.label; skinDesc.textContent=s.desc; }

    skinSel.addEventListener('change',()=>{
      const val = skinSel.value.trim();
      if(val===SKINS.classic.selectLabel) return applyClassic();
      if(val===SKINS.s2.selectLabel) return applySkinKey('s2');
      if(val===SKINS.s3.selectLabel) return applySkinKey('s3');
      if(val===SKINS.s5.selectLabel) return applySkinKey('s5');
      if(val===SKINS.w2.selectLabel) return applySkinKey('w2');
      if(val===SKINS.w4.selectLabel) return applySkinKey('w4');
      if(val===SKINS.i1.selectLabel) return applySkinKey('i1');
      if(val===SKINS.f1.selectLabel) return applySkinKey('f1');
      if(val===SKINS.f2.selectLabel) return applySkinKey('f2');
      if(val===SKINS.f3.selectLabel) return applySkinKey('f3');
    }, {passive:true});

    applyClassic();
  })();
  </script>
</body>
</html>
