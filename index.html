<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Rock Breakout â€” ç²¾ç°¡å¾Œçš„ Skinï¼ˆFX Pass 3ï¼‰</title>
  <!-- è¦æ ¼ï¼šä¿æŒæ‰€æœ‰è¨­ç½®/é…ç½®/æŒ‰éµåŠŸèƒ½ä¸è®Šï¼›æœ¬æ¬¡åƒ…é‡å°ä¸‰æ¬¾ Skin çš„ã€ŒéŠæˆ²å€(Canvas) èƒŒæ™¯ã€åšè³ªæ„Ÿå¼·åŒ–ï¼š
       1) ç§‘æŠ€æ„Ÿé¢¨æ ¼2ï¼šåŠ å…¥å…¨æ¯ã€Œprismã€çµ¢éº—ç‰¹æ•ˆï¼ˆä½å°æ¯”ã€å„ªé›…ï¼‰ã€‚
       2) ç§‘æŠ€æ„Ÿé¢¨æ ¼5ï¼šå®‡å®™æ˜Ÿé»é¡†ç²’æ”¾å¤§ï¼‹å…‰æšˆæ›´æ˜é¡¯ï¼ˆä»æŸ”å’Œï¼‰ã€‚
       3) æœ¨ç´‹ãƒ»ç™½æ©¡åŒ—æ­ï¼šæœ¨ç´‹æ›´å„ªé›…å¯è¾¨ï¼ˆåŠ å…¥ ray fleckï¼‹æ²¹å…‰ï¼‰ã€‚ -->
  <style>
    :root{
      /* å…±ç”¨è‰²ç¥¨ï¼ˆå¯è¢« Skin è¦†å¯«ï¼‰ */
      --ink:#eaf2ff; --muted:#b8c7ea; 
      --glass-1:rgba(255,255,255,.08); --glass-2:rgba(255,255,255,.06);
      --stroke:rgba(140,180,255,.28); 
      --bg1:#13224a; --bg2:#081022; 
      --hudGrad1:rgba(20,25,44,.62); --hudGrad2:rgba(12,20,42,.44);
      --stageGlass:linear-gradient(180deg, rgba(255,255,255,.02), rgba(255,255,255,0));
      --panelPattern:none; /* èƒŒæ™¯é¢æ¿èŠ±ç´‹ */
      --btnGlow:0 0 0 rgba(0,0,0,0);
      --hudBottom:96px;
    }
    html,body{height:100%;margin:0;color:var(--ink);
      background: radial-gradient(140% 140% at 50% -12%, var(--bg1) 0%, #0e1a3a 50%, #0b1633 75%, var(--bg2) 100%);
      font-family: ui-sans-serif, -apple-system, system-ui, "Segoe UI", Roboto, "Noto Sans TC", "PingFang TC", "Microsoft JhengHei", Arial, sans-serif;
      -webkit-font-smoothing: antialiased;
    }
    .wrap{max-width:1200px;margin:0 auto;padding:0 12px 24px}
    header{padding:calc(8px + env(safe-area-inset-top)) 0 10px;display:flex;gap:8px;align-items:center;flex-wrap:wrap;justify-content:space-between}
    h1{font-size:clamp(16px,2.6vw,22px);margin:0 8px 0 0;letter-spacing:.4px;opacity:.95}
    .small{font-size:12px;color:var(--muted)}

    /* HUD èˆ‡ UIï¼šå®Œå…¨ä¿ç•™ï¼ˆçµæ§‹ä¸è®Šï¼‰ï¼Œä½†æ¨£å¼è®Šæ•¸å¯è¢« Skin è¦†å¯« */
    .hud{position:sticky;top:0;z-index:30;display:grid;gap:8px;align-items:center;
      grid-template-columns:1fr;max-width:min(1080px,96vw);margin:8px auto 0;border:1px solid var(--stroke);
      border-radius:18px;padding:10px;background:linear-gradient(180deg,var(--hudGrad1),var(--hudGrad2));
      backdrop-filter: blur(8px);box-shadow:0 6px 28px rgba(0,0,0,.28)}
    .stats{display:grid;grid-template-columns:auto auto 1fr;grid-auto-rows:minmax(36px,auto);gap:8px 10px;align-items:center}
    .stats .wide{grid-column:1 / -1}
    .pill{padding:8px 18px;border:1px solid var(--stroke);background:var(--glass-2);border-radius:999px;min-height:36px;display:flex;align-items:center;gap:10px;color:#d7e3ff;font-weight:650;font-size:15px}
    .pill b{color:#fff;font-variant-numeric:tabular-nums}
    .inline-controls{justify-self:end;display:flex;gap:8px;align-items:center;position:relative}
    .ic-btn{width:48px;height:36px;border-radius:12px;border:1px solid var(--stroke);
      background:radial-gradient(120% 120% at 30% 20%, rgba(255,255,255,.16), rgba(255,255,255,0) 58%), var(--glass-1);
      display:grid;place-items:center;cursor:pointer;box-shadow:inset 0 0 0 1px rgba(255,255,255,.05), 0 8px 20px rgba(0,0,0,.28), var(--btnGlow); color:#fff}
    .ic-btn:active{transform:translateY(1px)}
    .ic-btn .ico{font-size:18px;line-height:1}
    #optBtn{color:#fff}

    .menu{position:absolute;top:46px;right:0;min-width:280px;padding:10px;border:1px solid var(--stroke);border-radius:14px;background:rgba(12,18,36,.96);backdrop-filter:blur(10px);transform:scale(.96);opacity:0;pointer-events:none;transition:.16s ease;z-index:60}
    .menu.show{transform:scale(1);opacity:1;pointer-events:auto}
    .menu .item{display:flex;align-items:center;gap:10px;padding:10px;border:1px solid var(--stroke);border-radius:10px;background:var(--glass-2);margin-bottom:8px}
    .menu h4{margin:6px 0 8px;font-size:13px;color:#cfe0ff}
    .btn{padding:8px 12px;border-radius:10px;border:1px solid var(--stroke);cursor:pointer;background:var(--glass-2);color:#fff;box-shadow:var(--btnGlow)}

    #buffs{position:sticky;z-index:22;top:calc(var(--hudBottom) + 6px);display:flex;gap:8px;align-items:center;max-width:min(1080px,96vw);margin:6px auto 0;padding-left:6px;overflow:auto;scrollbar-width:none}
    #buffs::-webkit-scrollbar{display:none}
    .chip{display:inline-flex;align-items:center;gap:8px;padding:6px 10px;border:1px solid var(--stroke);border-radius:999px;background:var(--glass-1);font-size:12px;white-space:nowrap;color:#cfe0ff}
    #promptsDock{position:sticky;z-index:20;top:calc(var(--hudBottom) + 48px);max-width:min(1080px,96vw);margin:6px auto 0;padding:0 6px;display:flex;gap:8px;align-items:flex-start;overflow:auto;scrollbar-width:none}
    #promptsDock::-webkit-scrollbar{display:none}
    .prompt{padding:8px 10px;border:1px solid var(--stroke);border-radius:12px;background:rgba(14,22,40,.92);box-shadow:0 10px 26px rgba(0,0,0,.34);font-size:12px;line-height:1.45;color:#eaf2ff;white-space:nowrap}

    /* ç•«å¸ƒå®¹å™¨ï¼ˆä¸å‹•ï¼‰+ èƒŒæ™¯é¢æ¿è³ªæ„Ÿ/èŠ±ç´‹å¯ç”±è®Šæ•¸æ§åˆ¶ */
    .stage{position:relative;margin:12px auto 0;max-width:min(1080px,96vw);border-radius:18px;padding:12px;box-sizing:border-box;
      background:var(--stageGlass); background-image:var(--panelPattern); background-blend-mode:overlay;}
    canvas#game{background:linear-gradient(180deg,#0d132a,#0b1226 55%, #091223);border:1px solid rgba(80,110,170,.45);border-radius:16px;display:block;width:100%;height:auto;margin:0 auto;
      box-shadow:inset 0 0 160px rgba(255,255,255,.03), 0 28px 90px rgba(0,0,0,.46)}
    .legend{display:flex;gap:8px;flex-wrap:wrap;align-items:center;justify-content:center;font-size:12px;color:#cfe0ff;margin-top:6px}
    .legend .item{padding:4px 8px;border-radius:10px;background:rgba(255,255,255,.05);border:1px solid var(--stroke)}
    .legend .box{width:14px;height:14px;display:inline-block;border-radius:3px;margin-right:4px;vertical-align:middle}

    @media (max-width:390px){ .pill{font-size:14px;padding:7px 14px} .ic-btn{width:44px;height:36px} }

    /* ======== Skinï¼šç§‘æŠ€æ„Ÿï¼ˆä¿ç•™ 2/3/5ï¼‰ ======== */
    /* 2. ç§‘æŠ€æ„Ÿé¢¨æ ¼2ï¼šå…¨æ¯ HUDï¼ˆåŠ  prism çµ¢éº—ç‰¹æ•ˆï¼‰ */
    body[data-skin="ç§‘æŠ€æ„Ÿé¢¨æ ¼2"]{
      --ink:#f6fbff; --muted:#dbe6ff; --stroke:rgba(200,220,255,.38);
      --bg1:#0b0f2a; --bg2:#070a18;
      --hudGrad1:rgba(24,28,70,.58); --hudGrad2:rgba(16,22,58,.42);
      --glass-1:rgba(255,255,255,.12); --glass-2:rgba(255,255,255,.09);
      --stageGlass:linear-gradient(180deg, rgba(255,255,255,.03), rgba(0,0,0,0));
      --panelPattern:conic-gradient(from 0deg at 60% 40%, rgba(255,160,220,.08), rgba(160,220,255,.06), rgba(160,255,200,.06), rgba(255,220,160,.06), rgba(255,160,220,.08));
      --btnGlow:0 0 20px rgba(160,220,255,.25);
    }
    /* 3. ç§‘æŠ€æ„Ÿé¢¨æ ¼3ï¼šè³½åšæ ¼ç¶ è„ˆè¡ï¼ˆæ²¿ç”¨å‰æ¬¡å¼·åŒ–ï¼‰ */
    body[data-skin="ç§‘æŠ€æ„Ÿé¢¨æ ¼3"]{
      --ink:#e7ffe7; --muted:#bdfdcc; --stroke:rgba(120,255,170,.34);
      --bg1:#081812; --bg2:#03110a;
      --hudGrad1:rgba(10,40,26,.64); --hudGrad2:rgba(6,28,18,.46);
      --glass-1:rgba(160,255,200,.12); --glass-2:rgba(120,220,170,.08);
      --stageGlass:linear-gradient(180deg, rgba(120,255,180,.05), rgba(0,0,0,0));
      --panelPattern:repeating-linear-gradient(180deg, rgba(140,255,190,.05) 0 1px, transparent 1px 3px);
      --btnGlow:0 0 16px rgba(120,255,170,.25);
    }
    /* 5. ç§‘æŠ€æ„Ÿé¢¨æ ¼5ï¼šè—ç´«æ˜Ÿéš›éœ“è™¹ï¼ˆæ˜Ÿé»æ›´å¤§æ›´æ˜é¡¯ï¼‰ */
    body[data-skin="ç§‘æŠ€æ„Ÿé¢¨æ ¼5"]{
      --ink:#eef0ff; --muted:#c9c9ff; --stroke:rgba(160,140,255,.34);
      --bg1:#0c0b24; --bg2:#09081a;
      --hudGrad1:rgba(30,24,70,.58); --hudGrad2:rgba(20,18,50,.44);
      --glass-1:rgba(200,180,255,.10); --glass-2:rgba(160,140,255,.08);
      --stageGlass:linear-gradient(180deg, rgba(160,140,255,.05), rgba(0,0,0,0));
      --panelPattern:radial-gradient(120px 80px at 20% 10%, rgba(110,80,255,.08), transparent 60%),
                      radial-gradient(160px 120px at 80% 20%, rgba(180,100,255,.08), transparent 60%);
      --btnGlow:0 0 22px rgba(150,120,255,.25);
    }

    /* ======== Skinï¼šæœ¨ç´‹ï¼ˆä¿ç•™ é»‘æª€æ›œé‡‘ï¼ç™½æ©¡åŒ—æ­ï¼‰ ======== */
    /* B. é»‘æª€æ›œé‡‘ï¼ˆæ·±è‰²è±ªè¯ï¼‰ */
    body[data-skin="æœ¨ç´‹-é»‘æª€æ›œé‡‘"]{
      --ink:#f6edd8; --muted:#d9caa8; --stroke:rgba(255,220,140,.28);
      --bg1:#0e0b09; --bg2:#060403;
      --hudGrad1:rgba(28,18,10,.72); --hudGrad2:rgba(18,12,8,.56);
      --glass-1:rgba(255,220,140,.10); --glass-2:rgba(255,220,140,.07);
      --stageGlass:linear-gradient(180deg, rgba(255,220,140,.04), rgba(0,0,0,0));
      --panelPattern:repeating-linear-gradient(12deg, rgba(40,28,18,.35) 0 18px, rgba(0,0,0,0) 18px 34px),
                      repeating-linear-gradient(192deg, rgba(60,44,28,.20) 0 12px, rgba(0,0,0,0) 12px 28px);
      --btnGlow:0 0 20px rgba(255,210,120,.24);
    }
    /* D. ç™½æ©¡åŒ—æ­ï¼ˆæ·ºæœ¨æ¥µç°¡ï¼‰ - å¼·åŒ–å„ªé›…æœ¨ç´‹ */
    body[data-skin="æœ¨ç´‹-ç™½æ©¡åŒ—æ­"]{
      --ink:#fff8ec; --muted:#e6d8c2; --stroke:rgba(255,215,170,.26);
      --bg1:#3a2d19; --bg2:#1c150b;
      --hudGrad1:rgba(78,60,30,.66); --hudGrad2:rgba(48,36,18,.50);
      --glass-1:rgba(255,220,170,.10); --glass-2:rgba(255,220,170,.08);
      --stageGlass:linear-gradient(180deg, rgba(255,230,190,.05), rgba(0,0,0,0));
      --panelPattern:repeating-linear-gradient(8deg, rgba(210,170,120,.14) 0 14px, rgba(0,0,0,0) 14px 26px),
                      repeating-linear-gradient(188deg, rgba(240,210,160,.05) 0 2px, rgba(0,0,0,0) 2px 8px);
      --btnGlow:0 0 16px rgba(255,220,170,.22);
    }
  </style>
</head>
<body data-skin="ç¶“å…¸é¢¨æ ¼">
  <div class="wrap" id="app">
    <header>
      <h1>Rockæ‰“ç£šå¡Š â€” <span id="skinTitle">ç¶“å…¸é¢¨æ ¼</span></h1>
      <span class="small" id="skinDesc">LEDï¼šæœ€æ–°ç‰ˆï¼ˆä¸‰å´ä¸€è‡´æ·±è—ï¼Œå³å´é¡åƒï¼Œ2s å‘¼å¸ï¼‰ï¼›æŒ‰éµé…ç½® 0 è®Šæ›´ã€‚</span>
    </header>

    <!-- HUDï¼šåŸæ¨£ä¿ç•™ï¼ˆåŠŸèƒ½/çµæ§‹å®Œå…¨ä¸å‹•ï¼‰ -->
    <section class="hud" aria-label="éŠæˆ² HUD">
      <div class="stats">
        <div class="pill">åˆ†æ•¸ <b id="score">0</b></div>
        <div class="pill">é—œå¡ <b id="level">1</b>/20</div>
        <div class="inline-controls">
          <button class="ic-btn" id="sndBtn" aria-haspopup="true" aria-expanded="false" aria-controls="soundMenu" title="è²éŸ³"><span class="ico">ğŸ”Š</span></button>
          <div class="menu" id="soundMenu">
            <div class="item"><span>ğŸµ</span><label><input type="checkbox" id="bgmOn"> BGM é–‹é—œ</label></div>
            <div class="item"><span>ğŸš</span><label style="width:100%">BGM éŸ³é‡ <input id="bgmVol" type="range" min="0" max="1" step="0.01" value="0.7" style="width:60%" aria-label="BGM éŸ³é‡"></label></div>
            <div class="item"><span>ğŸ”ˆ</span><label><input type="checkbox" id="sfxOn" checked> éŸ³æ•ˆé–‹é—œ</label></div>
          </div>
          <button class="ic-btn" id="optBtn" aria-haspopup="true" aria-expanded="false" aria-controls="optMenu" title="é¸é …">â‹¯</button>
          <div class="menu" id="optMenu">
            <h4>éŠæˆ²</h4>
            <div class="item"><span>ğŸ®</span>é›£åº¦ <select id="difficulty" aria-label="é›£åº¦"><option>ç°¡å–®</option><option selected>ä¸€èˆ¬</option><option>å›°é›£</option></select></div>
            <div class="row" style="display:flex;gap:8px;flex-wrap:wrap"><button class="btn" id="resetBtn">é‡æ–°é–‹å§‹</button><button class="btn" id="saveBtn">å­˜æª”</button><button class="btn" id="loadBtn">è®€æª”</button></div>
            <h4>å…¶ä»–</h4>
            <div class="row" style="display:flex;gap:8px;flex-wrap:wrap"><button class="btn" id="fsBtn">å…¨è¢å¹•</button><button class="btn" id="tutorBtn">æ•™å­¸</button><button class="btn" id="effectsBtn">æ•ˆæœèªªæ˜</button><button class="btn" id="galleryBtn">ç•«å»Š</button><button class="btn" id="rankBtn">æ’è¡Œæ¦œ</button></div>
            <div class="item"><span>ğŸ¨</span>Skin <select aria-label="Skin" id="skinSel"><option>å†·è—ç»ç’ƒ</option></select></div>
          </div>
        </div>
        <div class="pill wide">ç”Ÿå‘½ <b id="lives">3</b> <span class="hearts" aria-hidden="true">â¤ï¸â¤ï¸â¤ï¸</span></div>
      </div>
    </section>
    <div class="hud-sentinel" style="height:0"></div>

    <div id="buffs" aria-live="polite"></div>
    <div id="promptsDock" aria-live="polite" aria-label="æç¤ºå¡"></div>

    <div class="stage">
      <canvas id="game" width="1100" height="700" aria-label="éŠæˆ²ç•«é¢"></canvas>
      <div class="legend">
        <span class="item"><span class="box" style="background:#ffd166"></span>ä¸€èˆ¬ç£š</span>
        <span class="item"><span class="box" style="background:#888"></span>ä¸å¯ç ´å£ç£š</span>
        <span class="item"><span class="box" style="background:#bb7aff"></span>å¼·åå½ˆç£š</span>
        <span class="item"><span class="box" style="background:#6ec6ff"></span>ç§»å‹•ç£š</span>
      </div>
    </div>
  </div>

  <script>
    /* ---------------- HUD é«˜åº¦åŒæ­¥ï¼ˆä¿ç•™ï¼‰ ---------------- */
    (function(){
      const hud = document.querySelector('.hud');
      const sentinel = document.querySelector('.hud-sentinel');
      const sndBtn = document.getElementById('sndBtn');
      const optBtn = document.getElementById('optBtn');
      const soundMenu = document.getElementById('soundMenu');
      const optMenu = document.getElementById('optMenu');
      let scheduled=false;
      function schedule(){ if(scheduled) return; scheduled=true; requestAnimationFrame(()=>{ scheduled=false; placeHUD(); }); }
      function placeHUD(){
        const rect = (sentinel||hud).getBoundingClientRect();
        const top = Math.max(0, Math.ceil(rect.top)) + 6;
        document.documentElement.style.setProperty('--hudBottom', top + 'px');
      }
      function toggle(menu, btn){
        const show = !menu.classList.contains('show');
        [soundMenu,optMenu].forEach(m=>m.classList.remove('show'));
        document.querySelectorAll('[aria-expanded="true"]').forEach(b=>b.setAttribute('aria-expanded','false'));
        if(show){ menu.classList.add('show'); btn.setAttribute('aria-expanded','true'); }
        schedule();
      }
      sndBtn.addEventListener('click', (e)=>{ e.stopPropagation(); toggle(soundMenu, sndBtn); });
      optBtn.addEventListener('click', (e)=>{ e.stopPropagation(); toggle(optMenu, optBtn); });
      document.addEventListener('click', (e)=>{ if(!e.target.closest('.menu') && !e.target.closest('#optBtn') && !e.target.closest('#sndBtn')){ [soundMenu,optMenu].forEach(m=>m.classList.remove('show')); schedule(); } }, {passive:true});
      ['resize','orientationchange'].forEach(ev=>window.addEventListener(ev, schedule, {passive:true}));
      if(document.fonts && document.fonts.ready){ document.fonts.ready.then(schedule); }
      schedule();
      const dock = document.getElementById('promptsDock');
      window.showPrompt = function(key, text, category='info'){
        if(!dock) return; const card = document.createElement('div');
        card.className = 'prompt'; card.textContent = String(text).replace(/<[^>]+>/g,'');
        if(category==='buff') card.style.borderColor = 'rgba(160,190,255,.5)';
        if(category==='debuff') card.style.borderColor = 'rgba(255,150,200,.5)';
        if(category==='special') card.style.borderColor = 'rgba(255,220,160,.55)';
        dock.prepend(card); while(dock.children.length>6) dock.removeChild(dock.lastElementChild);
        setTimeout(()=>{ if(card.parentElement) card.parentElement.removeChild(card); }, 6000);
      };
    })();

    /* ---------------- LED é‚Šæ¡† Rendererï¼ˆåƒæ•¸åŒ–ä»¥æ”¯æ´ Skinï¼‰ ---------------- */
    (function(){
      const cv  = document.getElementById('game');
      const box = document.querySelector('.stage');
      const ctx = cv.getContext('2d');

      let W=0,H=0,dpr=1; // ç•«é¢å°ºå¯¸åƒæ•¸
      let rafId=0;

      // Skin åƒæ•¸ï¼ˆå¯ç”±å¤–éƒ¨å¥—ç”¨ï¼‰
      let skin = {
        base:[92,136,255], hi:[255,255,255], period:2000,
        effects:{ rainbow:false, scanline:false, stars:false, grid:false },
        bg:null // å¯è¦†è“‹èƒŒæ™¯æ¼¸å±¤è‰² [top, mid, bottom]
      };

      // ===== å¢å¼·ç”¨é›¢å±ï¼å¿«å–è³‡æ–™ =====
      // æœ¨ç´‹åœ–æ¨£ï¼ˆé›¢å±å¿«å–ï¼‰
      let woodPattern=null, woodKind=null;
      // æ˜Ÿé»å ´ï¼ˆåƒ…ç”¨æ–¼æ˜Ÿéš›é¢¨æ ¼ï¼‰
      let stars=null, starOpts={}, starSizeKey='';

      function buildWoodPattern(kind){
        const oc = document.createElement('canvas');
        const S = 320; oc.width=S; oc.height=S; const c = oc.getContext('2d');
        const presets = {
          walnut:{ ang:25*Math.PI/180, step:16, line:8, dark:'#3b2517', light:'rgba(156,106,62,0.12)', rings:'#6e4a2e' },
          ebony: { ang:12*Math.PI/180, step:18, line:9, dark:'#120d0a', light:'rgba(80,65,50,0.10)',  rings:'#3c2b1e' },
          cherry:{ ang:160*Math.PI/180,step:14, line:7, dark:'#5a2c33', light:'rgba(162,90,102,0.12)',rings:'#a8616f' },
          oak:   { ang:8*Math.PI/180,  step:18, line:7, dark:'#6c5432', light:'rgba(182,138,84,0.12)', rings:'#a07a45' },
          bamboo:{ ang:90*Math.PI/180, step:10, line:3, dark:'#305a3e', light:'rgba(100,150,110,0.10)',rings:'#3f7552' }
        };
        const p = presets[kind] || presets.walnut;
        c.clearRect(0,0,S,S);
        // æ¢ç´‹
        c.save(); c.translate(S/2,S/2); c.rotate(p.ang); c.translate(-S/2,-S/2);
        c.fillStyle=p.light; for(let x=-S; x<=S*2; x+=p.step){ c.fillRect(x,0,p.line,S); }
        c.globalAlpha=0.25; c.fillStyle=p.dark; for(let x=-S; x<=S*2; x+=p.step*3){ c.fillRect(x,0,Math.max(1,p.line-4),S); }
        c.restore();
        // å¹´è¼ªï¼ˆæ©¢åœ“ï¼‰
        c.globalAlpha=0.06; c.strokeStyle=p.rings; c.lineWidth=2;
        const cx=S*0.32, cy=S*0.42; for(let r=28;r<S*0.9;r+=22){ c.beginPath(); c.ellipse(cx,cy,r, r*(0.82+0.06*Math.sin(r)), 0, 0, Math.PI*2); c.stroke(); }
        // ç´°å°çº–ç¶­
        c.globalAlpha=0.04; c.fillStyle='#000';
        for(let i=0;i<80;i++){ const sx=Math.random()*S, sy=Math.random()*S, w=2+Math.random()*4, h=1+Math.random()*2; c.beginPath(); c.ellipse(sx,sy,w,h,Math.random()*Math.PI,0,Math.PI*2); c.fill(); }
        // é»‘æª€ï¼šå¢åŠ æ¯›å­”èˆ‡æ¥µç´°é«®çµ²ç·š
        if(kind==='ebony'){
          c.globalAlpha=0.08; c.strokeStyle='rgba(20,12,8,0.5)'; c.lineWidth=1;
          for(let i=0;i<90;i++){ const x=Math.random()*S, y=Math.random()*S, len=6+Math.random()*14, ang=(Math.random()*0.6-0.3); c.save(); c.translate(x,y); c.rotate(ang); c.beginPath(); c.moveTo(-len/2,0); c.lineTo(len/2,0); c.stroke(); c.restore(); }
          c.globalAlpha=0.06; c.fillStyle='rgba(255,245,210,0.04)';
          for(let i=0;i<30;i++){ const x=Math.random()*S, y=Math.random()*S, r=1+Math.random()*2; c.beginPath(); c.arc(x,y,r,0,Math.PI*2); c.fill(); }
        }
        // ç™½æ©¡ï¼šåŠ å…¥ ray fleckï¼ˆé«“å°„ç·šï¼‰èˆ‡æ·ºè‰²æ¯›å­”ï¼Œç¶­æŒå„ªé›…ä½å°æ¯”
        if(kind==='oak'){
          c.globalAlpha=0.06; c.fillStyle='rgba(240,220,170,0.06)';
          for(let i=0;i<50;i++){ const x=Math.random()*S, y=Math.random()*S, w=2+Math.random()*6, h=1+Math.random()*2; c.fillRect(x,y,w,h); }
          c.globalAlpha=0.05; c.strokeStyle='rgba(200,170,120,0.18)'; c.lineWidth=1;
          c.save(); c.translate(S/2,S/2); c.rotate(p.ang); c.translate(-S/2,-S/2);
          for(let x=0;x<S;x+=24){ c.beginPath(); c.moveTo(x,-10); c.lineTo(x+6,S+10); c.stroke(); }
          c.restore();
        }
        woodPattern = ctx.createPattern(oc,'repeat');
        woodKind = kind;
      }

      function buildStars(){
        const baseCount = 140; // ä»¥ 1100x700 ç‚ºåŸºæº–
        const scale = (W*H)/(1100*700);
        const countScale = (starOpts.countScale||1);
        const N = Math.max(60, Math.floor(baseCount*scale*countScale));
        stars = new Array(N).fill(0).map(()=>{
          return {
            x: Math.random()*W,
            y: Math.random()*H,
            r: (starOpts.sizeMin||0.9) + Math.random()*((starOpts.sizeMax||1.8)-(starOpts.sizeMin||0.9)),
            a: 0.05 + Math.random()*0.12,
            ph: Math.random()*Math.PI*2,
            sp: 0.6 + Math.random()*1.2, // twinkle speed
            px: 0.3 + Math.random()*0.7  // parallax
          };
        });
        starSizeKey = W+'x'+H;
      }

      function ensureStarsIfNeeded(){
        if(!skin.effects || !skin.effects.stars) { stars=null; return; }
        if(!stars || starSizeKey !== (W+'x'+H)) buildStars();
      }

      function resize(){
        const contentW = box.clientWidth;
        const w = Math.min(1100, contentW);
        const h = Math.round(w * (700/1100));
        dpr = Math.min(window.devicePixelRatio || 1, 2);
        cv.style.width = '100%';
        cv.style.height = Math.round(h) + 'px';
        cv.width  = Math.round(w * dpr);
        cv.height = Math.round(h * dpr);
        W=cv.width;H=cv.height;
        ensureStarsIfNeeded();
      }

      const rgba = (rgb,a)=>`rgba(${rgb[0]},${rgb[1]},${rgb[2]},${a.toFixed(3)})`;
      function hslToRgb(h,s,l){ s/=100; l/=100; const k=n=> (n+ h/30)%12; const a=s*Math.min(l,1-l); const f=n=> l - a*Math.max(-1, Math.min(k(n)-3, Math.min(9-k(n),1))); return [Math.round(255*f(0)),Math.round(255*f(8)),Math.round(255*f(4))]; }

      function drawStarField(t){
        if(!stars) return;
        const twinkle = (typeof skin.effects.stars==='object' && skin.effects.stars.twinkle!=null)? skin.effects.stars.twinkle : 0.6;
        const drift = (typeof skin.effects.stars==='object' && skin.effects.stars.drift!=null)? skin.effects.stars.drift : 0.008;
        const glow = (typeof skin.effects.stars==='object' && skin.effects.stars.glow!=null)? skin.effects.stars.glow : 1.2;
        const bright = (typeof skin.effects.stars==='object' && skin.effects.stars.brightness!=null)? skin.effects.stars.brightness : 1.0;
        ctx.save();
        ctx.globalCompositeOperation = 'screen';
        for(const s of stars){
          const tw = 0.5 + 0.5*Math.sin(t*0.001*s.sp + s.ph);
          const a  = (s.a * (0.55 + twinkle*tw)) * bright;
          const dx = (t * drift * s.px) % (W+20);
          const x  = (s.x + dx);
          const y  = s.y;
          const r  = s.r * dpr * glow;
          const g = ctx.createRadialGradient(x,y,0,x,y,r);
          g.addColorStop(0, `rgba(255,255,255,${(a*1.5).toFixed(3)})`);
          g.addColorStop(1, `rgba(180,160,255,0)`);
          ctx.fillStyle=g; ctx.beginPath(); ctx.arc(x,y,r,0,Math.PI*2); ctx.fill();
        }
        ctx.restore();
      }

      function drawPulse(t){
        const p = skin.effects && skin.effects.pulse; if(!p) return;
        const rings = p.rings||3; const thick = Math.max(2, (p.thickness||6)*dpr);
        const col = p.color || skin.base; const strength = p.strength!=null? p.strength : 0.12;
        const cx = W/2, cy = H*0.48; const maxR = Math.min(W,H)*0.55;
        ctx.save(); ctx.globalCompositeOperation = 'screen';
        for(let i=0;i<rings;i++){
          const ph = ((t % skin.period)/skin.period + i/rings) % 1;
          const r = ph*maxR;
          const fade = Math.pow(1 - ph, 2);
          ctx.beginPath(); ctx.arc(cx,cy,r,0,Math.PI*2);
          ctx.lineWidth = thick*(0.7 + 0.6*(1-ph));
          ctx.strokeStyle = rgba(col, strength*fade);
          ctx.stroke();
        }
        ctx.restore();
      }

      function drawWoodSheen(t){
        const ws = skin.effects && skin.effects.woodSheen; if(!ws) return;
        const a = (ws.alpha!=null? ws.alpha:0.08) * (0.8 + 0.2*Math.sin(t*0.001));
        const off = Math.sin(t*0.0006)*W*0.2;
        ctx.save();
        const x0 = -W*0.2 + off, y0 = H*0.2; const x1 = W*1.2 + off, y1 = H*0.8;
        const g = ctx.createLinearGradient(x0,y0,x1,y1);
        g.addColorStop(0, 'rgba(255,255,255,0)');
        g.addColorStop(0.5, `rgba(255,240,200,${a.toFixed(3)})`);
        g.addColorStop(1, 'rgba(255,255,255,0)');
        const prev = ctx.globalCompositeOperation; ctx.globalCompositeOperation = 'soft-light';
        ctx.fillStyle=g; ctx.fillRect(0,0,W,H);
        ctx.globalCompositeOperation = prev;
        ctx.restore();
      }

      function drawPrism(t){
        const p = skin.effects && skin.effects.prism; if(!p) return;
        const beams = p.beams||8; const speed = p.speed||0.0005; const alpha = (p.alpha!=null?p.alpha:0.10);
        const spread = p.spread||0.85; const hueShift = p.hueShift||0;
        const cx=W*0.5, cy=H*0.45; const R=Math.hypot(W,H);
        ctx.save(); ctx.globalCompositeOperation='screen';
        for(let i=0;i<beams;i++){
          const ang = t*speed + i*(Math.PI*2/beams);
          ctx.save(); ctx.translate(cx,cy); ctx.rotate(ang);
          const w = R*0.12;
          const grad = ctx.createLinearGradient(0,0,R,0);
          const h0 = (i*360/beams + (t*0.02) + hueShift)%360; const h1=(h0+60)%360;
          const c0 = hslToRgb(h0, 85, 62); const c1=hslToRgb(h1, 80, 58);
          grad.addColorStop(0.00, 'rgba(255,255,255,0)');
          grad.addColorStop(0.10, rgba(c0, 0.20));
          grad.addColorStop(0.55, rgba(c1, 0.12));
          grad.addColorStop(1.00, 'rgba(255,255,255,0)');
          ctx.fillStyle=grad; ctx.globalAlpha = alpha;
          ctx.beginPath();
          ctx.moveTo(-w,0);
          ctx.lineTo(R*spread,-w*0.40);
          ctx.lineTo(R,0);
          ctx.lineTo(R*spread,w*0.40);
          ctx.lineTo(w,0);
          ctx.closePath();
          ctx.fill();
          ctx.restore();
        }
        ctx.restore();
      }

      function drawFrame(t){
        const phase = (t % skin.period) / skin.period; // 0..1 å‘¼å¸
        const breathe = 0.65 + 0.35 * (0.5 + 0.5 * Math.sin(phase * Math.PI * 2));
        const edge = Math.max(2, Math.round(1.5*dpr));
        const bevel= Math.max(3, Math.round(4*dpr));
        const aura = Math.max(10, Math.round(12*dpr));

        // èƒŒæ™¯å±¤ï¼šå¦‚ Skin æŒ‡å®š bgï¼Œå‰‡ä½¿ç”¨ä¸»é¡Œæ·±è‰²ï¼›å¦å‰‡ä½¿ç”¨åŸè—è‰²
        const bg = ctx.createLinearGradient(0,0,0,H);
        if(Array.isArray(skin.bg) && skin.bg.length>=3){
          bg.addColorStop(0, skin.bg[0]); bg.addColorStop(0.55, skin.bg[1]); bg.addColorStop(1, skin.bg[2]);
        }else{
          bg.addColorStop(0,'#0d132a'); bg.addColorStop(0.55,'#0b1226'); bg.addColorStop(1,'#091223');
        }
        ctx.fillStyle=bg; ctx.fillRect(0,0,W,H);

        // åº•å±¤æ˜Ÿé»ï¼ˆè‹¥å•Ÿç”¨ï¼‰
        if(skin.effects && skin.effects.stars){ drawStarField(t); }
        // æœ¨ç´‹ï¼ˆè‹¥å•Ÿç”¨ï¼‰
        if(woodPattern){
          ctx.save();
          const baseA = (skin.effects && skin.effects.woodBoost)? 0.12 : 0.07;
          const a = baseA + 0.05*(0.5+0.5*Math.sin(phase*2*Math.PI));
          ctx.globalAlpha=a; ctx.fillStyle=woodPattern; ctx.fillRect(0,0,W,H); ctx.restore();
          if(skin.effects && skin.effects.woodSheen){ drawWoodSheen(t); }
        }
        // Prism çµ¢éº—å…‰æŸï¼ˆé¢¨æ ¼2ï¼‰
        if(skin.effects && skin.effects.prism){ drawPrism(t); }

        if(skin.effects && skin.effects.grid){ // æ¥µæ·¡æ ¼ç·š
          ctx.save(); ctx.globalAlpha=.08; ctx.lineWidth=.6*dpr; ctx.strokeStyle='rgba(180,220,255,.6)';
          const step=Math.round(18*dpr);
          for(let x=0;x<W;x+=step){ ctx.beginPath(); ctx.moveTo(x,0); ctx.lineTo(x,H); ctx.stroke(); }
          for(let y=0;y<H;y+=step){ ctx.beginPath(); ctx.moveTo(0,y); ctx.lineTo(W,y); ctx.stroke(); }
          ctx.restore();
        }
        if(skin.effects && skin.effects.scanline){ // è¢å¹•æƒæç·š
          ctx.save(); ctx.globalAlpha=.06; ctx.fillStyle='#00ff7f';
          for(let y=0;y<H;y+=Math.round(3*dpr)){ ctx.fillRect(0,y,W,1); }
          ctx.restore();
        }
        // ç¶ è„ˆè¡åœˆï¼ˆé¢¨æ ¼3ï¼‰
        if(skin.effects && skin.effects.pulse){ drawPulse(t); }

        // å‘¼å¸é€æ˜åº¦ï¼ˆLED é‚Šï¼‰
        let hiRGB = skin.hi, baseRGB = skin.base;
        if(skin.effects && skin.effects.rainbow){ hiRGB = hslToRgb((phase*360), 85, 65); baseRGB = hslToRgb((phase*360+200)%360, 80, 60); }
        const glowA = 0.20 + 0.22 * breathe;  // æŸ”å…‰
        const coreA = 0.75 + 0.20 * breathe;  // ä¸»é«”
        const hiA   = 0.60 * breathe;         // é«˜å…‰

        // 1) å¤–å±¤æŸ”å…‰ï¼ˆä¸Š/å·¦/å³ä¸€è‡´ï¼Œè²¼é‚Šï¼‰
        const gTop = ctx.createLinearGradient(0,0,0,aura);
        gTop.addColorStop(0, rgba(baseRGB, glowA)); gTop.addColorStop(1,'rgba(0,0,0,0)');
        ctx.fillStyle = gTop; ctx.fillRect(0, 0, W, aura);

        const gLeft = ctx.createLinearGradient(0,0,aura,0);
        gLeft.addColorStop(0, rgba(baseRGB, glowA)); gLeft.addColorStop(1,'rgba(0,0,0,0)');
        ctx.fillStyle = gLeft; ctx.fillRect(0, 0, aura, H);

        const gRight = ctx.createLinearGradient(W-aura,0,W,0);
        gRight.addColorStop(0,'rgba(0,0,0,0)'); gRight.addColorStop(1, rgba(baseRGB, glowA));
        ctx.fillStyle = gRight; ctx.fillRect(W-aura, 0, aura, H);

        // 2) ä¸»é«”äº®é‚Šï¼ˆä¸Š/å·¦/å³ä¸€è‡´ï¼›å³å´é¡åƒï¼‰
        const topEdge = ctx.createLinearGradient(0,0,0,edge+bevel);
        topEdge.addColorStop(0, rgba(hiRGB, hiA));
        topEdge.addColorStop(0.5, rgba(baseRGB, coreA));
        topEdge.addColorStop(1, 'rgba(255,255,255,0)');
        ctx.fillStyle = topEdge; ctx.fillRect(0, 0, W, edge+bevel);

        const leftEdge = ctx.createLinearGradient(0,0,edge+bevel,0);
        leftEdge.addColorStop(0, rgba(hiRGB, hiA));
        leftEdge.addColorStop(0.5, rgba(baseRGB, coreA));
        leftEdge.addColorStop(1, 'rgba(255,255,255,0)');
        ctx.fillStyle = leftEdge; ctx.fillRect(0, 0, edge+bevel, H);

        const x0 = Math.round(W), x1 = Math.round(W - (edge+bevel));
        const rightEdge = ctx.createLinearGradient(x0,0,x1,0);
        rightEdge.addColorStop(0, rgba(hiRGB, hiA));
        rightEdge.addColorStop(0.5, rgba(baseRGB, coreA));
        rightEdge.addColorStop(1, 'rgba(255,255,255,0)');
        ctx.fillStyle = rightEdge; ctx.fillRect(W-(edge+bevel), 0, edge+bevel, H);

        rafId = requestAnimationFrame(drawFrame);
      }

      function start(){ cancelAnimationFrame(rafId); rafId = requestAnimationFrame(drawFrame); }

      window.addEventListener('resize', ()=>{ resize(); start(); }, {passive:true});
      if(document.fonts && document.fonts.ready){ document.fonts.ready.then(()=>{ resize(); start(); }); }
      resize(); start();

      // å°å¤–ï¼šå¥—ç”¨ Skin åƒæ•¸
      window.__applySkinCanvas = function(params){
        const next = Object.assign({ base:[92,136,255], hi:[255,255,255], period:2000, effects:{}, bg:null }, params||{});
        skin = next;
        // æœ¨ç´‹åœ–æ¨£åˆ‡æ›
        if(skin.effects && typeof skin.effects.wood === 'string'){
          if(woodKind !== skin.effects.wood){ buildWoodPattern(skin.effects.wood); }
        }else{ woodPattern = null; woodKind = null; }
        // æ˜Ÿé»é¸é …ï¼ˆç‰©ä»¶æˆ–å¸ƒæ—å‡å¯ï¼‰
        if(skin.effects && skin.effects.stars){
          starOpts = typeof skin.effects.stars==='object' ? skin.effects.stars : {};
          ensureStarsIfNeeded();
        }else{ stars=null; starOpts={}; }
      };
    })();

    /* ---------------- Skin ç®¡ç†ï¼ˆä¿ç•™ï¼šç¶“å…¸ + ç§‘æŠ€2/3/5 + æœ¨ç´‹ï¼šé»‘æª€/ç™½æ©¡ï¼‰ ---------------- */
    (function(){
      const skinSel = document.getElementById('skinSel');
      const skinTitle = document.getElementById('skinTitle');
      const skinDesc = document.getElementById('skinDesc');

      const SKINS = {
        classic:{
          label:'ç¶“å…¸é¢¨æ ¼', selectLabel:'å†·è—ç»ç’ƒ',
          css:{},
          canvas:{ base:[92,136,255], hi:[255,255,255], period:2000, effects:{ rainbow:false, scanline:false, stars:false, grid:false }, bg:null },
          desc:'LEDï¼šä¸‰å´ä¸€è‡´æ·±è—ï¼Œå³å´é¡åƒï¼Œ2s å‘¼å¸ã€‚'
        },
        s2:{ label:'ç§‘æŠ€æ„Ÿé¢¨æ ¼2', selectLabel:'ç§‘æŠ€æ„Ÿé¢¨æ ¼2', cssSkin:'ç§‘æŠ€æ„Ÿé¢¨æ ¼2',
             canvas:{ base:[160,220,255], hi:[255,255,255], period:2200, effects:{ rainbow:true, prism:{ beams:8, speed:0.0005, alpha:0.10, spread:0.85, hueShift:40 } }, bg:['#0b0f2a','#0a0e26','#070a18'] },
             desc:'å…¨æ¯ HUDï¼šå½©è™¹é«˜å…‰é‚Šï¼‹Holo Prism å…‰æŸï¼ˆä½å°æ¯”ï¼‰ã€2.2s å‘¼å¸ã€‚' },
        s3:{ label:'ç§‘æŠ€æ„Ÿé¢¨æ ¼3', selectLabel:'ç§‘æŠ€æ„Ÿé¢¨æ ¼3', cssSkin:'ç§‘æŠ€æ„Ÿé¢¨æ ¼3',
             canvas:{ base:[80,255,160], hi:[255,255,255], period:1200, effects:{ scanline:true, pulse:{ rings:3, thickness:6, strength:0.13, color:[80,255,160] } }, bg:['#07150f','#06130e','#041009'] },
             desc:'è³½åšæ ¼ç¶ è„ˆè¡ï¼šæƒæç·šï¼‹ç¶ è‰²è„ˆè¡æ“´æ•£åœˆï¼Œ1.2så‘¼å¸ã€‚' },
        s5:{ label:'ç§‘æŠ€æ„Ÿé¢¨æ ¼5', selectLabel:'ç§‘æŠ€æ„Ÿé¢¨æ ¼5', cssSkin:'ç§‘æŠ€æ„Ÿé¢¨æ ¼5',
             canvas:{ base:[150,120,255], hi:[255,255,255], period:2800, effects:{ stars:{ countScale:1.1, twinkle:0.85, drift:0.009, sizeMin:1.6, sizeMax:3.2, glow:2.0, brightness:1.2 } }, bg:['#0b0a20','#0a0820','#08071a'] },
             desc:'è—ç´«æ˜Ÿéš›éœ“è™¹ï¼šæ›´å¤§æ›´äº®çš„æ˜Ÿé»èˆ‡å…‰æšˆã€ç·©æ…¢æ¼‚ç§»ï¼Œ2.8s å‘¼å¸ã€‚' },
        w2:{ label:'æœ¨ç´‹ãƒ»é»‘æª€æ›œé‡‘', selectLabel:'æœ¨ç´‹ãƒ»é»‘æª€æ›œé‡‘', cssSkin:'æœ¨ç´‹-é»‘æª€æ›œé‡‘',
             canvas:{ base:[240,190,110], hi:[255,245,210], period:2400, effects:{ wood:'ebony', woodBoost:true, woodSheen:{alpha:0.08} }, bg:['#0b0806','#090705','#070504'] },
             desc:'é»‘æª€æ·±æ£•ï¼šåŠ å¼·æœ¨å­”/é«®çµ²ç´‹ï¼Œæ²¹æ½¤æŸ”å…‰é«˜å…‰ï¼›2.4sã€‚' },
        w4:{ label:'æœ¨ç´‹ãƒ»ç™½æ©¡åŒ—æ­', selectLabel:'æœ¨ç´‹ãƒ»ç™½æ©¡åŒ—æ­', cssSkin:'æœ¨ç´‹-ç™½æ©¡åŒ—æ­',
             canvas:{ base:[255,220,170], hi:[255,250,230], period:1900, effects:{ wood:'oak', woodBoost:true, woodSheen:{alpha:0.06} }, bg:['#322515','#261c10','#1b140b'] },
             desc:'ç™½æ©¡æ·ºæœ¨ï¼šç›´ç´‹ï¼‹ray fleckï¼ˆä½å°æ¯”ï¼‰ã€å„ªé›…æ²¹å…‰ï¼›1.9sã€‚' }
      };

      // åˆå§‹åŒ–ä¸‹æ‹‰ï¼šå…ˆä¿ç•™ç¶“å…¸ï¼Œå†è¿½åŠ ï¼ˆ2/3/5ã€é»‘æª€ã€ç™½æ©¡ï¼‰
      (function populate(){
        const existing = Array.from(skinSel.options).map(o=>o.textContent.trim());
        if(!existing.includes(SKINS.classic.selectLabel)){
          const opt = document.createElement('option'); opt.textContent = SKINS.classic.selectLabel; skinSel.appendChild(opt);
        }
        ['s2','s3','s5','w2','w4'].forEach(k=>{ const opt=document.createElement('option'); opt.textContent = SKINS[k].selectLabel; skinSel.appendChild(opt); });
      })();

      function applyClassic(){
        document.body.dataset.skin = 'ç¶“å…¸é¢¨æ ¼';
        window.__applySkinCanvas(SKINS.classic.canvas);
        skinTitle.textContent = SKINS.classic.label; skinDesc.textContent = SKINS.classic.desc;
      }
      function applySkinKey(key){
        const s = SKINS[key];
        document.body.dataset.skin = s.cssSkin || 'ç¶“å…¸é¢¨æ ¼';
        window.__applySkinCanvas(s.canvas);
        skinTitle.textContent = s.label; skinDesc.textContent = s.desc;
      }

      // äº‹ä»¶ï¼šåˆ‡æ› Skinï¼ˆä¸æ”¹ä»»ä½•åŠŸèƒ½éµä½ï¼‰
      skinSel.addEventListener('change',()=>{
        const val = skinSel.value.trim();
        if(val === SKINS.classic.selectLabel){ applyClassic(); return; }
        if(val === SKINS.s2.selectLabel) return applySkinKey('s2');
        if(val === SKINS.s3.selectLabel) return applySkinKey('s3');
        if(val === SKINS.s5.selectLabel) return applySkinKey('s5');
        if(val === SKINS.w2.selectLabel) return applySkinKey('w2');
        if(val === SKINS.w4.selectLabel) return applySkinKey('w4');
      }, {passive:true});

      // é è¨­å¥—ç”¨ç¶“å…¸
      applyClassic();
    })();
  </script>
</body>
</html>
